–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑
–ó–¥—Ä–∞–≤–µ–π! –ë–∏—Ö –∏—Å–∫–∞–ª –¥–∞ –º–∏ –ø–æ–º–æ–≥–Ω–µ—à –¥–∞ –¥–æ–≤—ä—Ä—à–∞ –µ–¥–∏–Ω –º–æ–π –ø—Ä–æ–µ–∫—Ç. –ö–∞—á–≤–∞–º —Ç –Ω–∞–π-–≤–∞–∂–Ω–æ—Ç–æ –æ—Ç –Ω–µ–≥–æ –≤ –ù–µ–∫–∞ –¥–∞ —Ç–∏ –∫–∞–∂–∞ —Å –∫–∞–∫–≤–æ —Ä–∞–∑–ø–æ–ª–∞–≥–∞–º –∞–∑.  –†–∞–∑–ø–æ–ª–∞–≥–∞–º —Å Windows 10 –Ω–∞ –∫–æ–π—Ç–æ –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω  XAMPP –≤ D:\xampp —Å—ä—Å —Å–ª–µ–¥–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ - SQL —Å—ä—Ä–≤—ä—Ä
–°—ä—Ä–≤—ä—Ä: 127.0.0.1 via TCP/IP
–¢–∏–ø –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞: MariaDB
–í—Ä—ä–∑–∫–∞ —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞: SSL is not being used –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
–í–µ—Ä—Å–∏—è –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞: 10.4.32-MariaDB - mariadb.org binary distribution
–í–µ—Ä—Å–∏—è –Ω–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞: 10
–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª: root@localhost
–ó–Ω–∞–∫–æ–≤ –Ω–∞–±–æ—Ä (charset) –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞: UTF-8 Unicode (utf8mb4)
Web —Å—ä—Ä–≤—ä—Ä
Apache/2.4.58 (Win64) OpenSSL/3.1.3 PHP/8.2.12
–í–µ—Ä—Å–∏—è –Ω–∞ –ë–î –∫–ª–∏–µ–Ω—Ç: libmysql - mysqlnd 8.2.12.
PHP —Ä–∞–∑—à–∏—Ä–µ–Ω–∏–µ: mysqli –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è curl –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è mbstring –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
PHP –í–µ—Ä—Å–∏—è: 8.2.12
phpMyAdmin
–í–µ—Ä—Å–∏—è: 5.2.1
–ò–∑–ø–æ–ª–∑–≤–∞–º –∑–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä VSC –∫—ä–¥–µ—Ç–æ –ø–∏—à–∞ –∫–æ–¥. –ò–∑–ø–æ–ª–∑–≤–∞–º –∏ —Ç–æ–≤–∞ ... composer.json ...{
    "$schema": "https://getcomposer.org/schema.json",
    "name": "laravel/laravel",
    "type": "project",
    "description": "The skeleton application for the Laravel framework.",
    "keywords": ["laravel", "framework"],
    "license": "MIT",
    "require": {
        "php": "^8.2",
        "barryvdh/laravel-dompdf": "^3.1",
        "intervention/image": "^3.11",
        "jeroennoten/laravel-adminlte": "^3.15",
        "laravel/framework": "^12.0",
        "laravel/tinker": "^2.10.1",
        "maatwebsite/excel": "^3.1",
        "milon/barcode": "^12.0",
        "spatie/laravel-activitylog": "^4.10",
        "spatie/laravel-permission": "^6.23"
    },
    "require-dev": {
        "fakerphp/faker": "^1.23",
        "laravel/breeze": "^2.3",
        "laravel/pail": "^1.2.2",
        "laravel/pint": "^1.24",
        "laravel/sail": "^1.41",
        "mockery/mockery": "^1.6",
        "nunomaduro/collision": "^8.6",
        "pestphp/pest": "^3.8",
        "pestphp/pest-plugin-laravel": "^3.2"
    },
    "autoload": {
        "psr-4": {
            "App\\": "app/",
            "Database\\Factories\\": "database/factories/",
            "Database\\Seeders\\": "database/seeders/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Tests\\": "tests/"
        }
    },
    "scripts": {
        "setup": [
            "composer install",
            "@php -r \"file_exists('.env') || copy('.env.example', '.env');\"",
            "@php artisan key:generate",
            "@php artisan migrate --force",
            "npm install",
            "npm run build"
        ],
        "dev": [
            "Composer\\Config::disableProcessTimeout",
            "npx concurrently -c \"#93c5fd,#c4b5fd,#fb7185,#fdba74\" \"php artisan serve\" \"php artisan queue:listen --tries=1\" \"php artisan pail --timeout=0\" \"npm run dev\" --names=server,queue,logs,vite --kill-others"
        ],
        "test": [
            "@php artisan config:clear --ansi",
            "@php artisan test"
        ],
        "post-autoload-dump": [
            "Illuminate\\Foundation\\ComposerScripts::postAutoloadDump",
            "@php artisan package:discover --ansi"
        ],
        "post-update-cmd": [
            "@php artisan vendor:publish --tag=laravel-assets --ansi --force"
        ],
        "post-root-package-install": [
            "@php -r \"file_exists('.env') || copy('.env.example', '.env');\""
        ],
        "post-create-project-cmd": [
            "@php artisan key:generate --ansi",
            "@php -r \"file_exists('database/database.sqlite') || touch('database/database.sqlite');\"",
            "@php artisan migrate --graceful --ansi"
        ],
        "pre-package-uninstall": [
            "Illuminate\\Foundation\\ComposerScripts::prePackageUninstall"
        ]
    },
    "extra": {
        "laravel": {
            "dont-discover": []
        }
    },
    "config": {
        "optimize-autoloader": true,
        "preferred-install": "dist",
        "sort-packages": true,
        "allow-plugins": {
            "pestphp/pest-plugin": true,
            "php-http/discovery": true
        }
    },
    "minimum-stability": "stable",
    "prefer-stable": true
}
.... package.json ... {
    "$schema": "https://www.schemastore.org/package.json",
    "private": true,
    "type": "module",
    "scripts": {
        "build": "vite build",
        "dev": "vite"
    },
    "devDependencies": {
        "@tailwindcss/forms": "^0.5.2",
        "@tailwindcss/vite": "^4.0.0",
        "alpinejs": "^3.4.2",
        "autoprefixer": "^10.4.2",
        "axios": "^1.11.0",
        "concurrently": "^9.0.1",
        "laravel-vite-plugin": "^2.0.0",
        "postcss": "^8.4.31",
        "tailwindcss": "^3.1.0",
        "vite": "^7.0.7"
    }
}
.... –©–µ —Ç–∏ –ø–æ–¥–∞–º –∏ –Ω–∞–π-–≤–∞–∂–Ω–∏—Ç–µ —Ñ–∞–π–ª–æ–≤–µ –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞ –º–∏ –Ω–∞ –Ω—è–∫–æ–ª–∫–æ —á–∞—Å—Ç–∏. –ú–æ–ª—è –ø—Ä–æ—Å—Ç–æ –º–∏ –∫–∞–∑–≤–∞–π ...–î–∞–π —Å–ª–µ–¥–≤–∞—â–∞—Ç–∞ —á–∞—Å—Ç... –î–∞–∫–∞—Ç–æ –∞–∑ –Ω–µ –∫–∞–∂–∞ —á–µ —Ç–æ–≤–∞ –µ –ø–æ—Å–ª–µ–¥–Ω–∞—Ç–∞ —á–∞—Å—Ç –∫–æ—è—Ç–æ —Ç–∏ –ø–æ–∫–∞–∑–≤–∞–º.
–ó–¥—Ä–∞–≤–µ–π! –†–∞–∑–±–∏—Ä–∞ —Å–µ, —Å —É–¥–æ–≤–æ–ª—Å—Ç–≤–∏–µ —â–µ —Ç–∏ –ø–æ–º–æ–≥–Ω–∞ –¥–∞ –¥–æ–≤—ä—Ä—à–∏—à –ø—Ä–æ–µ–∫—Ç–∞. –í–∏–∂–¥–∞–º, —á–µ –∏–∑–ø–æ–ª–∑–≤–∞—à Laravel —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–ª–µ–∑–Ω–∏ –ø–∞–∫–µ—Ç–∏ (AdminLTE, Spatie Permissions, DomPDF, Excel –∏ –¥—Ä.) –∏ –∏–º–∞—à XAMPP —Å MariaDB.

–†–∞–∑–±–∏—Ä–∞–º –ø–æ–¥—Ö–æ–¥–∞ - —â–µ —Ç–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—è—à —á–∞—Å—Ç–∏ –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞, –∞ –∞–∑ —â–µ —Ç–∏ –ø–æ–º–∞–≥–∞–º —Å –∞–Ω–∞–ª–∏–∑–∞, –ø—Ä–æ–±–ª–µ–º–∏ –∏ –¥–æ–≤—ä—Ä—à–≤–∞–Ω–µ—Ç–æ. –ö–æ–≥–∞—Ç–æ —Å–∏ –≥–æ—Ç–æ–≤, –∫–∞–∂–∏ "–î–∞–π —Å–ª–µ–¥–≤–∞—â–∞—Ç–∞ —á–∞—Å—Ç" –∏ —â–µ –∑–∞–ø–æ—á–Ω–µ–º.

–ó–∞ –Ω–∞—á–∞–ª–æ, –±–∏—Ö –∏—Å–∫–∞–ª –¥–∞ –∑–Ω–∞–º:

–ö–∞–∫—ä–≤ —Ç–∏–ø –ø—Ä–æ–µ–∫—Ç –µ —Ç–æ–≤–∞? (CRM, ERP, –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è, e-commerce, –∏–ª–∏ –Ω–µ—â–æ –¥—Ä—É–≥–æ?)

–ù–∞ –∫–∞–∫—ä–≤ –µ—Ç–∞–ø –µ –ø—Ä–æ–µ–∫—Ç–∞? (–ö–∞–∫–≤–æ –µ –¥–æ–≤—ä—Ä—à–µ–Ω–æ –∏ –∫–∞–∫–≤–æ –æ—Å—Ç–∞–≤–∞?)

–ò–º–∞ –ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏ –ø—Ä–æ–±–ª–µ–º–∏ –∏–ª–∏ –≥—Ä–µ—à–∫–∏, –∫–æ–∏—Ç–æ —Å–µ –ø–æ—è–≤—è–≤–∞—Ç?

–ú–æ–≥–∞ –¥–∞ —Ç–∏ –ø–æ–º–æ–≥–Ω–∞ —Å:

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ Laravel —Å XAMPP

–†–∞–±–æ—Ç–∞ —Å –±–∞–∑–∏ –¥–∞–Ω–Ω–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü—Ä–æ–±–ª–µ–º–∏ —Å –ø–∞–∫–µ—Ç–∏—Ç–µ –æ—Ç composer.json

–ö–æ–¥ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏, –º–æ–¥–µ–ª–∏, blade —à–∞–±–ª–æ–Ω–∏

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–∞ AdminLTE

–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ —Ä–æ–ª–∏ —Å—ä—Å Spatie

–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF/Excel –æ—Ç—á–µ—Ç–∏

–î–µ–±—ä–≥–≤–∞–Ω–µ –Ω–∞ –≥—Ä–µ—à–∫–∏

–ö–æ–≥–∞—Ç–æ —Å–∏ –≥–æ—Ç–æ–≤, –∑–∞–ø–æ—á–Ω–∏ —Å –ø—ä—Ä–≤–∞—Ç–∞ —á–∞—Å—Ç –æ—Ç –∫–æ–¥–∞ –∏–ª–∏ —Ñ–∞–π–ª–æ–≤–µ—Ç–µ, —Å –∫–æ–∏—Ç–æ –∏–º–∞—à –ø—Ä–æ–±–ª–µ–º–∏.

–í—Å—ä—â–Ω–æ—Å—Ç —â–µ —Ç–∏ –ø–æ–¥–∞–º —Ç–æ–≤–∞ https://github.com/gvalkov-72/autoservice ... –ù–∞–¥—è–≤–∞–º —Å–µ —á–µ –≤–∏–∂–¥–∞—à —Ü–µ —Ü–µ–ª–∏—è –ø—Ä–æ–µ–∫—Ç –∏ –º–æ–∂–µ—à –¥–∞ –ø—Ä–æ—á–µ—Ç–µ—à –∫–æ–¥–æ–≤–µ—Ç–µ –≤—ä–≤ —Ñ–∞–π–ª–æ–≤–µ—Ç–µ
–ó–¥—Ä–∞–≤–µ–π! –î–∞, –≤–∏–∂–¥–∞–º —Ü–µ–ª–∏—è –ø—Ä–æ–µ–∫—Ç –æ—Ç GitHub. –¢–æ–≤–∞ –µ Laravel –ø—Ä–æ–µ–∫—Ç –∑–∞ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏–∑ (autoservice). –©–µ –≥–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞–º –∏ —â–µ —Ç–∏ –¥–∞–º –ø–æ–¥—Ä–æ–±–µ–Ω –ø—Ä–µ–≥–ª–µ–¥ –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ç–∞ –∏ —Å—ä—Å—Ç–æ—è–Ω–∏–µ—Ç–æ –º—É.

---------------------------------------------

–¢–æ–∑–∏ –ø—Ä–æ–µ–∫—Ç —Å–ø–µ—Ü–∏–∞–ª–Ω–æ –≥–æ –∫–∞—á–∏—Ö –∑–∞ —Ç–µ–± –¥–∞ –º–æ–∂–µ—à –¥–∞ –≥–æ —Ä–∞–∑–≥–ª–µ–¥–∞—à –∞–Ω–∞–ª–∏–∑–∏—Ä–∞—à –∏ –∑–∞–ø–æ–º–Ω–∏—à, —Ç—ä–π –∫–∞—Ç–æ –Ω–µ–≥–æ —â–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –¥–æ–≤—ä—Ä—à–∏–º. –ò–Ω–∞—á–µ –∞–∑ —Å–∏ –∏–º–∞–º env –∫–æ–∏—Ç–æ –∏–∑–≥–ª–µ–∂–¥–∞ —Ç–∞–∫–∞ ...APP_NAME=Autoservice
APP_ENV=local
APP_KEY=base64:WwMX0sBMtzWo13LnKEHLMnSQowPTlMw5fA68BBUZTlc=
APP_DEBUG=true
APP_URL=http://localhost

APP_LOCALE=bg
APP_FALLBACK_LOCALE=bg
APP_FAKER_LOCALE=bg_BG
APP_TIMEZONE=Europe/Sofia

APP_MAINTENANCE_DRIVER=file
# APP_MAINTENANCE_STORE=database

# PHP_CLI_SERVER_WORKERS=4

BCRYPT_ROUNDS=12

LOG_CHANNEL=stack
LOG_STACK=single
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=debug

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=autoservice
DB_USERNAME=root
DB_PASSWORD=

SESSION_DRIVER=database
SESSION_LIFETIME=120
SESSION_ENCRYPT=false
SESSION_PATH=/
SESSION_DOMAIN=null

BROADCAST_CONNECTION=log
FILESYSTEM_DISK=local
QUEUE_CONNECTION=database

CACHE_STORE=database
# CACHE_PREFIX=

MEMCACHED_HOST=127.0.0.1

REDIS_CLIENT=phpredis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

MAIL_MAILER=log
MAIL_SCHEME=null
MAIL_HOST=127.0.0.1
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_FROM_ADDRESS="hello@example.com"
MAIL_FROM_NAME="${APP_NAME}"

AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=
AWS_USE_PATH_STYLE_ENDPOINT=false

VITE_APP_NAME="${APP_NAME}"
–û—Ç–ª–∏—á–Ω–æ! –ë–ª–∞–≥–æ–¥–∞—Ä—è, —á–µ —Å–ø–æ–¥–µ–ª–∏ .env —Ñ–∞–π–ª–∞. –¢–æ–π –∏–∑–≥–ª–µ–∂–¥–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω –∑–∞ XAMPP. –°–µ–≥–∞ –∏–º–∞–º –ø—ä–ª–Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∞ –∑–∞ –ø—Ä–æ–µ–∫—Ç–∞.

–ê–Ω–∞–ª–∏–∑ –Ω–∞ —Ç–µ–∫—É—â–æ—Ç–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ:

–í–∏–∂–¥–∞–º, —á–µ –∏–º–∞—à –≤—Å–∏—á–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞ —Ä–∞–±–æ—Ç–∞:

‚úÖ –ü—Ä–∞–≤–∏–ª–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω .env —Ñ–∞–π–ª

‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω–∏ autoservice (—Ç—Ä—è–±–≤–∞ –¥–∞ —è —Å—ä–∑–¥–∞–¥–µ—à –≤ phpMyAdmin)

‚úÖ –í—Å–∏—á–∫–∏ –ø–∞–∫–µ—Ç–∏ —Å–∞ –æ–ø–∏—Å–∞–Ω–∏ –≤ composer.json

‚úÖ –ü—Ä–æ–µ–∫—Ç—ä—Ç –∏–º–∞ –ø—ä–ª–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

üö® –ö—Ä–∏—Ç–∏—á–Ω–∏ –Ω–µ—â–∞ –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ:


create.blade.php
PHP 10.19KB
–ë–∏—Ö –∏—Å–∫–∞–ª –ø—Ä–∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–∞ –º–æ–∂–µ –¥–∞ —Å–µ –Ω–∞–º–∏—Ä–∞ —á—Ä–µ–∑ –∞—É—Ç–æ–∫–∞–º–ø–ª–∏–∏—Ç –∫–∞–∫—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞ —Ç–∞–∫–∞ –∏ —á—Ä–µ–∑ –Ω–æ–º–µ—Ä–∞ –Ω–∞ –∫–æ–ª–∞—Ç–∞. –ò —Å—ä—â–æ —Ç–∞–∫–∞ –∏—Å–∞–∫–∞–º —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞ –ø–æ–ø—ä–ª–≤–∞–Ω–µ –¥–∞ –µ –ø–æ –∫—Ä–∞—Å–∏–≤–∞ –∏ —Ü–≤–µ—Ç–Ω–∞. –ü—Ä–∏–∫–∞—á–∏–ª —Å—ä–º —Ç–∏ —Ñ–∞–π–ª–∞ –∫—ä–¥–µ—Ç–æ —Å–µ –Ω–∞–º–∏—Ä–∞ –≤—Å–∏—á–∫–æ —Ç–æ–≤–∞.
–í–∏–∂–¥–∞–º —Ñ–∞–π–ª–∞. –ò–º–∞ –Ω—è–∫–æ–ª–∫–æ –Ω–µ—â–∞ –∑–∞ –ø–æ–¥–æ–±—Ä–µ–Ω–∏–µ. –©–µ –Ω–∞–ø—Ä–∞–≤—è —Å–ª–µ–¥–Ω–∏—Ç–µ –ø—Ä–æ–º–µ–Ω–∏:

–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ autocomplete –∑–∞ –∫–ª–∏–µ–Ω—Ç–∏ —á—Ä–µ–∑ –Ω–æ–º–µ—Ä –Ω–∞ –∫–æ–ª–∞

–ü–æ–¥–æ–±—Ä—è–≤–∞–Ω–µ –Ω–∞ –≤–∏–∑—É–∞–ª–Ω–∏—è –¥–∏–∑–∞–π–Ω —Å —Ü–≤–µ—Ç–æ–≤–µ –∏ –ø–æ-–¥–æ–±—Ä–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è

–û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ JavaScript –∫–æ–¥–∞

–ï—Ç–æ –ø–æ–¥–æ–±—Ä–µ–Ω–∞—Ç–∞ –≤–µ—Ä—Å–∏—è:

blade
@extends('adminlte::page')

@section('title', '–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="text-primary"><i class="fas fa-file-invoice mr-2"></i>–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞</h1>
        <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left mr-1"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
@stop

@section('content')
    <div class="card border-primary">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-plus-circle mr-2"></i>–û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
        </div>
        <div class="card-body">
            <form action="{{ route('admin.work-orders.store') }}" method="POST" id="orderForm">
                @csrf
                
                {{-- –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --}}
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-primary">–ö–ª–∏–µ–Ω—Ç <span class="text-danger">*</span></label>
                            <select name="customer_id" id="customer_id" class="form-control select2" 
                                    data-placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ, –∏–º–µ–π–ª –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" required
                                    style="border-color: #4e73df;">
                                <option value=""></option>
                                @foreach($customers as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <small class="form-text text-muted">–ó–∞–ø–æ—á–Ω–µ—Ç–µ –¥–∞ –ø–∏—à–µ—Ç–µ –∑–∞ —Ç—ä—Ä—Å–µ–Ω–µ</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-primary">–ê–≤—Ç–æ–º–æ–±–∏–ª <span class="text-danger">*</span></label>
                            <select name="vehicle_id" id="vehicle_id" class="form-control select2" required
                                    data-placeholder="–ü—ä—Ä–≤–æ –∏–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç"
                                    style="border-color: #4e73df;">
                                <option value=""></option>
                            </select>
                            <div id="vehicleSearch" style="display: none;">
                                <input type="text" id="vehicle_search" class="form-control mt-2" 
                                       placeholder="–¢—ä—Ä—Å–µ–Ω–µ –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä..." 
                                       style="border-color: #36b9cc;">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-primary">–ú–µ—Ö–∞–Ω–∏–∫</label>
                            <select name="assigned_to" class="form-control select2" 
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($mechanics as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <small class="form-text text-muted">–ù–µ–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ</small>
                        </div>
                    </div>
                </div>

                {{-- –î–µ—Ç–∞–π–ª–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞ --}}
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="font-weight-bold text-primary">–°—Ç–∞—Ç—É—Å <span class="text-danger">*</span></label>
                            <select name="status" class="form-control" required
                                    style="border-color: #f6c23e;">
                                <option value="draft" class="text-secondary">üìù –ß–µ—Ä–Ω–æ–≤–∞</option>
                                <option value="open" class="text-info" selected>üîì –û—Ç–≤–æ—Ä–µ–Ω–∞</option>
                                <option value="in_progress" class="text-warning">‚öôÔ∏è –í –ø—Ä–æ–≥—Ä–µ—Å</option>
                                <option value="completed" class="text-success">‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω–∞</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="font-weight-bold text-primary">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞–Ω–µ</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" style="background-color: #e3eaef;">
                                        <i class="fas fa-calendar-alt"></i>
                                    </span>
                                </div>
                                <input type="datetime-local" name="received_at" class="form-control" 
                                       value="{{ now()->format('Y-m-d\TH:i') }}"
                                       style="border-color: #858796;">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="font-weight-bold text-primary">–ü—Ä–æ–±–µ–≥ –ø—Ä–∏ –ø—Ä–∏–µ–º–∞–Ω–µ (km)</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" style="background-color: #e3eaef;">
                                        <i class="fas fa-tachometer-alt"></i>
                                    </span>
                                </div>
                                <input type="number" name="km_on_receive" class="form-control" 
                                       min="0" placeholder="0"
                                       style="border-color: #858796;">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="font-weight-bold text-primary">–û—á–∞–∫–≤–∞–Ω–∞ –¥–∞—Ç–∞ –Ω–∞ –∑–∞–≤—ä—Ä—à–≤–∞–Ω–µ</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" style="background-color: #e3eaef;">
                                        <i class="fas fa-calendar-check"></i>
                                    </span>
                                </div>
                                <input type="date" name="estimated_completion" class="form-control" 
                                       style="border-color: #858796;">
                            </div>
                        </div>
                    </div>
                </div>

                {{-- –ë–µ–ª–µ–∂–∫–∏ --}}
                <div class="form-group mt-4">
                    <label class="font-weight-bold text-primary">
                        <i class="fas fa-sticky-note mr-1"></i>–ë–µ–ª–µ–∂–∫–∏
                    </label>
                    <textarea name="notes" class="form-control" rows="3" 
                              placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –±–µ–ª–µ–∂–∫–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞..."
                              style="border-color: #dddfeb; border-radius: 0.35rem;"></textarea>
                </div>

                {{-- –î–∏–Ω–∞–º–∏—á–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ --}}
                <div class="card mt-4 border-info">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-list-alt mr-2"></i>–ü–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ—Ä—ä—á–∫–∞—Ç–∞
                            <span class="badge badge-light ml-2" id="itemsCount">0 –ø–æ–∑–∏—Ü–∏–∏</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="itemsTable">
                                <thead class="bg-light">
                                    <tr>
                                        <th width="5%">‚Ññ</th>
                                        <th width="25%">–ü—Ä–æ–¥—É–∫—Ç (PLU)</th>
                                        <th width="25%">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        <th width="10%">–ö–æ–ª-–≤–æ</th>
                                        <th width="10%">–¶–µ–Ω–∞ –±–µ–∑ –î–î–°</th>
                                        <th width="10%">–î–î–° %</th>
                                        <th width="10%">–û–±—â–æ</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot class="bg-light">
                                    <tr>
                                        <td colspan="7" class="text-right font-weight-bold">–û–±—â–æ –ø–æ–∑–∏—Ü–∏–∏:</td>
                                        <td class="font-weight-bold" id="itemsCountFooter">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <button type="button" id="addRow" class="btn btn-success btn-sm mt-2">
                            <i class="fas fa-plus mr-1"></i> –î–æ–±–∞–≤–∏ –ø–æ–∑–∏—Ü–∏—è
                        </button>
                        <button type="button" id="addServiceRow" class="btn btn-outline-primary btn-sm mt-2">
                            <i class="fas fa-tools mr-1"></i> –î–æ–±–∞–≤–∏ —É—Å–ª—É–≥–∞
                        </button>
                    </div>
                </div>

                {{-- –°—É–º–∏ --}}
                <div class="row mt-4">
                    <div class="col-md-5 offset-md-7">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-calculator mr-2"></i>–û–±—â–æ —Å—É–º–∏</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <th class="text-right">–û–±—â–æ –±–µ–∑ –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-primary" id="totalWithoutVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">–î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-warning" id="totalVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr class="border-top">
                                        <th class="text-right h5">–û–±—â–æ —Å –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h3 font-weight-bold text-success" id="grandTotal">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                {{-- –ë—É—Ç–æ–Ω–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ --}}
                <div class="mt-4 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary btn-lg mr-2">
                        <i class="fas fa-save mr-2"></i> –ó–∞–ø–∞–∑–∏ –ø–æ—Ä—ä—á–∫–∞
                    </button>
                    <button type="submit" name="action" value="save_and_print" class="btn btn-outline-primary btn-lg mr-2">
                        <i class="fas fa-print mr-2"></i> –ó–∞–ø–∞–∑–∏ –∏ –æ—Ç–ø–µ—á–∞—Ç–∞–π
                    </button>
                    <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-times mr-2"></i> –û—Ç–∫–∞–∑
                    </a>
                </div>
            </form>
        </div>
    </div>
@stop

@push('css')
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    <style>
        .select2-container--bootstrap .select2-selection {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .select2-container--bootstrap .select2-selection:focus {
            border-color: #4e73df;
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(78, 115, 223, 0.05);
        }
        .card-header {
            border-radius: 0.35rem 0.35rem 0 0 !important;
        }
        .input-group-text {
            background-color: #f8f9fc;
            border: 1px solid #d1d3e2;
        }
        .badge {
            font-size: 0.8em;
            padding: 0.35em 0.65em;
        }
    </style>
@endpush

@push('js')
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/bg.js"></script>
    <script>
        $(function () {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2 —Å —Ç—ä—Ä—Å–µ–Ω–µ
            $('.select2').select2({
                theme: 'bootstrap',
                language: 'bg',
                width: '100%',
                allowClear: true
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∫–ª–∏–µ–Ω—Ç
            $('#customer_id').change(function () {
                let customerId = $(this).val();
                $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
                
                if (customerId) {
                    $.get("{{ url('admin/api/customer-vehicles') }}/" + customerId, function (data) {
                        let html = '<option value=""></option>';
                        if (data.length > 0) {
                            $.each(data, function (i, v) {
                                html += '<option value="' + v.id + '">' + v.plate + ' - ' + v.make + ' ' + v.model + ' (' + v.year + ')</option>';
                            });
                            $('#vehicleSearch').hide();
                        } else {
                            html = '<option value="">–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</option>';
                            $('#vehicleSearch').show();
                        }
                        $('#vehicle_id').html(html).prop('disabled', false).trigger('change');
                    }).fail(function() {
                        $('#vehicle_id').html('<option value="">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</option>').prop('disabled', false);
                    });
                } else {
                    $('#vehicle_id').html('<option value=""></option>').prop('disabled', true);
                    $('#vehicleSearch').hide();
                }
            });

            // –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä
            $('#vehicle_search').on('input', function() {
                let searchTerm = $(this).val();
                if (searchTerm.length >= 2) {
                    $.get("{{ url('admin/api/search-vehicles') }}", { 
                        search: searchTerm 
                    }, function(data) {
                        $('#vehicle_id').html('<option value=""></option>');
                        $.each(data, function(i, v) {
                            $('#vehicle_id').append(
                                '<option value="' + v.id + '">' + 
                                v.plate + ' - ' + v.make + ' ' + v.model + 
                                ' (' + v.customer.name + ')' +
                                '</option>'
                            );
                        });
                        $('#vehicle_id').prop('disabled', false);
                    });
                }
            });
        });

        let rowIdx = 0;

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø—Ä–µ—Å–º—è—Ç–∞–Ω–µ –Ω–∞ –ª–∏–Ω–∏—è
        function calcLine(row) {
            const qty   = parseFloat(row.find('.qty').val()) || 0;
            const price = parseFloat(row.find('.price').val()) || 0;
            const vat   = parseFloat(row.find('.vat').val()) || 0;
            const line  = qty * price;
            const vatAm = line * vat / 100;
            row.find('.lineTotal').text((line + vatAm).toFixed(2));
            calcTotals();
            updateItemsCount();
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø—Ä–µ—Å–º—è—Ç–∞–Ω–µ –Ω–∞ –æ–±—â–∏ —Å—É–º–∏
        function calcTotals() {
            let totalWithout = 0, totalVat = 0;
            $('#itemsTable tbody tr').each(function () {
                const qty   = parseFloat($(this).find('.qty').val()) || 0;
                const price = parseFloat($(this).find('.price').val()) || 0;
                const vat   = parseFloat($(this).find('.vat').val()) || 0;
                const line  = qty * price;
                totalWithout += line;
                totalVat     += line * vat / 100;
            });
            $('#totalWithoutVat').text(totalWithout.toFixed(2));
            $('#totalVat').text(totalVat.toFixed(2));
            $('#grandTotal').text((totalWithout + totalVat).toFixed(2));
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –±—Ä–æ—è –ø–æ–∑–∏—Ü–∏–∏
        function updateItemsCount() {
            const count = $('#itemsTable tbody tr').length;
            $('#itemsCount').text(count + ' –ø–æ–∑–∏—Ü–∏–∏');
            $('#itemsCountFooter').text(count);
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ —Ä–µ–¥ —Å –ø—Ä–æ–¥—É–∫—Ç
        function addRow(productType = 'product') {
            rowIdx++;
            const isService = productType === 'service';
            const productLabel = isService ? '–£—Å–ª—É–≥–∞' : '–ü—Ä–æ–¥—É–∫—Ç';
            const servicePlaceholder = isService ? '–ù–∞–ø—Ä–∏–º–µ—Ä: –†–µ–º–æ–Ω—Ç –Ω–∞ —Å–ø–∏—Ä–∞—á–∫–∏' : '–ò–∑–±–µ—Ä–µ—Ç–µ –ø—Ä–æ–¥—É–∫—Ç';
            
            const html = `
                <tr id="R${rowIdx}" class="${isService ? 'table-info' : ''}">
                    <td class="align-middle">${rowIdx}</td>
                    <td>
                        <select name="items[${rowIdx}][product_id]" class="form-control product-select" 
                                style="width:100%" data-type="${productType}">
                            <option value=""></option>
                            @if(isset($products) && $products->count())
                                @foreach($products as $p)
                                    <option value="{{ $p->id }}" 
                                            data-price="{{ $p->price }}" 
                                            data-vat="{{ $p->vat_percent }}"
                                            data-type="{{ $p->is_service ? 'service' : 'product' }}">
                                        {{ $p->sku }} - {{ $p->name }}
                                    </option>
                                @endforeach
                            @endif
                        </select>
                    </td>
                    <td>
                        <input type="text" name="items[${rowIdx}][description]" 
                               class="form-control" placeholder="${servicePlaceholder}" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][quantity]" 
                               class="form-control qty" min="0.01" step="0.01" value="1" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][unit_price]" 
                               class="form-control price" min="0.01" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][vat_percent]" 
                               class="form-control vat" min="0" max="100" step="0.01" value="20" required>
                    </td>
                    <td class="align-middle lineTotal font-weight-bold">0.00</td>
                    <td class="align-middle">
                        <button type="button" class="btn btn-sm btn-danger removeRow" title="–ü—Ä–µ–º–∞—Ö–Ω–∏">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            
            $('#itemsTable tbody').append(html);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2 –∑–∞ –Ω–æ–≤–∏—è —Ä–µ–¥
            $('#R' + rowIdx + ' .product-select').select2({
                theme: 'bootstrap',
                language: 'bg',
                placeholder: `–ò–∑–±–µ—Ä–µ—Ç–µ ${productLabel.toLowerCase()}`,
                allowClear: true
            });
            
            updateItemsCount();
        }

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ —Ä–µ–¥ —Å –ø—Ä–æ–¥—É–∫—Ç
        $('#addRow').click(function () {
            addRow('product');
        });

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ —Ä–µ–¥ —Å —É—Å–ª—É–≥–∞
        $('#addServiceRow').click(function () {
            addRow('service');
        });

        // –°–ª—É—à–∞—Ç–µ–ª–∏ –∑–∞ —Å—ä–±–∏—Ç–∏—è
        $(document)
            .on('click', '.removeRow', function () {
                $(this).closest('tr').remove();
                calcTotals();
                updateItemsCount();
            })
            .on('change keyup', '.qty, .price, .vat', function () {
                calcLine($(this).closest('tr'));
            })
            .on('change', '.product-select', function () {
                const option = $(this).find(':selected');
                const row = $(this).closest('tr');
                const price = option.data('price');
                const vat = option.data('vat');
                
                if (price) {
                    row.find('.price').val(price);
                }
                if (vat) {
                    row.find('.vat').val(vat);
                }
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ—Ç–æ
                if (option.text() && !row.find('input[name*="description"]').val()) {
                    row.find('input[name*="description"]').val(option.text().split(' - ')[1] || option.text());
                }
                
                calcLine(row);
                
                // –ü—Ä–æ–º—è–Ω–∞ –Ω–∞ —Ü–≤–µ—Ç–∞ –Ω–∞ —Ä–µ–¥–∞ –∑–∞ —É—Å–ª—É–≥–∏
                const type = option.data('type');
                if (type === 'service') {
                    row.removeClass('table-info').addClass('table-warning');
                } else if (type === 'product') {
                    row.removeClass('table-warning table-info');
                }
            });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –µ–¥–∏–Ω –ø—Ä–∞–∑–µ–Ω —Ä–µ–¥
        $(document).ready(function() {
            addRow('product');
        });
    </script>
@endpush
–û—Å–Ω–æ–≤–Ω–∏ –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è, –∫–æ–∏—Ç–æ –Ω–∞–ø—Ä–∞–≤–∏—Ö:

Autocomplete –∑–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∫–æ–ª–∏:

Select2 —Å —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –ø–æ –∏–º–µ, –∏–º–µ–π–ª –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω

–û—Ç–¥–µ–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–æ–ª–∏ –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä

–ë—ä–ª–≥–∞—Ä—Å–∫–∏ –µ–∑–∏–∫ –∑–∞ Select2

–ü–æ–¥–æ–±—Ä–µ–Ω –≤–∏–∑—É–∞–ª–µ–Ω –¥–∏–∑–∞–π–Ω:

–¶–≤–µ—Ç–Ω–∏ –∑–∞–≥–ª–∞–≤–∏—è –Ω–∞ —Å–µ–∫—Ü–∏–∏ (primary, info, success)

–ò–∫–æ–Ω–∏ –∑–∞ –ø–æ-–¥–æ–±—Ä–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

–ü–æ–¥—Ä–µ–¥–µ–Ω–∏ –≥—Ä—É–ø–∏ –æ—Ç –ø–æ–ª–µ—Ç–∞

–¶–≤–µ—Ç–Ω–∏ —Ä–∞–º–∫–∏ –∏ hover –µ—Ñ–µ–∫—Ç–∏

–ü–æ–¥–æ–±—Ä–µ–Ω–∞ —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏—è

–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç:

–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏ –∏ —É—Å–ª—É–≥–∏

–ë—Ä–æ—è—á –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏

–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ—Ç–æ –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç

–û—á–∞–∫–≤–∞–Ω–∞ –¥–∞—Ç–∞ –Ω–∞ –∑–∞–≤—ä—Ä—à–≤–∞–Ω–µ

–û–ø—Ü–∏–∏ –∑–∞ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –∏ –æ—Ç–ø–µ—á–∞—Ç–≤–∞–Ω–µ

–ü–æ–¥–æ–±—Ä–µ–Ω JavaScript:

–ü–æ-–¥–æ–±—Ä–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –Ω–∞ –∫–æ–¥–∞

–ì—Ä–µ—à–∫–∏ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—ä—Ä–≤–∏ —Ä–µ–¥

–ó–∞–±–µ–ª–µ–∂–∫–∞: –¢–æ–∑–∏ –∫–æ–¥ –∏–∑–ø–æ–ª–∑–≤–∞ API endpoint-–∏, –∫–æ–∏—Ç–æ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—Ç –≤ —Ç–≤–æ—è—Ç–∞ Laravel –∞–ø–ª–∏–∫–∞—Ü–∏—è. –ê–∫–æ –≥–∏ –Ω—è–º–∞—à, —Ç—Ä—è–±–≤–∞ –¥–∞ –≥–∏ —Å—ä–∑–¥–∞–¥–µ—à –≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞.

–ò—Å–∫–∞—à –ª–∏ –¥–∞ —Å—ä–∑–¥–∞–¥–µ–º –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏—Ç–µ API endpoint-–∏ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ –∑–∞ —Ç–æ–≤–∞?

–î–æ–±—Ä–µ, —Å–∞–º–æ —á–µ –∞–∑ –∏—Å–∫–∞–º –ê—É—Ç–æ–∫–æ–º–ø–ª–∏–∏—Ç–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏ —Ç–∞–∫–∞...–ö–∞—Ç–æ —Ç—ä—Ä—Å—è –∫–ª–∏–µ–Ω—Ç –∏ –≥–æ –Ω–∞–º–µ—Ä—è —Ç–æ–π –¥–∞ –ø–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –æ—Å—Ç–∞–Ω–∞–ª–∏ –ø–æ–ª–µ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –ê–∫–æ –æ–±–∞—á–µ —Ç—ä—Ä—Å—è –ø–æ –Ω–æ–º–µ—Ä –∏ –≥–æ –Ω–∞–º–µ—Ä—è —Ç–æ–π —Å—ä—â–æ –¥–∞ –ø–æ–ø—ä–ª–≤–∞ –≤—Å–∏—á–∫–∏ –æ—Å—Ç–∞–Ω–∞–ª–∏ –ø–æ–ª–µ—Ç–∞ —Å –¥–∞–Ω–Ω–∏—Ç–µ —Å –∫–æ–∏—Ç–æ –µ –æ–±–≤—ä—Ä–∑–∞–Ω.
–†–∞–∑–±–∏—Ä–∞–º! –ò—Å–∫–∞—à –¥–≤–∞ –Ω–∞—á–∏–Ω–∞ –∑–∞ —Ç—ä—Ä—Å–µ–Ω–µ, –∫–æ–∏—Ç–æ –¥–∞ –ø–æ–ø—ä–ª–≤–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞:

–¢—ä—Ä—Å–µ–Ω–µ –ø–æ –∫–ª–∏–µ–Ω—Ç ‚Üí –ø–æ–ø—ä–ª–≤–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ —Ç–æ–∑–∏ –∫–ª–∏–µ–Ω—Ç

–¢—ä—Ä—Å–µ–Ω–µ –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä –Ω–∞ –∫–æ–ª–∞ ‚Üí –ø–æ–ø—ä–ª–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞ + –≤—Å–∏—á–∫–∏ –¥–µ—Ç–∞–π–ª–∏ –∑–∞ –∫–æ–ª–∞—Ç–∞

–ï—Ç–æ –ø—Ä–µ—Ä–∞–±–æ—Ç–µ–Ω–∞—Ç–∞ –≤–µ—Ä—Å–∏—è —Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–∞–Ω–æ autocomplete —Ç—ä—Ä—Å–µ–Ω–µ, –∫–æ–µ—Ç–æ —Ä–∞–±–æ—Ç–∏ –∏ –ø–æ –¥–≤–∞—Ç–∞ –Ω–∞—á–∏–Ω–∞:

blade
@extends('adminlte::page')

@section('title', '–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="text-primary"><i class="fas fa-file-invoice mr-2"></i>–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞</h1>
        <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left mr-1"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
@stop

@section('content')
    <div class="card border-primary">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-search mr-2"></i>–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ</h4>
        </div>
        <div class="card-body bg-light">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label class="font-weight-bold">–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª:</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-primary"></i>
                                </span>
                            </div>
                            <input type="text" id="globalSearch" class="form-control form-control-lg" 
                                   placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º–µ–π–ª –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä..."
                                   style="border-color: #4e73df;">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="searchResults" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto;">
                            <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —â–µ —Å–µ –ø–æ—è–≤—è—Ç —Ç—É–∫ -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <div class="alert alert-info w-100 mb-0">
                        <small>
                            <i class="fas fa-info-circle mr-1"></i>
                            –¢—ä—Ä—Å–µ—Ç–µ –ø–æ: <strong>–∏–º–µ</strong>, <strong>—Ç–µ–ª–µ—Ñ–æ–Ω</strong>, 
                            <strong>–∏–º–µ–π–ª</strong> –∏–ª–∏ <strong>—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä</strong>.
                            –ò–∑–±–µ—Ä–µ—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-success mt-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-user-circle mr-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</h4>
        </div>
        <div class="card-body">
            <form action="{{ route('admin.work-orders.store') }}" method="POST" id="orderForm">
                @csrf
                
                {{-- –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --}}
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ö–ª–∏–µ–Ω—Ç <span class="text-danger">*</span></label>
                            <select name="customer_id" id="customer_id" class="form-control select2" 
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç" required
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($customers as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <div id="customerInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-user text-success mr-1"></i>
                                    <span id="customerName"></span><br>
                                    <i class="fas fa-phone text-success mr-1"></i>
                                    <span id="customerPhone"></span><br>
                                    <i class="fas fa-envelope text-success mr-1"></i>
                                    <span id="customerEmail"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ê–≤—Ç–æ–º–æ–±–∏–ª <span class="text-danger">*</span></label>
                            <select name="vehicle_id" id="vehicle_id" class="form-control select2" required
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª"
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                            </select>
                            <div id="vehicleInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-car text-success mr-1"></i>
                                    <span id="vehicleMakeModel"></span><br>
                                    <i class="fas fa-hashtag text-success mr-1"></i>
                                    –†–µ–≥. –Ω–æ–º–µ—Ä: <span id="vehiclePlate"></span><br>
                                    <i class="fas fa-calendar text-success mr-1"></i>
                                    –ì–æ–¥–∏–Ω–∞: <span id="vehicleYear"></span><br>
                                    <i class="fas fa-gas-pump text-success mr-1"></i>
                                    –î–≤–∏–≥–∞—Ç–µ–ª: <span id="vehicleEngine"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ú–µ—Ö–∞–Ω–∏–∫</label>
                            <select name="assigned_to" class="form-control select2" 
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($mechanics as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <small class="form-text text-muted">–ù–µ–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ</small>
                        </div>
                    </div>
                </div>

                {{-- –î–µ—Ç–∞–π–ª–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞ --}}
                <div class="card border-warning mt-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0 text-dark"><i class="fas fa-clipboard-list mr-2"></i>–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–°—Ç–∞—Ç—É—Å <span class="text-danger">*</span></label>
                                    <select name="status" class="form-control" required
                                            style="border-color: #f6c23e;">
                                        <option value="draft" class="text-secondary">üìù –ß–µ—Ä–Ω–æ–≤–∞</option>
                                        <option value="open" class="text-info" selected>üîì –û—Ç–≤–æ—Ä–µ–Ω–∞</option>
                                        <option value="in_progress" class="text-warning">‚öôÔ∏è –í –ø—Ä–æ–≥—Ä–µ—Å</option>
                                        <option value="completed" class="text-success">‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω–∞</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞–Ω–µ</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="datetime-local" name="received_at" class="form-control" 
                                               value="{{ now()->format('Y-m-d\TH:i') }}"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–ü—Ä–æ–±–µ–≥ (km)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-tachometer-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="number" name="km_on_receive" class="form-control" 
                                               min="0" placeholder="0" id="vehicleMileage"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–û—á–∞–∫–≤–∞–Ω–∞ –¥–∞—Ç–∞</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-check text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="date" name="estimated_completion" class="form-control" 
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-2">
                            <label class="font-weight-bold text-dark">
                                <i class="fas fa-sticky-note mr-1"></i>–ë–µ–ª–µ–∂–∫–∏
                            </label>
                            <textarea name="notes" class="form-control" rows="2" 
                                      placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –±–µ–ª–µ–∂–∫–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞..."
                                      style="border-color: #dddfeb;"></textarea>
                        </div>
                    </div>
                </div>

                {{-- –î–∏–Ω–∞–º–∏—á–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ --}}
                <div class="card border-info mt-4">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-list-alt mr-2"></i>–ü–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ—Ä—ä—á–∫–∞—Ç–∞
                            <span class="badge badge-light ml-2" id="itemsCount">0 –ø–æ–∑–∏—Ü–∏–∏</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="itemsTable">
                                <thead class="bg-light">
                                    <tr>
                                        <th width="5%">‚Ññ</th>
                                        <th width="25%">–ü—Ä–æ–¥—É–∫—Ç/–£—Å–ª—É–≥–∞</th>
                                        <th width="25%">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        <th width="10%">–ö–æ–ª-–≤–æ</th>
                                        <th width="10%">–¶–µ–Ω–∞ –±–µ–∑ –î–î–°</th>
                                        <th width="10%">–î–î–° %</th>
                                        <th width="10%">–û–±—â–æ</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot class="bg-light">
                                    <tr>
                                        <td colspan="7" class="text-right font-weight-bold">–û–±—â–æ –ø–æ–∑–∏—Ü–∏–∏:</td>
                                        <td class="font-weight-bold" id="itemsCountFooter">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <button type="button" id="addRow" class="btn btn-success btn-sm">
                                <i class="fas fa-box mr-1"></i> –î–æ–±–∞–≤–∏ –ø—Ä–æ–¥—É–∫—Ç
                            </button>
                            <button type="button" id="addServiceRow" class="btn btn-primary btn-sm">
                                <i class="fas fa-tools mr-1"></i> –î–æ–±–∞–≤–∏ —É—Å–ª—É–≥–∞
                            </button>
                            <button type="button" id="addQuickService" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-bolt mr-1"></i> –ë—ä—Ä–∑–∞ —É—Å–ª—É–≥–∞
                            </button>
                        </div>
                    </div>
                </div>

                {{-- –°—É–º–∏ --}}
                <div class="row mt-4">
                    <div class="col-md-5 offset-md-7">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-calculator mr-2"></i>–û–±—â–æ —Å—É–º–∏</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <th class="text-right">–û–±—â–æ –±–µ–∑ –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-primary" id="totalWithoutVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">–î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-warning" id="totalVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr class="border-top">
                                        <th class="text-right h5">–û–±—â–æ —Å –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h3 font-weight-bold text-success" id="grandTotal">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                {{-- –ë—É—Ç–æ–Ω–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ --}}
                <div class="mt-4 d-flex justify-content-end gap-3">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save mr-2"></i> –ó–∞–ø–∞–∑–∏ –ø–æ—Ä—ä—á–∫–∞
                    </button>
                    <button type="submit" name="action" value="save_and_print" class="btn btn-primary btn-lg">
                        <i class="fas fa-print mr-2"></i> –ó–∞–ø–∞–∑–∏ –∏ –æ—Ç–ø–µ—á–∞—Ç–∞–π
                    </button>
                    <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-times mr-2"></i> –û—Ç–∫–∞–∑
                    </a>
                </div>
            </form>
        </div>
    </div>
@stop

@push('css')
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    <style>
        .select2-container--bootstrap .select2-selection {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .select2-container--bootstrap .select2-selection:focus {
            border-color: #1cc88a;
            box-shadow: 0 0 0 0.2rem rgba(28, 200, 138, 0.25);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(28, 200, 138, 0.05);
        }
        .card-header {
            border-radius: 0.35rem 0.35rem 0 0 !important;
        }
        .input-group-text {
            background-color: #f8f9fc;
            border: 1px solid #d1d3e2;
        }
        .badge {
            font-size: 0.8em;
            padding: 0.35em 0.65em;
        }
        .list-group-item:hover {
            background-color: #1cc88a !important;
            color: white !important;
            cursor: pointer;
        }
        .list-group-item .customer-badge {
            font-size: 0.75em;
        }
        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        #customerInfo, #vehicleInfo {
            border-left: 4px solid #1cc88a;
        }
    </style>
@endpush

@push('js')
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/bg.js"></script>
    <script>
        $(function () {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $('.select2').select2({
                theme: 'bootstrap',
                language: 'bg',
                width: '100%',
                allowClear: true
            });

            // –ì–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
            let searchTimeout;
            $('#globalSearch').on('input', function() {
                clearTimeout(searchTimeout);
                const query = $(this).val().trim();
                
                if (query.length < 2) {
                    $('#searchResults').hide().empty();
                    return;
                }
                
                searchTimeout = setTimeout(function() {
                    performGlobalSearch(query);
                }, 300);
            });

            // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#clearSearch').click(function() {
                $('#globalSearch').val('');
                $('#searchResults').hide().empty();
            });

            // –ó–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –ø—Ä–∏ –∫–ª–∏–∫ –∏–∑–≤—ä–Ω —Ç—è—Ö
            $(document).click(function(e) {
                if (!$(e.target).closest('#globalSearch, #searchResults').length) {
                    $('#searchResults').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∫–ª–∏–µ–Ω—Ç
            $('#customer_id').change(function () {
                const customerId = $(this).val();
                loadCustomerVehicles(customerId);
                
                // –ê–∫–æ –∏–º–∞ –∏–∑–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç, –ø–æ–∫–∞–∂–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –º—É
                if (customerId) {
                    loadCustomerInfo(customerId);
                } else {
                    $('#customerInfo').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
            $('#vehicle_id').change(function () {
                const vehicleId = $(this).val();
                if (vehicleId) {
                    loadVehicleInfo(vehicleId);
                } else {
                    $('#vehicleInfo').hide();
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –≥–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
        function performGlobalSearch(query) {
            $.ajax({
                url: "{{ route('admin.work-orders.search') }}",
                method: 'GET',
                data: { q: query },
                beforeSend: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border spinner-border-sm text-primary mr-2"></div>
                                <span>–¢—ä—Ä—Å–µ–Ω–µ...</span>
                            </div>
                        </div>
                    `).show();
                },
                success: function(data) {
                    if (data.results.length === 0) {
                        $('#searchResults').html(`
                            <div class="list-group-item text-muted">
                                <i class="fas fa-search mr-2"></i>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
                            </div>
                        `).show();
                        return;
                    }

                    let html = '';
                    
                    // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
                    if (data.customers && data.customers.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ö–ª–∏–µ–Ω—Ç–∏</div>`;
                        data.customers.forEach(customer => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="customer" 
                                     data-id="${customer.id}"
                                     data-name="${customer.name}"
                                     data-phone="${customer.phone || ''}"
                                     data-email="${customer.email || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-user text-primary mr-2"></i>
                                            <strong>${highlightText(customer.name, query)}</strong>
                                        </div>
                                        <span class="badge badge-primary customer-badge">–ö–ª–∏–µ–Ω—Ç</span>
                                    </div>
                                    ${customer.phone ? `<small class="text-muted d-block mt-1"><i class="fas fa-phone mr-1"></i>${highlightText(customer.phone, query)}</small>` : ''}
                                    ${customer.email ? `<small class="text-muted d-block"><i class="fas fa-envelope mr-1"></i>${highlightText(customer.email, query)}</small>` : ''}
                                    <small class="text-muted d-block">${customer.vehicles_count || 0} –∞–≤—Ç–æ–º–æ–±–∏–ª–∞</small>
                                </div>
                            `;
                        });
                    }

                    if (data.vehicles && data.vehicles.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>`;
                        data.vehicles.forEach(vehicle => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="vehicle" 
                                     data-id="${vehicle.id}"
                                     data-customer-id="${vehicle.customer_id}"
                                     data-plate="${vehicle.plate}"
                                     data-make="${vehicle.make || ''}"
                                     data-model="${vehicle.model || ''}"
                                     data-year="${vehicle.year || ''}"
                                     data-engine="${vehicle.engine || ''}"
                                     data-mileage="${vehicle.current_mileage || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-car text-success mr-2"></i>
                                            <strong>${highlightText(vehicle.plate, query)}</strong>
                                        </div>
                                        <span class="badge badge-success customer-badge">–ê–≤—Ç–æ–º–æ–±–∏–ª</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        ${vehicle.make || ''} ${vehicle.model || ''} ${vehicle.year ? `(${vehicle.year})` : ''}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-user mr-1"></i>${vehicle.customer?.name || '–ù—è–º–∞ –∫–ª–∏–µ–Ω—Ç'}
                                    </small>
                                </div>
                            `;
                        });
                    }

                    $('#searchResults').html(html).show();
                    
                    // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ event listener –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç
                    $('.list-group-item[data-type]').click(function() {
                        selectSearchResult($(this));
                    });
                },
                error: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item text-danger">
                            <i class="fas fa-exclamation-circle mr-2"></i>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
                        </div>
                    `).show();
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ—Å–≤–µ—Ç—è–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ
        function highlightText(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.toString().replace(regex, '<span class="search-highlight">$1</span>');
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –æ—Ç —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
        function selectSearchResult($element) {
            const type = $element.data('type');
            
            if (type === 'customer') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
                $('#customer_id').val($element.data('id')).trigger('change');
                $('#customerInfo').html(`
                    <small>
                        <i class="fas fa-user text-success mr-1"></i>
                        <strong>${$element.data('name')}</strong><br>
                        ${$element.data('phone') ? `<i class="fas fa-phone text-success mr-1"></i>${$element.data('phone')}<br>` : ''}
                        ${$element.data('email') ? `<i class="fas fa-envelope text-success mr-1"></i>${$element.data('email')}` : ''}
                    </small>
                `).show();
                
                // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                loadCustomerVehicles($element.data('id'));
                
            } else if (type === 'vehicle') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª –∏ –Ω–µ–≥–æ–≤–∏—è –∫–ª–∏–µ–Ω—Ç
                $('#vehicle_id').val($element.data('id')).trigger('change');
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∞
                $('#vehicleInfo').html(`
                    <small>
                        <i class="fas fa-car text-success mr-1"></i>
                        <strong>${$element.data('make')} ${$element.data('model')}</strong><br>
                        <i class="fas fa-hashtag text-success mr-1"></i>
                        –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${$element.data('plate')}</strong><br>
                        ${$element.data('year') ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${$element.data('year')}<br>` : ''}
                        ${$element.data('engine') ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${$element.data('engine')}<br>` : ''}
                        ${$element.data('mileage') ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${$element.data('mileage')} –∫–º` : ''}
                    </small>
                `).show();
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞
                if ($element.data('mileage')) {
                    $('#vehicleMileage').val($element.data('mileage'));
                }
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                if ($element.data('customerId')) {
                    $('#customer_id').val($element.data('customerId')).trigger('change');
                }
            }
            
            // –°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –∏ –∏–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#searchResults').hide().empty();
            $('#globalSearch').val('');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerVehicles(customerId) {
            if (!customerId) {
                $('#vehicle_id').html('<option value=""></option>').prop('disabled', true).trigger('change');
                return;
            }
            
            $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
            
            $.get("{{ url('admin/api/customer-vehicles') }}/" + customerId, function (data) {
                let html = '<option value=""></option>';
                if (data.length > 0) {
                    $.each(data, function (i, v) {
                        html += `<option value="${v.id}">${v.plate} - ${v.make} ${v.model} (${v.year || '?'})</option>`;
                    });
                } else {
                    html = '<option value="">–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</option>';
                }
                $('#vehicle_id').html(html).prop('disabled', false).trigger('change');
            }).fail(function() {
                $('#vehicle_id').html('<option value="">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</option>').prop('disabled', false);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerInfo(customerId) {
            $.get("{{ url('admin/api/customer-info') }}/" + customerId, function (data) {
                if (data) {
                    $('#customerInfo').html(`
                        <small>
                            <i class="fas fa-user text-success mr-1"></i>
                            <strong>${data.name}</strong><br>
                            ${data.phone ? `<i class="fas fa-phone text-success mr-1"></i>${data.phone}<br>` : ''}
                            ${data.email ? `<i class="fas fa-envelope text-success mr-1"></i>${data.email}<br>` : ''}
                            ${data.address ? `<i class="fas fa-map-marker-alt text-success mr-1"></i>${data.address}` : ''}
                        </small>
                    `).show();
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        function loadVehicleInfo(vehicleId) {
            $.get("{{ url('admin/api/vehicle-info') }}/" + vehicleId, function (data) {
                if (data) {
                    $('#vehicleInfo').html(`
                        <small>
                            <i class="fas fa-car text-success mr-1"></i>
                            <strong>${data.make} ${data.model}</strong><br>
                            <i class="fas fa-hashtag text-success mr-1"></i>
                            –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${data.plate}</strong><br>
                            ${data.year ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${data.year}<br>` : ''}
                            ${data.engine ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${data.engine}<br>` : ''}
                            ${data.vin ? `<i class="fas fa-barcode text-success mr-1"></i>VIN: ${data.vin}<br>` : ''}
                            ${data.current_mileage ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${data.current_mileage} –∫–º` : ''}
                        </small>
                    `).show();
                    
                    // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–∞
                    if (data.current_mileage) {
                        $('#vehicleMileage').val(data.current_mileage);
                    }
                }
            });
        }

        // =============== –§—É–Ω–∫—Ü–∏–∏ –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ ===============
        let rowIdx = 0;

        function calcLine(row) {
            const qty   = parseFloat(row.find('.qty').val()) || 0;
            const price = parseFloat(row.find('.price').val()) || 0;
            const vat   = parseFloat(row.find('.vat').val()) || 0;
            const line  = qty * price;
            const vatAm = line * vat / 100;
            row.find('.lineTotal').text((line + vatAm).toFixed(2));
            calcTotals();
            updateItemsCount();
        }

        function calcTotals() {
            let totalWithout = 0, totalVat = 0;
            $('#itemsTable tbody tr').each(function () {
                const qty   = parseFloat($(this).find('.qty').val()) || 0;
                const price = parseFloat($(this).find('.price').val()) || 0;
                const vat   = parseFloat($(this).find('.vat').val()) || 0;
                const line  = qty * price;
                totalWithout += line;
                totalVat     += line * vat / 100;
            });
            $('#totalWithoutVat').text(totalWithout.toFixed(2));
            $('#totalVat').text(totalVat.toFixed(2));
            $('#grandTotal').text((totalWithout + totalVat).toFixed(2));
        }

        function updateItemsCount() {
            const count = $('#itemsTable tbody tr').length;
            $('#itemsCount').text(count + ' –ø–æ–∑–∏—Ü–∏–∏');
            $('#itemsCountFooter').text(count);
        }

        function addRow(productType = 'product', predefinedProduct = null) {
            rowIdx++;
            const isService = productType === 'service';
            
            let productOptions = '<option value=""></option>';
            @if(isset($products) && $products->count())
                @foreach($products as $p)
                    @if($p->is_service == (productType === 'service'))
                        productOptions += `
                            <option value="{{ $p->id }}" 
                                    data-price="{{ $p->price }}" 
                                    data-vat="{{ $p->vat_percent }}"
                                    data-type="{{ $p->is_service ? 'service' : 'product' }}">
                                {{ $p->sku }} - {{ $p->name }}
                            </option>`;
                    @endif
                @endforeach
            @endif

            const html = `
                <tr id="R${rowIdx}" class="${isService ? 'table-info' : ''}">
                    <td class="align-middle">${rowIdx}</td>
                    <td>
                        <select name="items[${rowIdx}][product_id]" class="form-control product-select" 
                                style="width:100%" data-type="${productType}">
                            ${productOptions}
                        </select>
                    </td>
                    <td>
                        <input type="text" name="items[${rowIdx}][description]" 
                               class="form-control" placeholder="${isService ? '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞' : '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∞'}" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][quantity]" 
                               class="form-control qty" min="0.01" step="0.01" value="1" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][unit_price]" 
                               class="form-control price" min="0.01" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][vat_percent]" 
                               class="form-control vat" min="0" max="100" step="0.01" value="20" required>
                    </td>
                    <td class="align-middle lineTotal font-weight-bold">0.00</td>
                    <td class="align-middle">
                        <button type="button" class="btn btn-sm btn-danger removeRow" title="–ü—Ä–µ–º–∞—Ö–Ω–∏">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            
            $('#itemsTable tbody').append(html);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $(`#R${rowIdx} .product-select`).select2({
                theme: 'bootstrap',
                language: 'bg',
                placeholder: `–ò–∑–±–µ—Ä–µ—Ç–µ ${isService ? '—É—Å–ª—É–≥–∞' : '–ø—Ä–æ–¥—É–∫—Ç'}`,
                allowClear: true
            });
            
            // –ê–∫–æ –∏–º–∞ predefined –ø—Ä–æ–¥—É–∫—Ç, –∏–∑–±–µ—Ä–∏ –≥–æ
            if (predefinedProduct) {
                $(`#R${rowIdx} .product-select`).val(predefinedProduct.id).trigger('change');
                $(`#R${rowIdx} .price`).val(predefinedProduct.price);
                $(`#R${rowIdx} .vat`).val(predefinedProduct.vat_percent || 20);
                $(`#R${rowIdx} input[name*="description"]`).val(predefinedProduct.name);
                calcLine($(`#R${rowIdx}`));
            }
            
            updateItemsCount();
        }

        // Event Listeners –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
        $(document)
            .on('click', '#addRow', () => addRow('product'))
            .on('click', '#addServiceRow', () => addRow('service'))
            .on('click', '#addQuickService', () => {
                addRow('service', {
                    id: 'quick_service',
                    name: '–ë—ä—Ä–∑ —Ä–µ–º–æ–Ω—Ç',
                    price: 50,
                    vat_percent: 20
                });
            })
            .on('click', '.removeRow', function () {
                $(this).closest('tr').remove();
                calcTotals();
                updateItemsCount();
                renumberRows();
            })
            .on('change keyup', '.qty, .price, .vat', function () {
                calcLine($(this).closest('tr'));
            })
            .on('change', '.product-select', function () {
                const option = $(this).find(':selected');
                const row = $(this).closest('tr');
                const price = option.data('price');
                const vat = option.data('vat');
                
                if (price) row.find('.price').val(price);
                if (vat) row.find('.vat').val(vat);
                
                if (option.text() && !row.find('input[name*="description"]').val()) {
                    row.find('input[name*="description"]').val(option.text().split(' - ')[1] || option.text());
                }
                
                calcLine(row);
                const type = option.data('type');
                row.removeClass('table-info table-warning').addClass(type === 'service' ? 'table-warning' : '');
            });

        // –ü—Ä–µ–Ω–æ–º–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–¥–æ–≤–µ —Å–ª–µ–¥ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ
        function renumberRows() {
            $('#itemsTable tbody tr').each(function(index) {
                $(this).find('td:first').text(index + 1);
                $(this).attr('id', 'R' + (index + 1));
                // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –∏–º–µ–Ω–∞—Ç–∞ –Ω–∞ –ø–æ–ª–µ—Ç–∞—Ç–∞
                $(this).find('[name*="items"]').each(function() {
                    const name = $(this).attr('name');
                    $(this).attr('name', name.replace(/items\[\d+\]/, `items[${index + 1}]`));
                });
            });
            rowIdx = $('#itemsTable tbody tr').length;
        }

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—ä—Ä–≤–∏ —Ä–µ–¥ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        $(document).ready(function() {
            addRow('product');
        });
    </script>
@endpush
–û—Å–Ω–æ–≤–Ω–∏ –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è:

–ò–Ω—Ç–µ–≥—Ä–∏—Ä–∞–Ω–æ –≥–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ –≤ –≥–æ—Ä–Ω–∞—Ç–∞ —á–∞—Å—Ç –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞

–î–≤–∞ –Ω–∞—á–∏–Ω–∞ –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ:

–¢—ä—Ä—Å–µ–Ω–µ –ø–æ –∫–ª–∏–µ–Ω—Ç ‚Üí –ø–æ–ø—ä–ª–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞ + –Ω–µ–≥–æ–≤–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏

–¢—ä—Ä—Å–µ–Ω–µ –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä ‚Üí –ø–æ–ø—ä–ª–≤–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∞ + –∫–ª–∏–µ–Ω—Ç–∞ + –≤—Å–∏—á–∫–∏ –¥–µ—Ç–∞–π–ª–∏

API endpoints, –∫–æ–∏—Ç–æ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä–∑–¥–∞–¥–µ—à –≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞:

php
// –í WorkOrderController –∏–ª–∏ –æ—Ç–¥–µ–ª–µ–Ω API –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä
public function search(Request $request)
{
    $query = $request->get('q');
    
    $results = [
        'customers' => Customer::where('name', 'like', "%{$query}%")
            ->orWhere('phone', 'like', "%{$query}%")
            ->orWhere('email', 'like', "%{$query}%")
            ->withCount('vehicles')
            ->limit(10)
            ->get(),
            
        'vehicles' => Vehicle::where('plate', 'like', "%{$query}%")
            ->orWhere('vin', 'like', "%{$query}%")
            ->with('customer')
            ->limit(10)
            ->get()
    ];
    
    return response()->json($results);
}

public function customerInfo($id)
{
    $customer = Customer::findOrFail($id);
    return response()->json($customer);
}

public function vehicleInfo($id)
{
    $vehicle = Vehicle::findOrFail($id);
    return response()->json($vehicle);
}

public function customerVehicles($id)
{
    $vehicles = Vehicle::where('customer_id', $id)->get();
    return response()->json($vehicles);
}
–î–æ–±–∞–≤–µ–Ω–∏ –º–∞—Ä—à—Ä—É—Ç–∏ –≤ routes/web.php:

php
Route::get('admin/work-orders/search', [WorkOrderController::class, 'search'])
    ->name('admin.work-orders.search');
Route::get('admin/api/customer-info/{id}', [WorkOrderController::class, 'customerInfo']);
Route::get('admin/api/vehicle-info/{id}', [WorkOrderController::class, 'vehicleInfo']);
Route::get('admin/api/customer-vehicles/{id}', [WorkOrderController::class, 'customerVehicles']);
–¢–∞–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —â–µ –∏–º–∞:

–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ –≤ –≥–æ—Ä–Ω–∞—Ç–∞ —á–∞—Å—Ç

–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞

–¶–≤–µ—Ç–µ–Ω –∏ –∏–Ω—Ç—É–∏—Ç–∏–≤–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –∑–∞ –∫–ª–∏–µ–Ω—Ç –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª

–¢—Ä—è–±–≤–∞ –ª–∏ –¥–∞ —Å—ä–∑–¥–∞–¥–µ–º –∏ API –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ —Å —Ç–µ–∑–∏ –º–µ—Ç–æ–¥–∏?

–ï—Ç–æ –º–æ—è app\Http\Controllers\Admin\WorkOrderController.php ... <?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Customer;
use App\Models\User;
use App\Models\Vehicle;
use App\Models\WorkOrder;
use App\Models\WorkOrderItem;
use App\Models\StockMovement;
use Barryvdh\DomPDF\Facade\Pdf;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;   // <-- –¥–æ–±–∞–≤–µ–Ω–æ

class WorkOrderController extends Controller
{
    public function index()
    {
        $workOrders = WorkOrder::with(['customer', 'vehicle', 'mechanic'])->paginate(25);
        return view('admin.work-orders.index', compact('workOrders'));
    }

    public function create()
    {
        $customers = Customer::pluck('name', 'id');
        $vehicles  = collect();
        $mechanics = User::role('mechanic')->pluck('name', 'id');
        return view('admin.work-orders.create', compact('customers', 'vehicles', 'mechanics'));
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'customer_id'   => 'required|exists:customers,id',
            'vehicle_id'    => 'nullable|exists:vehicles,id',
            'status'        => 'required|in:draft,open,in_progress,completed,invoiced,closed,cancelled',
            'received_at'   => 'nullable|date',
            'km_on_receive' => 'nullable|integer|min:0',
            'assigned_to'   => 'nullable|exists:users,id',
            'notes'         => 'nullable|string',
            'items'         => 'required|array|min:1',
            'items.*.description' => 'required|string',
            'items.*.quantity'    => 'required|numeric|min:0.01',
            'items.*.unit_price'  => 'required|numeric|min:0',
            'items.*.vat_percent' => 'required|numeric|min:0|max:100',
        ]);

        $order = DB::transaction(function () use ($validated, $request) {
            $userId = Auth::check() ? Auth::user()->id : 0;

            $order = WorkOrder::create([
                'number'        => 'WO-' . str_pad(WorkOrder::count() + 1, 6, '0', STR_PAD_LEFT),
                'customer_id'   => $validated['customer_id'],
                'vehicle_id'    => $validated['vehicle_id'] ?? null,
                'status'        => $validated['status'],
                'received_at'   => $validated['received_at'] ?? now(),
                'km_on_receive' => $validated['km_on_receive'],
                'assigned_to'   => $validated['assigned_to'],
                'notes'         => $validated['notes'],
                'created_by'    => $userId,
            ]);

            $totalWithout = 0;
            foreach ($request->items as $row) {
                $qty   = $row['quantity'];
                $price = $row['unit_price'];
                $vat   = $row['vat_percent'];
                $line  = $qty * $price;
                $vatAm = $line * $vat / 100;

                WorkOrderItem::create([
                    'work_order_id'           => $order->id,
                    'product_id'              => $row['product_id'] ?: null,
                    'description'             => $row['description'],
                    'quantity'                => $qty,
                    'unit_price'              => $price,
                    'vat_percent'             => $vat,
                    'line_total_without_vat'  => $line,
                    'line_vat_amount'         => $vatAm,
                    'line_total'              => $line + $vatAm,
                ]);

                $totalWithout += $line;

                if ($row['product_id']) {
                    StockMovement::create([
                        'product_id'     => $row['product_id'],
                        'change'         => -$qty,
                        'type'           => 'reservation',
                        'reference_id'   => $order->id,
                        'reference_type' => WorkOrder::class,
                        'created_by'     => $userId,
                    ]);
                }
            }

            $order->update([
                'total_without_vat' => $totalWithout,
                'vat_amount'        => $order->items()->sum('line_vat_amount'),
                'total'             => $order->items()->sum('line_total'),
            ]);

            return $order;
        });

        return redirect()->route('admin.work-orders.show', $order)->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞.');
    }

    public function show(WorkOrder $workOrder)
    {
        $workOrder->load(['items.product', 'customer', 'vehicle', 'mechanic']);
        return view('admin.work-orders.show', compact('workOrder'));
    }

    public function edit(WorkOrder $workOrder)
    {
        $customers = Customer::pluck('name', 'id');
        $vehicles  = Vehicle::where('customer_id', $workOrder->customer_id)->pluck('plate', 'id');
        $mechanics = User::role('mechanic')->pluck('name', 'id');
        return view('admin.work-orders.edit', compact('workOrder', 'customers', 'vehicles', 'mechanics'));
    }

    public function update(Request $request, WorkOrder $workOrder)
    {
        $validated = $request->validate([
            'customer_id'   => 'required|exists:customers,id',
            'vehicle_id'    => 'nullable|exists:vehicles,id',
            'status'        => 'required|in:draft,open,in_progress,completed,invoiced,closed,cancelled',
            'received_at'   => 'nullable|date',
            'km_on_receive' => 'nullable|integer|min:0',
            'assigned_to'   => 'nullable|exists:users,id',
            'notes'         => 'nullable|string',
        ]);

        $workOrder->update($validated);

        return redirect()->route('admin.work-orders.index')->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞.');
    }

    public function destroy(WorkOrder $workOrder)
    {
        $workOrder->items()->delete();
        $workOrder->delete();
        return redirect()->route('admin.work-orders.index')->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞.');
    }

    public function pdf(\App\Models\WorkOrder $workOrder, Request $request)
    {
        $invoice = $workOrder->invoices()->first();
        if (! $invoice) {
            $userId = Auth::check() ? Auth::user()->id : 0;

            $invoice = \App\Models\Invoice::create([
                'number'        => 'INV-' . str_pad(\App\Models\Invoice::count() + 1, 6, '0', STR_PAD_LEFT),
                'work_order_id' => $workOrder->id,
                'customer_id'   => $workOrder->customer_id,
                'issue_date'    => now(),
                'due_date'      => now()->addDays(14),
                'subtotal'      => $workOrder->total_without_vat,
                'vat_total'     => $workOrder->vat_amount,
                'grand_total'   => $workOrder->total,
                'status'        => 'draft',
                'created_by'    => $userId,
            ]);

            foreach ($workOrder->items as $item) {
                $invoice->items()->create([
                    'product_id'  => $item->product_id,
                    'description' => $item->description,
                    'quantity'    => $item->quantity,
                    'unit_price'  => $item->unit_price,
                    'vat_percent' => $item->vat_percent,
                    'line_total'  => $item->line_total,
                ]);
            }
        }

        $copy = $request->get('copy', 0);
        return Pdf::loadView('admin.invoices.pdf', compact('invoice', 'copy'))
                  ->stream('invoice_' . $invoice->number . '.pdf');
    }
}.... –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –≥–æ —Ç–∞–∫–∞ –∫–∞–∫—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞—à –∏ –ø–æ—Å–ª–µ –º–∏ –≥–æ –ø–æ–¥–∞–π —Ü–µ–ª–∏—è –≤–µ—á–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω . –°—ä—â–æ—Ç–æ –∏—Å–∫–∞–º –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏—à –∏ —Å routes\web.php ... <?php

use App\Http\Controllers\ProfileController;
use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
*/

Route::get('/', fn() => redirect()->route('login'));

Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware(['auth', 'verified'])->name('dashboard');

/* --------------------------------------------------------------------------
   –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å –ø—Ä–∞–≤–∞)
--------------------------------------------------------------------------*/
Route::middleware(['auth', 'verified'])->prefix('admin')->name('admin.')->group(function () {

    /* --- –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å–∞–º–æ admin) --- */
    Route::middleware(['can:admin'])->group(function () {
        Route::resource('users',       \App\Http\Controllers\Admin\UserController::class);
        Route::resource('roles',       \App\Http\Controllers\Admin\RoleController::class);
        Route::resource('permissions', \App\Http\Controllers\Admin\PermissionController::class);
    });

    /* --- –û–°–ù–û–í–ù–ò –ú–û–î–£–õ–ò --- */
    Route::resource('customers',   \App\Http\Controllers\Admin\CustomerController::class);
    Route::resource('vehicles',    \App\Http\Controllers\Admin\VehicleController::class);
    Route::resource('products',    \App\Http\Controllers\Admin\ProductController::class);
    Route::resource('work-orders', \App\Http\Controllers\Admin\WorkOrderController::class);
    Route::resource('invoices',    \App\Http\Controllers\Admin\InvoiceController::class);

    /* --- EXPORT-–∏ –∑–∞ Customer --- */
    Route::get('customers/{customer}/export/pdf', [\App\Http\Controllers\Admin\CustomerController::class, 'exportPdf'])
        ->name('customers.export.pdf');
    Route::get('customers/{customer}/export/excel', [\App\Http\Controllers\Admin\CustomerController::class, 'exportExcel'])
        ->name('customers.export.excel');
    Route::get('customers/{customer}/export/csv', [\App\Http\Controllers\Admin\CustomerController::class, 'exportCsv'])
        ->name('customers.export.csv');

    /* --- EXPORT-–∏ –∑–∞ Vehicle --- */
    Route::get('vehicles/{vehicle}/export/pdf', [\App\Http\Controllers\Admin\VehicleController::class, 'exportPdf'])->name('vehicles.export.pdf');
    Route::get('vehicles/{vehicle}/export/excel', [\App\Http\Controllers\Admin\VehicleController::class, 'exportExcel'])->name('vehicles.export.excel');
    Route::get('vehicles/{vehicle}/export/csv', [\App\Http\Controllers\Admin\VehicleController::class, 'exportCsv'])->name('vehicles.export.csv');

    /* --- –°–ö–õ–ê–î --- */
    Route::prefix('stock')->name('stock.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\StockController::class, 'index'])->name('index');
        Route::get('/create-purchase', [\App\Http\Controllers\Admin\StockController::class, 'createPurchase'])->name('create-purchase');
        Route::post('/store-purchase', [\App\Http\Controllers\Admin\StockController::class, 'storePurchase'])->name('store-purchase');
        Route::get('/create-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'createAdjustment'])->name('create-adjustment');
        Route::post('/store-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'storeAdjustment'])->name('store-adjustment');
    });

    /* --- –ü–õ–ê–©–ê–ù–ò–Ø --- */
    Route::prefix('payments')->name('payments.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\PaymentController::class, 'index'])->name('index');
        Route::get('/create', [\App\Http\Controllers\Admin\PaymentController::class, 'create'])->name('create');
        Route::post('/store', [\App\Http\Controllers\Admin\PaymentController::class, 'store'])->name('store');
        Route::get('/{payment}/pdf', [\App\Http\Controllers\Admin\PaymentController::class, 'pdf'])->name('pdf');
    });

    /* --- –ë–ê–†–ö–û–î / PLU --- */
    Route::get('barcode/{code}.png', function (string $code) {
        return response(\App\Support\BarcodeHelper::png($code))->header('Content-Type', 'image/png');
    })->name('barcode.png');

    Route::get('products/{product}/barcode', [\App\Http\Controllers\Admin\ProductController::class, 'barcode'])
        ->name('products.barcode');

    Route::get('api/product-by-sku/{sku}', function (string $sku) {
        return \App\Models\Product::where('sku', $sku)->first() ?? [];
    })->name('api.product-by-sku');

    /* --- AJAX --- */
    Route::get('api/customer-vehicles/{customer}', function (\App\Models\Customer $customer) {
        return $customer->vehicles()->select('id', 'plate', 'make', 'model')->get();
    })->name('api.customer-vehicles');

    /* --- PDF --- */
    Route::get('work-orders/{workOrder}/pdf', [\App\Http\Controllers\Admin\WorkOrderController::class, 'pdf'])
        ->name('work-orders.pdf');
});

require __DIR__ . '/auth.php';
–©–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–º WorkOrderController.php –∏ web.php –∑–∞ –¥–∞ –ø–æ–¥–¥—ä—Ä–∂–∞—Ç –Ω–æ–≤–æ—Ç–æ —Ç—ä—Ä—Å–µ–Ω–µ –∏ API endpoints. –ï—Ç–æ –æ–±–Ω–æ–≤–µ–Ω–∏—Ç–µ —Ñ–∞–π–ª–æ–≤–µ:

1. app\Http\Controllers\Admin\WorkOrderController.php (–æ–±–Ω–æ–≤–µ–Ω)
php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Customer;
use App\Models\User;
use App\Models\Vehicle;
use App\Models\WorkOrder;
use App\Models\WorkOrderItem;
use App\Models\StockMovement;
use App\Models\Product;
use Barryvdh\DomPDF\Facade\Pdf;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;

class WorkOrderController extends Controller
{
    public function index()
    {
        $workOrders = WorkOrder::with(['customer', 'vehicle', 'mechanic'])->paginate(25);
        return view('admin.work-orders.index', compact('workOrders'));
    }

    public function create()
    {
        $customers = Customer::pluck('name', 'id');
        $vehicles = collect();
        $mechanics = User::role('mechanic')->pluck('name', 'id');
        $products = Product::select('id', 'sku', 'name', 'price', 'vat_percent', 'is_service')
            ->orderBy('is_service')
            ->orderBy('name')
            ->get();
        
        return view('admin.work-orders.create', compact('customers', 'vehicles', 'mechanics', 'products'));
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'customer_id'   => 'required|exists:customers,id',
            'vehicle_id'    => 'nullable|exists:vehicles,id',
            'status'        => 'required|in:draft,open,in_progress,completed,invoiced,closed,cancelled',
            'received_at'   => 'nullable|date',
            'km_on_receive' => 'nullable|integer|min:0',
            'assigned_to'   => 'nullable|exists:users,id',
            'notes'         => 'nullable|string',
            'items'         => 'required|array|min:1',
            'items.*.description' => 'required|string',
            'items.*.quantity'    => 'required|numeric|min:0.01',
            'items.*.unit_price'  => 'required|numeric|min:0',
            'items.*.vat_percent' => 'required|numeric|min:0|max:100',
        ]);

        $order = DB::transaction(function () use ($validated, $request) {
            $userId = Auth::check() ? Auth::user()->id : 0;

            $order = WorkOrder::create([
                'number'        => 'WO-' . str_pad(WorkOrder::count() + 1, 6, '0', STR_PAD_LEFT),
                'customer_id'   => $validated['customer_id'],
                'vehicle_id'    => $validated['vehicle_id'] ?? null,
                'status'        => $validated['status'],
                'received_at'   => $validated['received_at'] ?? now(),
                'km_on_receive' => $validated['km_on_receive'],
                'assigned_to'   => $validated['assigned_to'],
                'notes'         => $validated['notes'],
                'created_by'    => $userId,
            ]);

            $totalWithout = 0;
            foreach ($request->items as $row) {
                $qty   = $row['quantity'];
                $price = $row['unit_price'];
                $vat   = $row['vat_percent'];
                $line  = $qty * $price;
                $vatAm = $line * $vat / 100;

                WorkOrderItem::create([
                    'work_order_id'           => $order->id,
                    'product_id'              => $row['product_id'] ?: null,
                    'description'             => $row['description'],
                    'quantity'                => $qty,
                    'unit_price'              => $price,
                    'vat_percent'             => $vat,
                    'line_total_without_vat'  => $line,
                    'line_vat_amount'         => $vatAm,
                    'line_total'              => $line + $vatAm,
                ]);

                $totalWithout += $line;

                if (isset($row['product_id']) && $row['product_id']) {
                    StockMovement::create([
                        'product_id'     => $row['product_id'],
                        'change'         => -$qty,
                        'type'           => 'reservation',
                        'reference_id'   => $order->id,
                        'reference_type' => WorkOrder::class,
                        'created_by'     => $userId,
                    ]);
                }
            }

            $order->update([
                'total_without_vat' => $totalWithout,
                'vat_amount'        => $order->items()->sum('line_vat_amount'),
                'total'             => $order->items()->sum('line_total'),
            ]);

            return $order;
        });

        return redirect()->route('admin.work-orders.show', $order)->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞.');
    }

    public function show(WorkOrder $workOrder)
    {
        $workOrder->load(['items.product', 'customer', 'vehicle', 'mechanic']);
        return view('admin.work-orders.show', compact('workOrder'));
    }

    public function edit(WorkOrder $workOrder)
    {
        $customers = Customer::pluck('name', 'id');
        $vehicles  = Vehicle::where('customer_id', $workOrder->customer_id)->pluck('plate', 'id');
        $mechanics = User::role('mechanic')->pluck('name', 'id');
        $products = Product::select('id', 'sku', 'name', 'price', 'vat_percent', 'is_service')
            ->orderBy('is_service')
            ->orderBy('name')
            ->get();
            
        return view('admin.work-orders.edit', compact('workOrder', 'customers', 'vehicles', 'mechanics', 'products'));
    }

    public function update(Request $request, WorkOrder $workOrder)
    {
        $validated = $request->validate([
            'customer_id'   => 'required|exists:customers,id',
            'vehicle_id'    => 'nullable|exists:vehicles,id',
            'status'        => 'required|in:draft,open,in_progress,completed,invoiced,closed,cancelled',
            'received_at'   => 'nullable|date',
            'km_on_receive' => 'nullable|integer|min:0',
            'assigned_to'   => 'nullable|exists:users,id',
            'notes'         => 'nullable|string',
        ]);

        $workOrder->update($validated);

        return redirect()->route('admin.work-orders.index')->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞.');
    }

    public function destroy(WorkOrder $workOrder)
    {
        $workOrder->items()->delete();
        $workOrder->delete();
        return redirect()->route('admin.work-orders.index')->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞.');
    }

    public function pdf(\App\Models\WorkOrder $workOrder, Request $request)
    {
        $invoice = $workOrder->invoices()->first();
        if (! $invoice) {
            $userId = Auth::check() ? Auth::user()->id : 0;

            $invoice = \App\Models\Invoice::create([
                'number'        => 'INV-' . str_pad(\App\Models\Invoice::count() + 1, 6, '0', STR_PAD_LEFT),
                'work_order_id' => $workOrder->id,
                'customer_id'   => $workOrder->customer_id,
                'issue_date'    => now(),
                'due_date'      => now()->addDays(14),
                'subtotal'      => $workOrder->total_without_vat,
                'vat_total'     => $workOrder->vat_amount,
                'grand_total'   => $workOrder->total,
                'status'        => 'draft',
                'created_by'    => $userId,
            ]);

            foreach ($workOrder->items as $item) {
                $invoice->items()->create([
                    'product_id'  => $item->product_id,
                    'description' => $item->description,
                    'quantity'    => $item->quantity,
                    'unit_price'  => $item->unit_price,
                    'vat_percent' => $item->vat_percent,
                    'line_total'  => $item->line_total,
                ]);
            }
        }

        $copy = $request->get('copy', 0);
        return Pdf::loadView('admin.invoices.pdf', compact('invoice', 'copy'))
                  ->stream('invoice_' . $invoice->number . '.pdf');
    }

    /**
     * –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ autocomplete
     */
    public function search(Request $request)
    {
        $query = $request->get('q');
        
        if (!$query || strlen($query) < 2) {
            return response()->json([
                'customers' => [],
                'vehicles' => []
            ]);
        }

        $results = [
            'customers' => Customer::where('name', 'like', "%{$query}%")
                ->orWhere('phone', 'like', "%{$query}%")
                ->orWhere('email', 'like', "%{$query}%")
                ->withCount('vehicles')
                ->limit(10)
                ->get()
                ->map(function ($customer) {
                    return [
                        'id' => $customer->id,
                        'name' => $customer->name,
                        'phone' => $customer->phone,
                        'email' => $customer->email,
                        'vehicles_count' => $customer->vehicles_count,
                        'address' => $customer->address,
                    ];
                }),
                
            'vehicles' => Vehicle::where('plate', 'like', "%{$query}%")
                ->orWhere('vin', 'like', "%{$query}%")
                ->orWhere('make', 'like', "%{$query}%")
                ->orWhere('model', 'like', "%{$query}%")
                ->with('customer')
                ->limit(10)
                ->get()
                ->map(function ($vehicle) {
                    return [
                        'id' => $vehicle->id,
                        'plate' => $vehicle->plate,
                        'make' => $vehicle->make,
                        'model' => $vehicle->model,
                        'year' => $vehicle->year,
                        'engine' => $vehicle->engine,
                        'vin' => $vehicle->vin,
                        'current_mileage' => $vehicle->current_mileage,
                        'customer_id' => $vehicle->customer_id,
                        'customer' => $vehicle->customer ? [
                            'id' => $vehicle->customer->id,
                            'name' => $vehicle->customer->name,
                            'phone' => $vehicle->customer->phone,
                            'email' => $vehicle->customer->email,
                        ] : null,
                    ];
                })
        ];
        
        return response()->json($results);
    }

    /**
     * –í—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
     */
    public function customerInfo($id)
    {
        $customer = Customer::findOrFail($id);
        return response()->json([
            'id' => $customer->id,
            'name' => $customer->name,
            'phone' => $customer->phone,
            'email' => $customer->email,
            'address' => $customer->address,
            'created_at' => $customer->created_at->format('d.m.Y'),
        ]);
    }

    /**
     * –í—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
     */
    public function vehicleInfo($id)
    {
        $vehicle = Vehicle::with('customer')->findOrFail($id);
        return response()->json([
            'id' => $vehicle->id,
            'plate' => $vehicle->plate,
            'make' => $vehicle->make,
            'model' => $vehicle->model,
            'year' => $vehicle->year,
            'engine' => $vehicle->engine,
            'vin' => $vehicle->vin,
            'color' => $vehicle->color,
            'current_mileage' => $vehicle->current_mileage,
            'customer_id' => $vehicle->customer_id,
            'customer' => $vehicle->customer ? [
                'id' => $vehicle->customer->id,
                'name' => $vehicle->customer->name,
                'phone' => $vehicle->customer->phone,
                'email' => $vehicle->customer->email,
            ] : null,
        ]);
    }

    /**
     * –í—Ä—ä—â–∞ –≤—Å–∏—á–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
     */
    public function customerVehicles($id)
    {
        $vehicles = Vehicle::where('customer_id', $id)
            ->get()
            ->map(function ($vehicle) {
                return [
                    'id' => $vehicle->id,
                    'plate' => $vehicle->plate,
                    'make' => $vehicle->make,
                    'model' => $vehicle->model,
                    'year' => $vehicle->year,
                    'engine' => $vehicle->engine,
                    'current_mileage' => $vehicle->current_mileage,
                    'full_text' => $vehicle->plate . ' - ' . $vehicle->make . ' ' . $vehicle->model . ($vehicle->year ? ' (' . $vehicle->year . ')' : ''),
                ];
            });
            
        return response()->json($vehicles);
    }

    /**
     * –í—Ä—ä—â–∞ –≤—Å–∏—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –∑–∞ autocomplete
     */
    public function productsAutocomplete(Request $request)
    {
        $query = $request->get('q');
        $type = $request->get('type', 'all'); // all, product, service
        
        $products = Product::query();
        
        if ($query) {
            $products->where(function ($q) use ($query) {
                $q->where('sku', 'like', "%{$query}%")
                  ->orWhere('name', 'like', "%{$query}%")
                  ->orWhere('description', 'like', "%{$query}%");
            });
        }
        
        if ($type === 'product') {
            $products->where('is_service', false);
        } elseif ($type === 'service') {
            $products->where('is_service', true);
        }
        
        $products = $products->select('id', 'sku', 'name', 'price', 'vat_percent', 'is_service')
            ->orderBy('is_service')
            ->orderBy('name')
            ->limit(20)
            ->get()
            ->map(function ($product) {
                return [
                    'id' => $product->id,
                    'sku' => $product->sku,
                    'name' => $product->name,
                    'price' => $product->price,
                    'vat_percent' => $product->vat_percent,
                    'is_service' => $product->is_service,
                    'full_text' => $product->sku . ' - ' . $product->name . ' (' . number_format($product->price, 2) . ' –ª–≤.)',
                ];
            });
            
        return response()->json($products);
    }
}
2. routes\web.php (–æ–±–Ω–æ–≤–µ–Ω)
php
<?php

use App\Http\Controllers\ProfileController;
use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
*/

Route::get('/', fn() => redirect()->route('login'));

Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware(['auth', 'verified'])->name('dashboard');

/* --------------------------------------------------------------------------
   –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å –ø—Ä–∞–≤–∞)
--------------------------------------------------------------------------*/
Route::middleware(['auth', 'verified'])->prefix('admin')->name('admin.')->group(function () {

    /* --- –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å–∞–º–æ admin) --- */
    Route::middleware(['can:admin'])->group(function () {
        Route::resource('users',       \App\Http\Controllers\Admin\UserController::class);
        Route::resource('roles',       \App\Http\Controllers\Admin\RoleController::class);
        Route::resource('permissions', \App\Http\Controllers\Admin\PermissionController::class);
    });

    /* --- –û–°–ù–û–í–ù–ò –ú–û–î–£–õ–ò --- */
    Route::resource('customers',   \App\Http\Controllers\Admin\CustomerController::class);
    Route::resource('vehicles',    \App\Http\Controllers\Admin\VehicleController::class);
    Route::resource('products',    \App\Http\Controllers\Admin\ProductController::class);
    Route::resource('work-orders', \App\Http\Controllers\Admin\WorkOrderController::class);
    Route::resource('invoices',    \App\Http\Controllers\Admin\InvoiceController::class);

    /* --- EXPORT-–∏ –∑–∞ Customer --- */
    Route::get('customers/{customer}/export/pdf', [\App\Http\Controllers\Admin\CustomerController::class, 'exportPdf'])
        ->name('customers.export.pdf');
    Route::get('customers/{customer}/export/excel', [\App\Http\Controllers\Admin\CustomerController::class, 'exportExcel'])
        ->name('customers.export.excel');
    Route::get('customers/{customer}/export/csv', [\App\Http\Controllers\Admin\CustomerController::class, 'exportCsv'])
        ->name('customers.export.csv');

    /* --- EXPORT-–∏ –∑–∞ Vehicle --- */
    Route::get('vehicles/{vehicle}/export/pdf', [\App\Http\Controllers\Admin\VehicleController::class, 'exportPdf'])->name('vehicles.export.pdf');
    Route::get('vehicles/{vehicle}/export/excel', [\App\Http\Controllers\Admin\VehicleController::class, 'exportExcel'])->name('vehicles.export.excel');
    Route::get('vehicles/{vehicle}/export/csv', [\App\Http\Controllers\Admin\VehicleController::class, 'exportCsv'])->name('vehicles.export.csv');

    /* --- –°–ö–õ–ê–î --- */
    Route::prefix('stock')->name('stock.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\StockController::class, 'index'])->name('index');
        Route::get('/create-purchase', [\App\Http\Controllers\Admin\StockController::class, 'createPurchase'])->name('create-purchase');
        Route::post('/store-purchase', [\App\Http\Controllers\Admin\StockController::class, 'storePurchase'])->name('store-purchase');
        Route::get('/create-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'createAdjustment'])->name('create-adjustment');
        Route::post('/store-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'storeAdjustment'])->name('store-adjustment');
    });

    /* --- –ü–õ–ê–©–ê–ù–ò–Ø --- */
    Route::prefix('payments')->name('payments.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\PaymentController::class, 'index'])->name('index');
        Route::get('/create', [\App\Http\Controllers\Admin\PaymentController::class, 'create'])->name('create');
        Route::post('/store', [\App\Http\Controllers\Admin\PaymentController::class, 'store'])->name('store');
        Route::get('/{payment}/pdf', [\App\Http\Controllers\Admin\PaymentController::class, 'pdf'])->name('pdf');
    });

    /* --- –ë–ê–†–ö–û–î / PLU --- */
    Route::get('barcode/{code}.png', function (string $code) {
        return response(\App\Support\BarcodeHelper::png($code))->header('Content-Type', 'image/png');
    })->name('barcode.png');

    Route::get('products/{product}/barcode', [\App\Http\Controllers\Admin\ProductController::class, 'barcode'])
        ->name('products.barcode');

    Route::get('api/product-by-sku/{sku}', function (string $sku) {
        return \App\Models\Product::where('sku', $sku)->first() ?? [];
    })->name('api.product-by-sku');

    /* --- AJAX API –∑–∞ Work Orders --- */
    Route::prefix('api')->group(function () {
        // –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ autocomplete
        Route::get('search/customer-vehicle', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
            ->name('api.search.customer-vehicle');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-info/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerInfo'])
            ->name('api.customer-info');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        Route::get('vehicle-info/{vehicle}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'vehicleInfo'])
            ->name('api.vehicle-info');
        
        // –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-vehicles/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerVehicles'])
            ->name('api.customer-vehicles');
        
        // Autocomplete –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏
        Route::get('products/autocomplete', [\App\Http\Controllers\Admin\WorkOrderController::class, 'productsAutocomplete'])
            ->name('api.products.autocomplete');
            
        // –°—Ç–∞—Ä–æ—Ç–æ endpoint –∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç
        Route::get('customer-vehicles/{customer}', function (\App\Models\Customer $customer) {
            return $customer->vehicles()->select('id', 'plate', 'make', 'model', 'year')->get();
        })->name('api.customer-vehicles.legacy');
    });

    /* --- PDF --- */
    Route::get('work-orders/{workOrder}/pdf', [\App\Http\Controllers\Admin\WorkOrderController::class, 'pdf'])
        ->name('work-orders.pdf');
        
    /* --- –¢—ä—Ä—Å–µ–Ω–µ –∑–∞ Work Orders (–∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç) --- */
    Route::get('work-orders/search', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
        ->name('work-orders.search');
});

require __DIR__ . '/auth.php';
3. –ù—É–∂–Ω–∏ –ø—Ä–æ–º–µ–Ω–∏ –≤ Blade —Ñ–∞–π–ª–∞ (create.blade.php)
–í create.blade.php —Ç—Ä—è–±–≤–∞ –¥–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞—à JavaScript —á–∞—Å—Ç—Ç–∞ —Å –Ω–æ–≤–∏—Ç–µ –ø—ä—Ç–∏—â–∞:

javascript
// –ó–∞–º–µ–Ω–µ—Ç–µ —Å—Ç–∞—Ä–∏—Ç–µ URL-–∏ —Å –Ω–æ–≤–∏—Ç–µ:

// –í–º–µ—Å—Ç–æ:
// $.get("{{ url('admin/api/customer-vehicles') }}/" + customerId, ...

// –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ:
$.get("{{ route('admin.api.customer-vehicles', '') }}/" + customerId, ...

// –í–º–µ—Å—Ç–æ:
// $.get("{{ url('admin/api/customer-info') }}/" + customerId, ...

// –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ:
$.get("{{ route('admin.api.customer-info', '') }}/" + customerId, ...

// –í–º–µ—Å—Ç–æ:
// $.get("{{ url('admin/api/vehicle-info') }}/" + vehicleId, ...

// –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ:
$.get("{{ route('admin.api.vehicle-info', '') }}/" + vehicleId, ...

// –í–º–µ—Å—Ç–æ:
// url: "{{ route('admin.work-orders.search') }}",

// –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ:
url: "{{ route('admin.api.search.customer-vehicle') }}",
4. –ü—Ä–æ–º–µ–Ω–∏ –≤ Blade —Ñ–∞–π–ª–∞ –∑–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏
–í –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ –≤–µ—á–µ –∏–∑–ø—Ä–∞—â–∞–º–µ $products –≤ create() –∏ edit() –º–µ—Ç–æ–¥–∏—Ç–µ. –£–≤–µ—Ä–∏ —Å–µ —á–µ –≤ create.blade.php –∏–∑–ø–æ–ª–∑–≤–∞—à –ø—Ä–∞–≤–∏–ª–Ω–∞—Ç–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞.

–û—Å–Ω–æ–≤–Ω–∏—Ç–µ –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è —Å–∞:

–ù–æ–≤–∏ API –º–µ—Ç–æ–¥–∏ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ –∑–∞ —Ç—ä—Ä—Å–µ–Ω–µ

–ü–æ–¥–æ–±—Ä–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∏—Ç–µ –≤ web.php

–û–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç —Å—ä—Å —Å—Ç–∞—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏

–ü–æ–¥—Ä–æ–±–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏

Autocomplete –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏ —Å—ä—â–æ

–°–µ–≥–∞ —Ç–≤–æ—è—Ç–∞ —Ñ–æ—Ä–º–∞ —â–µ –∏–º–∞ –ø—ä–ª–Ω–æ autocomplete —Ç—ä—Ä—Å–µ–Ω–µ, –∫–æ–µ—Ç–æ –ø–æ–ø—ä–ª–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!

–ü–æ–¥–∞–π –º–∏ —Ü–µ–ª–∏—è—Ç create.blade.php –∞ –Ω–µ —Å–∞–º–æ –ø—Ä–æ–º–µ–Ω–µ–Ω–∏—Ç–µ —á–∞—Å—Ç–∏
–ï—Ç–æ –ø—ä–ª–Ω–∏—è create.blade.php —Ñ–∞–π–ª —Å –≤—Å–∏—á–∫–∏ –ø—Ä–æ–º–µ–Ω–∏:

blade
@extends('adminlte::page')

@section('title', '–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="text-primary"><i class="fas fa-file-invoice mr-2"></i>–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞</h1>
        <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left mr-1"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
@stop

@section('content')
    <div class="card border-primary">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-search mr-2"></i>–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ</h4>
        </div>
        <div class="card-body bg-light">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label class="font-weight-bold">–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª:</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-primary"></i>
                                </span>
                            </div>
                            <input type="text" id="globalSearch" class="form-control form-control-lg" 
                                   placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º–µ–π–ª –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä..."
                                   style="border-color: #4e73df;">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="searchResults" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto;">
                            <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —â–µ —Å–µ –ø–æ—è–≤—è—Ç —Ç—É–∫ -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <div class="alert alert-info w-100 mb-0">
                        <small>
                            <i class="fas fa-info-circle mr-1"></i>
                            –¢—ä—Ä—Å–µ—Ç–µ –ø–æ: <strong>–∏–º–µ</strong>, <strong>—Ç–µ–ª–µ—Ñ–æ–Ω</strong>, 
                            <strong>–∏–º–µ–π–ª</strong> –∏–ª–∏ <strong>—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä</strong>.
                            –ò–∑–±–µ—Ä–µ—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-success mt-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-user-circle mr-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</h4>
        </div>
        <div class="card-body">
            <form action="{{ route('admin.work-orders.store') }}" method="POST" id="orderForm">
                @csrf
                
                {{-- –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --}}
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ö–ª–∏–µ–Ω—Ç <span class="text-danger">*</span></label>
                            <select name="customer_id" id="customer_id" class="form-control select2" 
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç" required
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($customers as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <div id="customerInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-user text-success mr-1"></i>
                                    <span id="customerName"></span><br>
                                    <i class="fas fa-phone text-success mr-1"></i>
                                    <span id="customerPhone"></span><br>
                                    <i class="fas fa-envelope text-success mr-1"></i>
                                    <span id="customerEmail"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ê–≤—Ç–æ–º–æ–±–∏–ª <span class="text-danger">*</span></label>
                            <select name="vehicle_id" id="vehicle_id" class="form-control select2" required
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª"
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                            </select>
                            <div id="vehicleInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-car text-success mr-1"></i>
                                    <span id="vehicleMakeModel"></span><br>
                                    <i class="fas fa-hashtag text-success mr-1"></i>
                                    –†–µ–≥. –Ω–æ–º–µ—Ä: <span id="vehiclePlate"></span><br>
                                    <i class="fas fa-calendar text-success mr-1"></i>
                                    –ì–æ–¥–∏–Ω–∞: <span id="vehicleYear"></span><br>
                                    <i class="fas fa-gas-pump text-success mr-1"></i>
                                    –î–≤–∏–≥–∞—Ç–µ–ª: <span id="vehicleEngine"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ú–µ—Ö–∞–Ω–∏–∫</label>
                            <select name="assigned_to" class="form-control select2" 
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($mechanics as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <small class="form-text text-muted">–ù–µ–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ</small>
                        </div>
                    </div>
                </div>

                {{-- –î–µ—Ç–∞–π–ª–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞ --}}
                <div class="card border-warning mt-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0 text-dark"><i class="fas fa-clipboard-list mr-2"></i>–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–°—Ç–∞—Ç—É—Å <span class="text-danger">*</span></label>
                                    <select name="status" class="form-control" required
                                            style="border-color: #f6c23e;">
                                        <option value="draft" class="text-secondary">üìù –ß–µ—Ä–Ω–æ–≤–∞</option>
                                        <option value="open" class="text-info" selected>üîì –û—Ç–≤–æ—Ä–µ–Ω–∞</option>
                                        <option value="in_progress" class="text-warning">‚öôÔ∏è –í –ø—Ä–æ–≥—Ä–µ—Å</option>
                                        <option value="completed" class="text-success">‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω–∞</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞–Ω–µ</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="datetime-local" name="received_at" class="form-control" 
                                               value="{{ now()->format('Y-m-d\TH:i') }}"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–ü—Ä–æ–±–µ–≥ (km)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-tachometer-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="number" name="km_on_receive" class="form-control" 
                                               min="0" placeholder="0" id="vehicleMileage"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–û—á–∞–∫–≤–∞–Ω–∞ –¥–∞—Ç–∞</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-check text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="date" name="estimated_completion" class="form-control" 
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-2">
                            <label class="font-weight-bold text-dark">
                                <i class="fas fa-sticky-note mr-1"></i>–ë–µ–ª–µ–∂–∫–∏
                            </label>
                            <textarea name="notes" class="form-control" rows="2" 
                                      placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –±–µ–ª–µ–∂–∫–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞..."
                                      style="border-color: #dddfeb;"></textarea>
                        </div>
                    </div>
                </div>

                {{-- –î–∏–Ω–∞–º–∏—á–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ --}}
                <div class="card border-info mt-4">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-list-alt mr-2"></i>–ü–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ—Ä—ä—á–∫–∞—Ç–∞
                            <span class="badge badge-light ml-2" id="itemsCount">0 –ø–æ–∑–∏—Ü–∏–∏</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="itemsTable">
                                <thead class="bg-light">
                                    <tr>
                                        <th width="5%">‚Ññ</th>
                                        <th width="25%">–ü—Ä–æ–¥—É–∫—Ç/–£—Å–ª—É–≥–∞</th>
                                        <th width="25%">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        <th width="10%">–ö–æ–ª-–≤–æ</th>
                                        <th width="10%">–¶–µ–Ω–∞ –±–µ–∑ –î–î–°</th>
                                        <th width="10%">–î–î–° %</th>
                                        <th width="10%">–û–±—â–æ</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot class="bg-light">
                                    <tr>
                                        <td colspan="7" class="text-right font-weight-bold">–û–±—â–æ –ø–æ–∑–∏—Ü–∏–∏:</td>
                                        <td class="font-weight-bold" id="itemsCountFooter">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <button type="button" id="addRow" class="btn btn-success btn-sm">
                                <i class="fas fa-box mr-1"></i> –î–æ–±–∞–≤–∏ –ø—Ä–æ–¥—É–∫—Ç
                            </button>
                            <button type="button" id="addServiceRow" class="btn btn-primary btn-sm">
                                <i class="fas fa-tools mr-1"></i> –î–æ–±–∞–≤–∏ —É—Å–ª—É–≥–∞
                            </button>
                            <button type="button" id="addQuickService" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-bolt mr-1"></i> –ë—ä—Ä–∑–∞ —É—Å–ª—É–≥–∞
                            </button>
                        </div>
                    </div>
                </div>

                {{-- –°—É–º–∏ --}}
                <div class="row mt-4">
                    <div class="col-md-5 offset-md-7">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-calculator mr-2"></i>–û–±—â–æ —Å—É–º–∏</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <th class="text-right">–û–±—â–æ –±–µ–∑ –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-primary" id="totalWithoutVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">–î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-warning" id="totalVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr class="border-top">
                                        <th class="text-right h5">–û–±—â–æ —Å –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h3 font-weight-bold text-success" id="grandTotal">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                {{-- –ë—É—Ç–æ–Ω–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ --}}
                <div class="mt-4 d-flex justify-content-end gap-3">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save mr-2"></i> –ó–∞–ø–∞–∑–∏ –ø–æ—Ä—ä—á–∫–∞
                    </button>
                    <button type="submit" name="action" value="save_and_print" class="btn btn-primary btn-lg">
                        <i class="fas fa-print mr-2"></i> –ó–∞–ø–∞–∑–∏ –∏ –æ—Ç–ø–µ—á–∞—Ç–∞–π
                    </button>
                    <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-times mr-2"></i> –û—Ç–∫–∞–∑
                    </a>
                </div>
            </form>
        </div>
    </div>
@stop

@push('css')
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    <style>
        .select2-container--bootstrap .select2-selection {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .select2-container--bootstrap .select2-selection:focus {
            border-color: #1cc88a;
            box-shadow: 0 0 0 0.2rem rgba(28, 200, 138, 0.25);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(28, 200, 138, 0.05);
        }
        .card-header {
            border-radius: 0.35rem 0.35rem 0 0 !important;
        }
        .input-group-text {
            background-color: #f8f9fc;
            border: 1px solid #d1d3e2;
        }
        .badge {
            font-size: 0.8em;
            padding: 0.35em 0.65em;
        }
        .list-group-item:hover {
            background-color: #1cc88a !important;
            color: white !important;
            cursor: pointer;
        }
        .list-group-item .customer-badge {
            font-size: 0.75em;
        }
        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        #customerInfo, #vehicleInfo {
            border-left: 4px solid #1cc88a;
        }
    </style>
@endpush

@push('js')
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/bg.js"></script>
    <script>
        $(function () {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $('.select2').select2({
                theme: 'bootstrap',
                language: 'bg',
                width: '100%',
                allowClear: true
            });

            // –ì–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
            let searchTimeout;
            $('#globalSearch').on('input', function() {
                clearTimeout(searchTimeout);
                const query = $(this).val().trim();
                
                if (query.length < 2) {
                    $('#searchResults').hide().empty();
                    return;
                }
                
                searchTimeout = setTimeout(function() {
                    performGlobalSearch(query);
                }, 300);
            });

            // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#clearSearch').click(function() {
                $('#globalSearch').val('');
                $('#searchResults').hide().empty();
            });

            // –ó–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –ø—Ä–∏ –∫–ª–∏–∫ –∏–∑–≤—ä–Ω —Ç—è—Ö
            $(document).click(function(e) {
                if (!$(e.target).closest('#globalSearch, #searchResults').length) {
                    $('#searchResults').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∫–ª–∏–µ–Ω—Ç
            $('#customer_id').change(function () {
                const customerId = $(this).val();
                loadCustomerVehicles(customerId);
                
                // –ê–∫–æ –∏–º–∞ –∏–∑–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç, –ø–æ–∫–∞–∂–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –º—É
                if (customerId) {
                    loadCustomerInfo(customerId);
                } else {
                    $('#customerInfo').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
            $('#vehicle_id').change(function () {
                const vehicleId = $(this).val();
                if (vehicleId) {
                    loadVehicleInfo(vehicleId);
                } else {
                    $('#vehicleInfo').hide();
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –≥–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
        function performGlobalSearch(query) {
            $.ajax({
                url: "{{ route('admin.api.search.customer-vehicle') }}",
                method: 'GET',
                data: { q: query },
                beforeSend: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border spinner-border-sm text-primary mr-2"></div>
                                <span>–¢—ä—Ä—Å–µ–Ω–µ...</span>
                            </div>
                        </div>
                    `).show();
                },
                success: function(data) {
                    if (data.results && data.results.length === 0) {
                        $('#searchResults').html(`
                            <div class="list-group-item text-muted">
                                <i class="fas fa-search mr-2"></i>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
                            </div>
                        `).show();
                        return;
                    }

                    let html = '';
                    
                    // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
                    if (data.customers && data.customers.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ö–ª–∏–µ–Ω—Ç–∏</div>`;
                        data.customers.forEach(customer => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="customer" 
                                     data-id="${customer.id}"
                                     data-name="${customer.name}"
                                     data-phone="${customer.phone || ''}"
                                     data-email="${customer.email || ''}"
                                     data-address="${customer.address || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-user text-primary mr-2"></i>
                                            <strong>${highlightText(customer.name, query)}</strong>
                                        </div>
                                        <span class="badge badge-primary customer-badge">–ö–ª–∏–µ–Ω—Ç</span>
                                    </div>
                                    ${customer.phone ? `<small class="text-muted d-block mt-1"><i class="fas fa-phone mr-1"></i>${highlightText(customer.phone, query)}</small>` : ''}
                                    ${customer.email ? `<small class="text-muted d-block"><i class="fas fa-envelope mr-1"></i>${highlightText(customer.email, query)}</small>` : ''}
                                    <small class="text-muted d-block">${customer.vehicles_count || 0} –∞–≤—Ç–æ–º–æ–±–∏–ª–∞</small>
                                </div>
                            `;
                        });
                    }

                    if (data.vehicles && data.vehicles.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>`;
                        data.vehicles.forEach(vehicle => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="vehicle" 
                                     data-id="${vehicle.id}"
                                     data-customer-id="${vehicle.customer_id}"
                                     data-plate="${vehicle.plate}"
                                     data-make="${vehicle.make || ''}"
                                     data-model="${vehicle.model || ''}"
                                     data-year="${vehicle.year || ''}"
                                     data-engine="${vehicle.engine || ''}"
                                     data-vin="${vehicle.vin || ''}"
                                     data-mileage="${vehicle.current_mileage || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-car text-success mr-2"></i>
                                            <strong>${highlightText(vehicle.plate, query)}</strong>
                                        </div>
                                        <span class="badge badge-success customer-badge">–ê–≤—Ç–æ–º–æ–±–∏–ª</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        ${vehicle.make || ''} ${vehicle.model || ''} ${vehicle.year ? `(${vehicle.year})` : ''}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-user mr-1"></i>${vehicle.customer?.name || '–ù—è–º–∞ –∫–ª–∏–µ–Ω—Ç'}
                                    </small>
                                </div>
                            `;
                        });
                    }

                    $('#searchResults').html(html).show();
                    
                    // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ event listener –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç
                    $('.list-group-item[data-type]').click(function() {
                        selectSearchResult($(this));
                    });
                },
                error: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item text-danger">
                            <i class="fas fa-exclamation-circle mr-2"></i>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
                        </div>
                    `).show();
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ—Å–≤–µ—Ç—è–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ
        function highlightText(text, query) {
            if (!query || !text) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.toString().replace(regex, '<span class="search-highlight">$1</span>');
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –æ—Ç —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
        function selectSearchResult($element) {
            const type = $element.data('type');
            
            if (type === 'customer') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
                $('#customer_id').val($element.data('id')).trigger('change');
                $('#customerInfo').html(`
                    <small>
                        <i class="fas fa-user text-success mr-1"></i>
                        <strong>${$element.data('name')}</strong><br>
                        ${$element.data('phone') ? `<i class="fas fa-phone text-success mr-1"></i>${$element.data('phone')}<br>` : ''}
                        ${$element.data('email') ? `<i class="fas fa-envelope text-success mr-1"></i>${$element.data('email')}` : ''}
                    </small>
                `).show();
                
                // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                loadCustomerVehicles($element.data('id'));
                
            } else if (type === 'vehicle') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª –∏ –Ω–µ–≥–æ–≤–∏—è –∫–ª–∏–µ–Ω—Ç
                $('#vehicle_id').val($element.data('id')).trigger('change');
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∞
                $('#vehicleInfo').html(`
                    <small>
                        <i class="fas fa-car text-success mr-1"></i>
                        <strong>${$element.data('make')} ${$element.data('model')}</strong><br>
                        <i class="fas fa-hashtag text-success mr-1"></i>
                        –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${$element.data('plate')}</strong><br>
                        ${$element.data('year') ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${$element.data('year')}<br>` : ''}
                        ${$element.data('engine') ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${$element.data('engine')}<br>` : ''}
                        ${$element.data('mileage') ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${$element.data('mileage')} –∫–º` : ''}
                    </small>
                `).show();
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞
                if ($element.data('mileage')) {
                    $('#vehicleMileage').val($element.data('mileage'));
                }
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                if ($element.data('customerId')) {
                    $('#customer_id').val($element.data('customerId')).trigger('change');
                }
            }
            
            // –°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –∏ –∏–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#searchResults').hide().empty();
            $('#globalSearch').val('');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerVehicles(customerId) {
            if (!customerId) {
                $('#vehicle_id').html('<option value=""></option>').prop('disabled', true).trigger('change');
                return;
            }
            
            $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
            
            $.get("{{ route('admin.api.customer-vehicles', '') }}/" + customerId, function (data) {
                let html = '<option value=""></option>';
                if (data.length > 0) {
                    $.each(data, function (i, v) {
                        html += `<option value="${v.id}">${v.plate} - ${v.make} ${v.model} (${v.year || '?'})</option>`;
                    });
                } else {
                    html = '<option value="">–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</option>';
                }
                $('#vehicle_id').html(html).prop('disabled', false).trigger('change');
            }).fail(function() {
                $('#vehicle_id').html('<option value="">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</option>').prop('disabled', false);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerInfo(customerId) {
            $.get("{{ route('admin.api.customer-info', '') }}/" + customerId, function (data) {
                if (data) {
                    $('#customerInfo').html(`
                        <small>
                            <i class="fas fa-user text-success mr-1"></i>
                            <strong>${data.name}</strong><br>
                            ${data.phone ? `<i class="fas fa-phone text-success mr-1"></i>${data.phone}<br>` : ''}
                            ${data.email ? `<i class="fas fa-envelope text-success mr-1"></i>${data.email}<br>` : ''}
                            ${data.address ? `<i class="fas fa-map-marker-alt text-success mr-1"></i>${data.address}` : ''}
                        </small>
                    `).show();
                }
            }).fail(function() {
                $('#customerInfo').hide();
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        function loadVehicleInfo(vehicleId) {
            $.get("{{ route('admin.api.vehicle-info', '') }}/" + vehicleId, function (data) {
                if (data) {
                    $('#vehicleInfo').html(`
                        <small>
                            <i class="fas fa-car text-success mr-1"></i>
                            <strong>${data.make} ${data.model}</strong><br>
                            <i class="fas fa-hashtag text-success mr-1"></i>
                            –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${data.plate}</strong><br>
                            ${data.year ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${data.year}<br>` : ''}
                            ${data.engine ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${data.engine}<br>` : ''}
                            ${data.vin ? `<i class="fas fa-barcode text-success mr-1"></i>VIN: ${data.vin}<br>` : ''}
                            ${data.current_mileage ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${data.current_mileage} –∫–º` : ''}
                        </small>
                    `).show();
                    
                    // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–∞
                    if (data.current_mileage) {
                        $('#vehicleMileage').val(data.current_mileage);
                    }
                }
            }).fail(function() {
                $('#vehicleInfo').hide();
            });
        }

        // =============== –§—É–Ω–∫—Ü–∏–∏ –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ ===============
        let rowIdx = 0;

        function calcLine(row) {
            const qty   = parseFloat(row.find('.qty').val()) || 0;
            const price = parseFloat(row.find('.price').val()) || 0;
            const vat   = parseFloat(row.find('.vat').val()) || 0;
            const line  = qty * price;
            const vatAm = line * vat / 100;
            row.find('.lineTotal').text((line + vatAm).toFixed(2));
            calcTotals();
            updateItemsCount();
        }

        function calcTotals() {
            let totalWithout = 0, totalVat = 0;
            $('#itemsTable tbody tr').each(function () {
                const qty   = parseFloat($(this).find('.qty').val()) || 0;
                const price = parseFloat($(this).find('.price').val()) || 0;
                const vat   = parseFloat($(this).find('.vat').val()) || 0;
                const line  = qty * price;
                totalWithout += line;
                totalVat     += line * vat / 100;
            });
            $('#totalWithoutVat').text(totalWithout.toFixed(2));
            $('#totalVat').text(totalVat.toFixed(2));
            $('#grandTotal').text((totalWithout + totalVat).toFixed(2));
        }

        function updateItemsCount() {
            const count = $('#itemsTable tbody tr').length;
            $('#itemsCount').text(count + ' –ø–æ–∑–∏—Ü–∏–∏');
            $('#itemsCountFooter').text(count);
        }

        function addRow(productType = 'product', predefinedProduct = null) {
            rowIdx++;
            const isService = productType === 'service';
            
            let productOptions = '<option value=""></option>';
            @if(isset($products) && $products->count())
                @foreach($products as $p)
                    @if($p->is_service == (productType === 'service'))
                        productOptions += `
                            <option value="{{ $p->id }}" 
                                    data-price="{{ $p->price }}" 
                                    data-vat="{{ $p->vat_percent }}"
                                    data-type="{{ $p->is_service ? 'service' : 'product' }}">
                                {{ $p->sku }} - {{ $p->name }}
                            </option>`;
                    @endif
                @endforeach
            @endif

            const html = `
                <tr id="R${rowIdx}" class="${isService ? 'table-info' : ''}">
                    <td class="align-middle">${rowIdx}</td>
                    <td>
                        <select name="items[${rowIdx}][product_id]" class="form-control product-select" 
                                style="width:100%" data-type="${productType}">
                            ${productOptions}
                        </select>
                    </td>
                    <td>
                        <input type="text" name="items[${rowIdx}][description]" 
                               class="form-control" placeholder="${isService ? '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞' : '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∞'}" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][quantity]" 
                               class="form-control qty" min="0.01" step="0.01" value="1" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][unit_price]" 
                               class="form-control price" min="0.01" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][vat_percent]" 
                               class="form-control vat" min="0" max="100" step="0.01" value="20" required>
                    </td>
                    <td class="align-middle lineTotal font-weight-bold">0.00</td>
                    <td class="align-middle">
                        <button type="button" class="btn btn-sm btn-danger removeRow" title="–ü—Ä–µ–º–∞—Ö–Ω–∏">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            
            $('#itemsTable tbody').append(html);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $(`#R${rowIdx} .product-select`).select2({
                theme: 'bootstrap',
                language: 'bg',
                placeholder: `–ò–∑–±–µ—Ä–µ—Ç–µ ${isService ? '—É—Å–ª—É–≥–∞' : '–ø—Ä–æ–¥—É–∫—Ç'}`,
                allowClear: true
            });
            
            // –ê–∫–æ –∏–º–∞ predefined –ø—Ä–æ–¥—É–∫—Ç, –∏–∑–±–µ—Ä–∏ –≥–æ
            if (predefinedProduct) {
                $(`#R${rowIdx} .product-select`).val(predefinedProduct.id).trigger('change');
                $(`#R${rowIdx} .price`).val(predefinedProduct.price);
                $(`#R${rowIdx} .vat`).val(predefinedProduct.vat_percent || 20);
                $(`#R${rowIdx} input[name*="description"]`).val(predefinedProduct.name);
                calcLine($(`#R${rowIdx}`));
            }
            
            updateItemsCount();
        }

        // Event Listeners –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
        $(document)
            .on('click', '#addRow', () => addRow('product'))
            .on('click', '#addServiceRow', () => addRow('service'))
            .on('click', '#addQuickService', () => {
                addRow('service', {
                    id: 'quick_service',
                    name: '–ë—ä—Ä–∑ —Ä–µ–º–æ–Ω—Ç',
                    price: 50,
                    vat_percent: 20
                });
            })
            .on('click', '.removeRow', function () {
                $(this).closest('tr').remove();
                calcTotals();
                updateItemsCount();
                renumberRows();
            })
            .on('change keyup', '.qty, .price, .vat', function () {
                calcLine($(this).closest('tr'));
            })
            .on('change', '.product-select', function () {
                const option = $(this).find(':selected');
                const row = $(this).closest('tr');
                const price = option.data('price');
                const vat = option.data('vat');
                
                if (price) row.find('.price').val(price);
                if (vat) row.find('.vat').val(vat);
                
                if (option.text() && !row.find('input[name*="description"]').val()) {
                    row.find('input[name*="description"]').val(option.text().split(' - ')[1] || option.text());
                }
                
                calcLine(row);
                const type = option.data('type');
                row.removeClass('table-info table-warning').addClass(type === 'service' ? 'table-warning' : '');
            });

        // –ü—Ä–µ–Ω–æ–º–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–¥–æ–≤–µ —Å–ª–µ–¥ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ
        function renumberRows() {
            $('#itemsTable tbody tr').each(function(index) {
                $(this).find('td:first').text(index + 1);
                $(this).attr('id', 'R' + (index + 1));
                // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –∏–º–µ–Ω–∞—Ç–∞ –Ω–∞ –ø–æ–ª–µ—Ç–∞—Ç–∞
                $(this).find('[name*="items"]').each(function() {
                    const name = $(this).attr('name');
                    $(this).attr('name', name.replace(/items\[\d+\]/, `items[${index + 1}]`));
                });
            });
            rowIdx = $('#itemsTable tbody tr').length;
        }

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—ä—Ä–≤–∏ —Ä–µ–¥ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        $(document).ready(function() {
            addRow('product');
        });
    </script>
@endpush
–¢–æ–≤–∞ –µ —Ü–µ–ª–∏—è—Ç —Ñ–∞–π–ª —Å –≤—Å–∏—á–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ –ø—Ä–æ–º–µ–Ω–∏. –û—Å–Ω–æ–≤–Ω–∏—Ç–µ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∞:

–ù–æ–≤–∏—Ç–µ API endpoints –≤ JavaScript —á–∞—Å—Ç—Ç–∞, –∏–∑–ø–æ–ª–∑–≤–∞—â–∏ –∏–º–µ–Ω—É–≤–∞–Ω–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏

–ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ –æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ ($products –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞)

–ö–æ—Ä–µ–∫—Ç–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –≥—Ä–µ—à–∫–∏ –ø—Ä–∏ API –∑–∞—è–≤–∫–∏—Ç–µ

–ü–æ–¥–æ–±—Ä–µ–Ω autocomplete —Å –≥—Ä—É–ø–∏—Ä–∞–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –∑–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏

–§–∞–π–ª—ä—Ç –≤–µ—á–µ –µ –≥–æ—Ç–æ–≤ –∑–∞ —É–ø–æ—Ç—Ä–µ–±–∞ —Å –æ–±–Ω–æ–≤–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –∏ –º–∞—Ä—à—Ä—É—Ç–∏!

–ù–µ—â–æ –Ω–µ –µ –∫–∞–∫—Ç–æ —Ç—Ä—è–±–≤–∞ —Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ .... Internal Server Error

Copy as Markdown
Symfony\Component\Routing\Exception\RouteNotFoundException
vendor\laravel\framework\src\Illuminate\Routing\UrlGenerator.php:526
Route [admin.api.customer-vehicles] not defined.

LARAVEL
12.39.0
PHP
8.2.12
UNHANDLED
CODE 0
500
GET
http://localhost/admin/work-orders/create

Exception trace
2 vendor frames

resources\views\admin\work-orders\create.blade.php
resources\views\admin\work-orders\create.blade.php:588

583                return;
584            }
585            
586            $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
587            
588            $.get("{{ route('admin.api.customer-vehicles', '') }}/" + customerId, function (data) {
589                let html = '<option value=""></option>';
590                if (data.length > 0) {
591                    $.each(data, function (i, v) {
592                        html += `<option value="${v.id}">${v.plate} - ${v.make} ${v.model} (${v.year || '?'})</option>`;
593                    });
594                } else {
595                    html = '<option value="">–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</option>';
596                }
597                $('#vehicle_id').html(html).prop('disabled', false).trigger('change');
598            }).fail(function() {
599                $('#vehicle_id').html('<option value="">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</option>').prop('disabled', false);
600
59 vendor frames

public\index.php
public\index.php:20

Queries
1-5 of 5
mysql
select * from `sessions` where `id` = 'fYXeTEcQitn9OHIfFyumO2OPHG0UMw5aqZ80ofeu' limit 1
3.09ms
mysql
select * from `users` where `id` = 1 and `users`.`deleted_at` is null limit 1
0.75ms
mysql
select `name`, `id` from `customers` where `customers`.`deleted_at` is null
0.68ms
mysql
select * from `roles` where `name` = 'mechanic' and `guard_name` = 'web' limit 1
0.74ms
mysql
select `name`, `id` from `users` where exists (select * from `roles` inner join `model_has_roles` on `roles`.`id` = `model_has_roles`.`role_id` where `users`.`id` = `model_has_roles`.`model_id` and `model_has_roles`.`model_type` = 'App\Models\User' and `roles`.`id` in (3)) and `users`.`deleted_at` is null
0.92ms ... –ß–æ–±—è —Ç–µ –æ–ø—Ä–∞–≤–∏ –≥–æ! –ò –≤–∏–Ω–∞–≥–∏ –º–∏ –ø–æ–¥–∞–≤–∞–π –ø—Ä–∏ –ø—Ä–æ–º—è–Ω–∞ –≤ –Ω—è–∫–æ–π —Ñ–∞–π–ª, —Ü–µ–ª–∏—è—Ç —Ñ–∞–π–ª!
–í–∏–∂–¥–∞–º –≥—Ä–µ—à–∫–∞—Ç–∞! –í web.php –º–∞—Ä—à—Ä—É—Ç–∏—Ç–µ —Å–∞ –¥–µ—Ñ–∏–Ω–∏—Ä–∞–Ω–∏ —Å prefix('api'), –Ω–æ –∞–∑ —Å—ä–º –≥–∏ –¥–µ—Ñ–∏–Ω–∏—Ä–∞–ª —Å name('api.') –≤–º–µ—Å—Ç–æ —Å prefix('api'). –ï—Ç–æ –∫–æ—Ä–µ–∫—Ç–Ω–∏—Ç–µ —Ñ–∞–π–ª–æ–≤–µ:

1. routes\web.php (–∫–æ—Ä–∏–≥–∏—Ä–∞–Ω)
php
<?php

use App\Http\Controllers\ProfileController;
use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
*/

Route::get('/', fn() => redirect()->route('login'));

Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware(['auth', 'verified'])->name('dashboard');

/* --------------------------------------------------------------------------
   –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å –ø—Ä–∞–≤–∞)
--------------------------------------------------------------------------*/
Route::middleware(['auth', 'verified'])->prefix('admin')->name('admin.')->group(function () {

    /* --- –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å–∞–º–æ admin) --- */
    Route::middleware(['can:admin'])->group(function () {
        Route::resource('users',       \App\Http\Controllers\Admin\UserController::class);
        Route::resource('roles',       \App\Http\Controllers\Admin\RoleController::class);
        Route::resource('permissions', \App\Http\Controllers\Admin\PermissionController::class);
    });

    /* --- –û–°–ù–û–í–ù–ò –ú–û–î–£–õ–ò --- */
    Route::resource('customers',   \App\Http\Controllers\Admin\CustomerController::class);
    Route::resource('vehicles',    \App\Http\Controllers\Admin\VehicleController::class);
    Route::resource('products',    \App\Http\Controllers\Admin\ProductController::class);
    Route::resource('work-orders', \App\Http\Controllers\Admin\WorkOrderController::class);
    Route::resource('invoices',    \App\Http\Controllers\Admin\InvoiceController::class);

    /* --- EXPORT-–∏ –∑–∞ Customer --- */
    Route::get('customers/{customer}/export/pdf', [\App\Http\Controllers\Admin\CustomerController::class, 'exportPdf'])
        ->name('customers.export.pdf');
    Route::get('customers/{customer}/export/excel', [\App\Http\Controllers\Admin\CustomerController::class, 'exportExcel'])
        ->name('customers.export.excel');
    Route::get('customers/{customer}/export/csv', [\App\Http\Controllers\Admin\CustomerController::class, 'exportCsv'])
        ->name('customers.export.csv');

    /* --- EXPORT-–∏ –∑–∞ Vehicle --- */
    Route::get('vehicles/{vehicle}/export/pdf', [\App\Http\Controllers\Admin\VehicleController::class, 'exportPdf'])->name('vehicles.export.pdf');
    Route::get('vehicles/{vehicle}/export/excel', [\App\Http\Controllers\Admin\VehicleController::class, 'exportExcel'])->name('vehicles.export.excel');
    Route::get('vehicles/{vehicle}/export/csv', [\App\Http\Controllers\Admin\VehicleController::class, 'exportCsv'])->name('vehicles.export.csv');

    /* --- –°–ö–õ–ê–î --- */
    Route::prefix('stock')->name('stock.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\StockController::class, 'index'])->name('index');
        Route::get('/create-purchase', [\App\Http\Controllers\Admin\StockController::class, 'createPurchase'])->name('create-purchase');
        Route::post('/store-purchase', [\App\Http\Controllers\Admin\StockController::class, 'storePurchase'])->name('store-purchase');
        Route::get('/create-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'createAdjustment'])->name('create-adjustment');
        Route::post('/store-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'storeAdjustment'])->name('store-adjustment');
    });

    /* --- –ü–õ–ê–©–ê–ù–ò–Ø --- */
    Route::prefix('payments')->name('payments.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\PaymentController::class, 'index'])->name('index');
        Route::get('/create', [\App\Http\Controllers\Admin\PaymentController::class, 'create'])->name('create');
        Route::post('/store', [\App\Http\Controllers\Admin\PaymentController::class, 'store'])->name('store');
        Route::get('/{payment}/pdf', [\App\Http\Controllers\Admin\PaymentController::class, 'pdf'])->name('pdf');
    });

    /* --- –ë–ê–†–ö–û–î / PLU --- */
    Route::get('barcode/{code}.png', function (string $code) {
        return response(\App\Support\BarcodeHelper::png($code))->header('Content-Type', 'image/png');
    })->name('barcode.png');

    Route::get('products/{product}/barcode', [\App\Http\Controllers\Admin\ProductController::class, 'barcode'])
        ->name('products.barcode');

    Route::get('api/product-by-sku/{sku}', function (string $sku) {
        return \App\Models\Product::where('sku', $sku)->first() ?? [];
    })->name('api.product-by-sku');

    /* --- AJAX API –∑–∞ Work Orders --- */
    Route::prefix('api')->name('api.')->group(function () {
        // –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ autocomplete
        Route::get('search/customer-vehicle', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
            ->name('search.customer-vehicle');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-info/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerInfo'])
            ->name('customer-info');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        Route::get('vehicle-info/{vehicle}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'vehicleInfo'])
            ->name('vehicle-info');
        
        // –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-vehicles/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerVehicles'])
            ->name('customer-vehicles');
        
        // Autocomplete –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏
        Route::get('products/autocomplete', [\App\Http\Controllers\Admin\WorkOrderController::class, 'productsAutocomplete'])
            ->name('products.autocomplete');
    });

    /* --- –°—Ç–∞—Ä–æ endpoint –∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç --- */
    Route::get('api/customer-vehicles/{customer}', function (\App\Models\Customer $customer) {
        return $customer->vehicles()->select('id', 'plate', 'make', 'model', 'year')->get();
    })->name('api.customer-vehicles.legacy');

    /* --- PDF --- */
    Route::get('work-orders/{workOrder}/pdf', [\App\Http\Controllers\Admin\WorkOrderController::class, 'pdf'])
        ->name('work-orders.pdf');
        
    /* --- –¢—ä—Ä—Å–µ–Ω–µ –∑–∞ Work Orders (–∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç) --- */
    Route::get('work-orders/search', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
        ->name('work-orders.search');
});

require __DIR__ . '/auth.php';
2. app\Http\Controllers\Admin\WorkOrderController.php (–∫–æ—Ä–∏–≥–∏—Ä–∞–Ω - —Å–∞–º–æ –¥–æ–ª–Ω–∞—Ç–∞ —á–∞—Å—Ç)
php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Customer;
use App\Models\User;
use App\Models\Vehicle;
use App\Models\WorkOrder;
use App\Models\WorkOrderItem;
use App\Models\StockMovement;
use App\Models\Product;
use Barryvdh\DomPDF\Facade\Pdf;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;

class WorkOrderController extends Controller
{
    // ... (–æ—Å—Ç–∞–Ω–∞–ª–∏—Ç–µ –º–µ—Ç–æ–¥–∏ –æ—Å—Ç–∞–≤–∞—Ç —Å—ä—â–∏—Ç–µ –¥–æ –º–µ—Ç–æ–¥–∞ pdf) ...

    public function pdf(\App\Models\WorkOrder $workOrder, Request $request)
    {
        $invoice = $workOrder->invoices()->first();
        if (! $invoice) {
            $userId = Auth::check() ? Auth::user()->id : 0;

            $invoice = \App\Models\Invoice::create([
                'number'        => 'INV-' . str_pad(\App\Models\Invoice::count() + 1, 6, '0', STR_PAD_LEFT),
                'work_order_id' => $workOrder->id,
                'customer_id'   => $workOrder->customer_id,
                'issue_date'    => now(),
                'due_date'      => now()->addDays(14),
                'subtotal'      => $workOrder->total_without_vat,
                'vat_total'     => $workOrder->vat_amount,
                'grand_total'   => $workOrder->total,
                'status'        => 'draft',
                'created_by'    => $userId,
            ]);

            foreach ($workOrder->items as $item) {
                $invoice->items()->create([
                    'product_id'  => $item->product_id,
                    'description' => $item->description,
                    'quantity'    => $item->quantity,
                    'unit_price'  => $item->unit_price,
                    'vat_percent' => $item->vat_percent,
                    'line_total'  => $item->line_total,
                ]);
            }
        }

        $copy = $request->get('copy', 0);
        return Pdf::loadView('admin.invoices.pdf', compact('invoice', 'copy'))
                  ->stream('invoice_' . $invoice->number . '.pdf');
    }

    /**
     * –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ autocomplete
     */
    public function search(Request $request)
    {
        $query = $request->get('q');
        
        if (!$query || strlen($query) < 2) {
            return response()->json([
                'customers' => [],
                'vehicles' => []
            ]);
        }

        $results = [
            'customers' => Customer::where('name', 'like', "%{$query}%")
                ->orWhere('phone', 'like', "%{$query}%")
                ->orWhere('email', 'like', "%{$query}%")
                ->withCount('vehicles')
                ->limit(10)
                ->get()
                ->map(function ($customer) {
                    return [
                        'id' => $customer->id,
                        'name' => $customer->name,
                        'phone' => $customer->phone,
                        'email' => $customer->email,
                        'vehicles_count' => $customer->vehicles_count,
                        'address' => $customer->address,
                    ];
                }),
                
            'vehicles' => Vehicle::where('plate', 'like', "%{$query}%")
                ->orWhere('vin', 'like', "%{$query}%")
                ->orWhere('make', 'like', "%{$query}%")
                ->orWhere('model', 'like', "%{$query}%")
                ->with('customer')
                ->limit(10)
                ->get()
                ->map(function ($vehicle) {
                    return [
                        'id' => $vehicle->id,
                        'plate' => $vehicle->plate,
                        'make' => $vehicle->make,
                        'model' => $vehicle->model,
                        'year' => $vehicle->year,
                        'engine' => $vehicle->engine,
                        'vin' => $vehicle->vin,
                        'current_mileage' => $vehicle->current_mileage,
                        'customer_id' => $vehicle->customer_id,
                        'customer' => $vehicle->customer ? [
                            'id' => $vehicle->customer->id,
                            'name' => $vehicle->customer->name,
                            'phone' => $vehicle->customer->phone,
                            'email' => $vehicle->customer->email,
                        ] : null,
                    ];
                })
        ];
        
        return response()->json($results);
    }

    /**
     * –í—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
     */
    public function customerInfo($id)
    {
        $customer = Customer::findOrFail($id);
        return response()->json([
            'id' => $customer->id,
            'name' => $customer->name,
            'phone' => $customer->phone,
            'email' => $customer->email,
            'address' => $customer->address,
            'created_at' => $customer->created_at->format('d.m.Y'),
        ]);
    }

    /**
     * –í—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
     */
    public function vehicleInfo($id)
    {
        $vehicle = Vehicle::with('customer')->findOrFail($id);
        return response()->json([
            'id' => $vehicle->id,
            'plate' => $vehicle->plate,
            'make' => $vehicle->make,
            'model' => $vehicle->model,
            'year' => $vehicle->year,
            'engine' => $vehicle->engine,
            'vin' => $vehicle->vin,
            'color' => $vehicle->color,
            'current_mileage' => $vehicle->current_mileage,
            'customer_id' => $vehicle->customer_id,
            'customer' => $vehicle->customer ? [
                'id' => $vehicle->customer->id,
                'name' => $vehicle->customer->name,
                'phone' => $vehicle->customer->phone,
                'email' => $vehicle->customer->email,
            ] : null,
        ]);
    }

    /**
     * –í—Ä—ä—â–∞ –≤—Å–∏—á–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
     */
    public function customerVehicles($id)
    {
        $vehicles = Vehicle::where('customer_id', $id)
            ->get()
            ->map(function ($vehicle) {
                return [
                    'id' => $vehicle->id,
                    'plate' => $vehicle->plate,
                    'make' => $vehicle->make,
                    'model' => $vehicle->model,
                    'year' => $vehicle->year,
                    'engine' => $vehicle->engine,
                    'current_mileage' => $vehicle->current_mileage,
                    'full_text' => $vehicle->plate . ' - ' . $vehicle->make . ' ' . $vehicle->model . ($vehicle->year ? ' (' . $vehicle->year . ')' : ''),
                ];
            });
            
        return response()->json($vehicles);
    }

    /**
     * –í—Ä—ä—â–∞ –≤—Å–∏—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –∑–∞ autocomplete
     */
    public function productsAutocomplete(Request $request)
    {
        $query = $request->get('q');
        $type = $request->get('type', 'all'); // all, product, service
        
        $products = Product::query();
        
        if ($query) {
            $products->where(function ($q) use ($query) {
                $q->where('sku', 'like', "%{$query}%")
                  ->orWhere('name', 'like', "%{$query}%")
                  ->orWhere('description', 'like', "%{$query}%");
            });
        }
        
        if ($type === 'product') {
            $products->where('is_service', false);
        } elseif ($type === 'service') {
            $products->where('is_service', true);
        }
        
        $products = $products->select('id', 'sku', 'name', 'price', 'vat_percent', 'is_service')
            ->orderBy('is_service')
            ->orderBy('name')
            ->limit(20)
            ->get()
            ->map(function ($product) {
                return [
                    'id' => $product->id,
                    'sku' => $product->sku,
                    'name' => $product->name,
                    'price' => $product->price,
                    'vat_percent' => $product->vat_percent,
                    'is_service' => $product->is_service,
                    'full_text' => $product->sku . ' - ' . $product->name . ' (' . number_format($product->price, 2) . ' –ª–≤.)',
                ];
            });
            
        return response()->json($products);
    }
}
3. resources\views\admin\work-orders\create.blade.php (–∫–æ—Ä–∏–≥–∏—Ä–∞–Ω JavaScript)
–ï—Ç–æ —Å–∞–º–æ JavaScript —á–∞—Å—Ç—Ç–∞, –∫–æ—è—Ç–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –∫–æ—Ä–∏–≥–∏—Ä–∞—à (–æ—Ç —Ä–µ–¥ 588 –Ω–∞—Ç–∞—Ç—ä–∫):

javascript
// =============== –§—É–Ω–∫—Ü–∏–∏ –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ ===============

// –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
function loadCustomerVehicles(customerId) {
    if (!customerId) {
        $('#vehicle_id').html('<option value=""></option>').prop('disabled', true).trigger('change');
        return;
    }
    
    $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
    
    $.get("{{ route('admin.api.customer-vehicles', '') }}/" + customerId, function (data) {
        let html = '<option value=""></option>';
        if (data.length > 0) {
            $.each(data, function (i, v) {
                html += `<option value="${v.id}">${v.plate} - ${v.make} ${v.model} (${v.year || '?'})</option>`;
            });
        } else {
            html = '<option value="">–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</option>';
        }
        $('#vehicle_id').html(html).prop('disabled', false).trigger('change');
    }).fail(function() {
        $('#vehicle_id').html('<option value="">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</option>').prop('disabled', false);
    });
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
function loadCustomerInfo(customerId) {
    $.get("{{ route('admin.api.customer-info', '') }}/" + customerId, function (data) {
        if (data) {
            $('#customerInfo').html(`
                <small>
                    <i class="fas fa-user text-success mr-1"></i>
                    <strong>${data.name}</strong><br>
                    ${data.phone ? `<i class="fas fa-phone text-success mr-1"></i>${data.phone}<br>` : ''}
                    ${data.email ? `<i class="fas fa-envelope text-success mr-1"></i>${data.email}<br>` : ''}
                    ${data.address ? `<i class="fas fa-map-marker-alt text-success mr-1"></i>${data.address}` : ''}
                </small>
            `).show();
        }
    }).fail(function() {
        $('#customerInfo').hide();
    });
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
function loadVehicleInfo(vehicleId) {
    $.get("{{ route('admin.api.vehicle-info', '') }}/" + vehicleId, function (data) {
        if (data) {
            $('#vehicleInfo').html(`
                <small>
                    <i class="fas fa-car text-success mr-1"></i>
                    <strong>${data.make} ${data.model}</strong><br>
                    <i class="fas fa-hashtag text-success mr-1"></i>
                    –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${data.plate}</strong><br>
                    ${data.year ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${data.year}<br>` : ''}
                    ${data.engine ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${data.engine}<br>` : ''}
                    ${data.vin ? `<i class="fas fa-barcode text-success mr-1"></i>VIN: ${data.vin}<br>` : ''}
                    ${data.current_mileage ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${data.current_mileage} –∫–º` : ''}
                </small>
            `).show();
            
            // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–∞
            if (data.current_mileage) {
                $('#vehicleMileage').val(data.current_mileage);
            }
        }
    }).fail(function() {
        $('#vehicleInfo').hide();
    });
}
–ò —Å—ä—â–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –∫–æ—Ä–∏–≥–∏—Ä–∞—à —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ performGlobalSearch (—Ä–µ–¥–∞ 51-52):

javascript
// –§—É–Ω–∫—Ü–∏—è –∑–∞ –≥–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
function performGlobalSearch(query) {
    $.ajax({
        url: "{{ route('admin.api.search.customer-vehicle') }}",
        method: 'GET',
        data: { q: query },
        // ... –æ—Å—Ç–∞–Ω–∞–ª–∞—Ç–∞ —á–∞—Å—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ ...
    });
}
–ü—Ä–æ–º–µ–Ω–∏—Ç–µ, –∫–æ–∏—Ç–æ –Ω–∞–ø—Ä–∞–≤–∏—Ö:

–í web.php: –ö–æ—Ä–∏–≥–∏—Ä–∞—Ö –º–∞—Ä—à—Ä—É—Ç–∏—Ç–µ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—Ç prefix('api')->name('api.') –ø—Ä–∞–≤–∏–ª–Ω–æ

–ú–∞—Ä—à—Ä—É—Ç–∏—Ç–µ –≤–µ—á–µ —Å–∞:

admin.api.search.customer-vehicle

admin.api.customer-info

admin.api.vehicle-info

admin.api.customer-vehicles

–û—Å—Ç–∞–≤–∏—Ö –∏ —Å—Ç–∞—Ä–∏—è –º–∞—Ä—à—Ä—É—Ç –∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç: admin.api.customer-vehicles.legacy

–°–µ–≥–∞ –≤—Å–∏—á–∫–æ —Ç—Ä—è–±–≤–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏! –ú–∞—Ä—à—Ä—É—Ç–∏—Ç–µ —Å–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ –¥–µ—Ñ–∏–Ω–∏—Ä–∞–Ω–∏ –∏ —â–µ —Ä–∞–±–æ—Ç—è—Ç —Å blade —Ñ–∞–π–ª–∞.

–ê–∞–∞–∞ ... –û—Ç–Ω–æ–≤–æ —â–µ —Ç–µ –ø–æ–º–æ–ª—è –∫–æ–≥–∞—Ç–æ –ø—Ä–æ–≤–∏—à –∫–æ—Ä–µ–∫—Ü–∏–∏ –≤ –Ω—è–∫–æ–π —Ñ–∞–π–ª, –¥–∞ –º–∏ –≥–æ –ø–æ–¥–∞–≤–∞—à —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω –∏ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω —Ü–µ–ª–∏—è. –°–µ–≥–∞ –º–æ–ª—è —Ç–µ –ø–æ–¥–∞–π –º–∏ —Ü–µ–ª–∏—è –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω app\Http\Controllers\Admin\WorkOrderController.php –∏ —Ü–∏–ª—à–∞ –∫–æ—Ä–µ–≥–∏—Ä–∞–Ω resources\views\admin\work-orders\create.blade.php
–†–∞–∑–±–∏—Ä–∞–º! –©–µ —Ç–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—è —Ü–µ–ª–∏—Ç–µ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ:

1. app\Http\Controllers\Admin\WorkOrderController.php (—Ü–µ–ª–∏—è—Ç —Ñ–∞–π–ª)
php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Customer;
use App\Models\User;
use App\Models\Vehicle;
use App\Models\WorkOrder;
use App\Models\WorkOrderItem;
use App\Models\StockMovement;
use App\Models\Product;
use Barryvdh\DomPDF\Facade\Pdf;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;

class WorkOrderController extends Controller
{
    public function index()
    {
        $workOrders = WorkOrder::with(['customer', 'vehicle', 'mechanic'])->paginate(25);
        return view('admin.work-orders.index', compact('workOrders'));
    }

    public function create()
    {
        $customers = Customer::pluck('name', 'id');
        $vehicles = collect();
        $mechanics = User::role('mechanic')->pluck('name', 'id');
        $products = Product::select('id', 'sku', 'name', 'price', 'vat_percent', 'is_service')
            ->orderBy('is_service')
            ->orderBy('name')
            ->get();
        
        return view('admin.work-orders.create', compact('customers', 'vehicles', 'mechanics', 'products'));
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'customer_id'   => 'required|exists:customers,id',
            'vehicle_id'    => 'nullable|exists:vehicles,id',
            'status'        => 'required|in:draft,open,in_progress,completed,invoiced,closed,cancelled',
            'received_at'   => 'nullable|date',
            'km_on_receive' => 'nullable|integer|min:0',
            'assigned_to'   => 'nullable|exists:users,id',
            'notes'         => 'nullable|string',
            'items'         => 'required|array|min:1',
            'items.*.description' => 'required|string',
            'items.*.quantity'    => 'required|numeric|min:0.01',
            'items.*.unit_price'  => 'required|numeric|min:0',
            'items.*.vat_percent' => 'required|numeric|min:0|max:100',
        ]);

        $order = DB::transaction(function () use ($validated, $request) {
            $userId = Auth::check() ? Auth::user()->id : 0;

            $order = WorkOrder::create([
                'number'        => 'WO-' . str_pad(WorkOrder::count() + 1, 6, '0', STR_PAD_LEFT),
                'customer_id'   => $validated['customer_id'],
                'vehicle_id'    => $validated['vehicle_id'] ?? null,
                'status'        => $validated['status'],
                'received_at'   => $validated['received_at'] ?? now(),
                'km_on_receive' => $validated['km_on_receive'],
                'assigned_to'   => $validated['assigned_to'],
                'notes'         => $validated['notes'],
                'created_by'    => $userId,
            ]);

            $totalWithout = 0;
            foreach ($request->items as $row) {
                $qty   = $row['quantity'];
                $price = $row['unit_price'];
                $vat   = $row['vat_percent'];
                $line  = $qty * $price;
                $vatAm = $line * $vat / 100;

                WorkOrderItem::create([
                    'work_order_id'           => $order->id,
                    'product_id'              => $row['product_id'] ?: null,
                    'description'             => $row['description'],
                    'quantity'                => $qty,
                    'unit_price'              => $price,
                    'vat_percent'             => $vat,
                    'line_total_without_vat'  => $line,
                    'line_vat_amount'         => $vatAm,
                    'line_total'              => $line + $vatAm,
                ]);

                $totalWithout += $line;

                if (isset($row['product_id']) && $row['product_id']) {
                    StockMovement::create([
                        'product_id'     => $row['product_id'],
                        'change'         => -$qty,
                        'type'           => 'reservation',
                        'reference_id'   => $order->id,
                        'reference_type' => WorkOrder::class,
                        'created_by'     => $userId,
                    ]);
                }
            }

            $order->update([
                'total_without_vat' => $totalWithout,
                'vat_amount'        => $order->items()->sum('line_vat_amount'),
                'total'             => $order->items()->sum('line_total'),
            ]);

            return $order;
        });

        return redirect()->route('admin.work-orders.show', $order)->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞.');
    }

    public function show(WorkOrder $workOrder)
    {
        $workOrder->load(['items.product', 'customer', 'vehicle', 'mechanic']);
        return view('admin.work-orders.show', compact('workOrder'));
    }

    public function edit(WorkOrder $workOrder)
    {
        $customers = Customer::pluck('name', 'id');
        $vehicles  = Vehicle::where('customer_id', $workOrder->customer_id)->pluck('plate', 'id');
        $mechanics = User::role('mechanic')->pluck('name', 'id');
        $products = Product::select('id', 'sku', 'name', 'price', 'vat_percent', 'is_service')
            ->orderBy('is_service')
            ->orderBy('name')
            ->get();
            
        return view('admin.work-orders.edit', compact('workOrder', 'customers', 'vehicles', 'mechanics', 'products'));
    }

    public function update(Request $request, WorkOrder $workOrder)
    {
        $validated = $request->validate([
            'customer_id'   => 'required|exists:customers,id',
            'vehicle_id'    => 'nullable|exists:vehicles,id',
            'status'        => 'required|in:draft,open,in_progress,completed,invoiced,closed,cancelled',
            'received_at'   => 'nullable|date',
            'km_on_receive' => 'nullable|integer|min:0',
            'assigned_to'   => 'nullable|exists:users,id',
            'notes'         => 'nullable|string',
        ]);

        $workOrder->update($validated);

        return redirect()->route('admin.work-orders.index')->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞.');
    }

    public function destroy(WorkOrder $workOrder)
    {
        $workOrder->items()->delete();
        $workOrder->delete();
        return redirect()->route('admin.work-orders.index')->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞.');
    }

    public function pdf(\App\Models\WorkOrder $workOrder, Request $request)
    {
        $invoice = $workOrder->invoices()->first();
        if (! $invoice) {
            $userId = Auth::check() ? Auth::user()->id : 0;

            $invoice = \App\Models\Invoice::create([
                'number'        => 'INV-' . str_pad(\App\Models\Invoice::count() + 1, 6, '0', STR_PAD_LEFT),
                'work_order_id' => $workOrder->id,
                'customer_id'   => $workOrder->customer_id,
                'issue_date'    => now(),
                'due_date'      => now()->addDays(14),
                'subtotal'      => $workOrder->total_without_vat,
                'vat_total'     => $workOrder->vat_amount,
                'grand_total'   => $workOrder->total,
                'status'        => 'draft',
                'created_by'    => $userId,
            ]);

            foreach ($workOrder->items as $item) {
                $invoice->items()->create([
                    'product_id'  => $item->product_id,
                    'description' => $item->description,
                    'quantity'    => $item->quantity,
                    'unit_price'  => $item->unit_price,
                    'vat_percent' => $item->vat_percent,
                    'line_total'  => $item->line_total,
                ]);
            }
        }

        $copy = $request->get('copy', 0);
        return Pdf::loadView('admin.invoices.pdf', compact('invoice', 'copy'))
                  ->stream('invoice_' . $invoice->number . '.pdf');
    }

    /**
     * –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ autocomplete
     */
    public function search(Request $request)
    {
        $query = $request->get('q');
        
        if (!$query || strlen($query) < 2) {
            return response()->json([
                'customers' => [],
                'vehicles' => []
            ]);
        }

        $results = [
            'customers' => Customer::where('name', 'like', "%{$query}%")
                ->orWhere('phone', 'like', "%{$query}%")
                ->orWhere('email', 'like', "%{$query}%")
                ->withCount('vehicles')
                ->limit(10)
                ->get()
                ->map(function ($customer) {
                    return [
                        'id' => $customer->id,
                        'name' => $customer->name,
                        'phone' => $customer->phone,
                        'email' => $customer->email,
                        'vehicles_count' => $customer->vehicles_count,
                        'address' => $customer->address,
                    ];
                }),
                
            'vehicles' => Vehicle::where('plate', 'like', "%{$query}%")
                ->orWhere('vin', 'like', "%{$query}%")
                ->orWhere('make', 'like', "%{$query}%")
                ->orWhere('model', 'like', "%{$query}%")
                ->with('customer')
                ->limit(10)
                ->get()
                ->map(function ($vehicle) {
                    return [
                        'id' => $vehicle->id,
                        'plate' => $vehicle->plate,
                        'make' => $vehicle->make,
                        'model' => $vehicle->model,
                        'year' => $vehicle->year,
                        'engine' => $vehicle->engine,
                        'vin' => $vehicle->vin,
                        'current_mileage' => $vehicle->current_mileage,
                        'customer_id' => $vehicle->customer_id,
                        'customer' => $vehicle->customer ? [
                            'id' => $vehicle->customer->id,
                            'name' => $vehicle->customer->name,
                            'phone' => $vehicle->customer->phone,
                            'email' => $vehicle->customer->email,
                        ] : null,
                    ];
                })
        ];
        
        return response()->json($results);
    }

    /**
     * –í—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
     */
    public function customerInfo($id)
    {
        $customer = Customer::findOrFail($id);
        return response()->json([
            'id' => $customer->id,
            'name' => $customer->name,
            'phone' => $customer->phone,
            'email' => $customer->email,
            'address' => $customer->address,
            'created_at' => $customer->created_at->format('d.m.Y'),
        ]);
    }

    /**
     * –í—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
     */
    public function vehicleInfo($id)
    {
        $vehicle = Vehicle::with('customer')->findOrFail($id);
        return response()->json([
            'id' => $vehicle->id,
            'plate' => $vehicle->plate,
            'make' => $vehicle->make,
            'model' => $vehicle->model,
            'year' => $vehicle->year,
            'engine' => $vehicle->engine,
            'vin' => $vehicle->vin,
            'color' => $vehicle->color,
            'current_mileage' => $vehicle->current_mileage,
            'customer_id' => $vehicle->customer_id,
            'customer' => $vehicle->customer ? [
                'id' => $vehicle->customer->id,
                'name' => $vehicle->customer->name,
                'phone' => $vehicle->customer->phone,
                'email' => $vehicle->customer->email,
            ] : null,
        ]);
    }

    /**
     * –í—Ä—ä—â–∞ –≤—Å–∏—á–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
     */
    public function customerVehicles($id)
    {
        $vehicles = Vehicle::where('customer_id', $id)
            ->get()
            ->map(function ($vehicle) {
                return [
                    'id' => $vehicle->id,
                    'plate' => $vehicle->plate,
                    'make' => $vehicle->make,
                    'model' => $vehicle->model,
                    'year' => $vehicle->year,
                    'engine' => $vehicle->engine,
                    'current_mileage' => $vehicle->current_mileage,
                    'full_text' => $vehicle->plate . ' - ' . $vehicle->make . ' ' . $vehicle->model . ($vehicle->year ? ' (' . $vehicle->year . ')' : ''),
                ];
            });
            
        return response()->json($vehicles);
    }

    /**
     * –í—Ä—ä—â–∞ –≤—Å–∏—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –∑–∞ autocomplete
     */
    public function productsAutocomplete(Request $request)
    {
        $query = $request->get('q');
        $type = $request->get('type', 'all'); // all, product, service
        
        $products = Product::query();
        
        if ($query) {
            $products->where(function ($q) use ($query) {
                $q->where('sku', 'like', "%{$query}%")
                  ->orWhere('name', 'like', "%{$query}%")
                  ->orWhere('description', 'like', "%{$query}%");
            });
        }
        
        if ($type === 'product') {
            $products->where('is_service', false);
        } elseif ($type === 'service') {
            $products->where('is_service', true);
        }
        
        $products = $products->select('id', 'sku', 'name', 'price', 'vat_percent', 'is_service')
            ->orderBy('is_service')
            ->orderBy('name')
            ->limit(20)
            ->get()
            ->map(function ($product) {
                return [
                    'id' => $product->id,
                    'sku' => $product->sku,
                    'name' => $product->name,
                    'price' => $product->price,
                    'vat_percent' => $product->vat_percent,
                    'is_service' => $product->is_service,
                    'full_text' => $product->sku . ' - ' . $product->name . ' (' . number_format($product->price, 2) . ' –ª–≤.)',
                ];
            });
            
        return response()->json($products);
    }
}
2. resources\views\admin\work-orders\create.blade.php (—Ü–µ–ª–∏—è—Ç —Ñ–∞–π–ª)
blade
@extends('adminlte::page')

@section('title', '–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="text-primary"><i class="fas fa-file-invoice mr-2"></i>–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞</h1>
        <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left mr-1"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
@stop

@section('content')
    <div class="card border-primary">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-search mr-2"></i>–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ</h4>
        </div>
        <div class="card-body bg-light">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label class="font-weight-bold">–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª:</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-primary"></i>
                                </span>
                            </div>
                            <input type="text" id="globalSearch" class="form-control form-control-lg" 
                                   placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º–µ–π–ª –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä..."
                                   style="border-color: #4e73df;">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="searchResults" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto;">
                            <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —â–µ —Å–µ –ø–æ—è–≤—è—Ç —Ç—É–∫ -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <div class="alert alert-info w-100 mb-0">
                        <small>
                            <i class="fas fa-info-circle mr-1"></i>
                            –¢—ä—Ä—Å–µ—Ç–µ –ø–æ: <strong>–∏–º–µ</strong>, <strong>—Ç–µ–ª–µ—Ñ–æ–Ω</strong>, 
                            <strong>–∏–º–µ–π–ª</strong> –∏–ª–∏ <strong>—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä</strong>.
                            –ò–∑–±–µ—Ä–µ—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-success mt-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-user-circle mr-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</h4>
        </div>
        <div class="card-body">
            <form action="{{ route('admin.work-orders.store') }}" method="POST" id="orderForm">
                @csrf
                
                {{-- –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --}}
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ö–ª–∏–µ–Ω—Ç <span class="text-danger">*</span></label>
                            <select name="customer_id" id="customer_id" class="form-control select2" 
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç" required
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($customers as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <div id="customerInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-user text-success mr-1"></i>
                                    <span id="customerName"></span><br>
                                    <i class="fas fa-phone text-success mr-1"></i>
                                    <span id="customerPhone"></span><br>
                                    <i class="fas fa-envelope text-success mr-1"></i>
                                    <span id="customerEmail"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ê–≤—Ç–æ–º–æ–±–∏–ª <span class="text-danger">*</span></label>
                            <select name="vehicle_id" id="vehicle_id" class="form-control select2" required
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª"
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                            </select>
                            <div id="vehicleInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-car text-success mr-1"></i>
                                    <span id="vehicleMakeModel"></span><br>
                                    <i class="fas fa-hashtag text-success mr-1"></i>
                                    –†–µ–≥. –Ω–æ–º–µ—Ä: <span id="vehiclePlate"></span><br>
                                    <i class="fas fa-calendar text-success mr-1"></i>
                                    –ì–æ–¥–∏–Ω–∞: <span id="vehicleYear"></span><br>
                                    <i class="fas fa-gas-pump text-success mr-1"></i>
                                    –î–≤–∏–≥–∞—Ç–µ–ª: <span id="vehicleEngine"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ú–µ—Ö–∞–Ω–∏–∫</label>
                            <select name="assigned_to" class="form-control select2" 
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($mechanics as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <small class="form-text text-muted">–ù–µ–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ</small>
                        </div>
                    </div>
                </div>

                {{-- –î–µ—Ç–∞–π–ª–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞ --}}
                <div class="card border-warning mt-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0 text-dark"><i class="fas fa-clipboard-list mr-2"></i>–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–°—Ç–∞—Ç—É—Å <span class="text-danger">*</span></label>
                                    <select name="status" class="form-control" required
                                            style="border-color: #f6c23e;">
                                        <option value="draft" class="text-secondary">üìù –ß–µ—Ä–Ω–æ–≤–∞</option>
                                        <option value="open" class="text-info" selected>üîì –û—Ç–≤–æ—Ä–µ–Ω–∞</option>
                                        <option value="in_progress" class="text-warning">‚öôÔ∏è –í –ø—Ä–æ–≥—Ä–µ—Å</option>
                                        <option value="completed" class="text-success">‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω–∞</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞–Ω–µ</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="datetime-local" name="received_at" class="form-control" 
                                               value="{{ now()->format('Y-m-d\TH:i') }}"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–ü—Ä–æ–±–µ–≥ (km)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-tachometer-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="number" name="km_on_receive" class="form-control" 
                                               min="0" placeholder="0" id="vehicleMileage"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–û—á–∞–∫–≤–∞–Ω–∞ –¥–∞—Ç–∞</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-check text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="date" name="estimated_completion" class="form-control" 
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-2">
                            <label class="font-weight-bold text-dark">
                                <i class="fas fa-sticky-note mr-1"></i>–ë–µ–ª–µ–∂–∫–∏
                            </label>
                            <textarea name="notes" class="form-control" rows="2" 
                                      placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –±–µ–ª–µ–∂–∫–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞..."
                                      style="border-color: #dddfeb;"></textarea>
                        </div>
                    </div>
                </div>

                {{-- –î–∏–Ω–∞–º–∏—á–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ --}}
                <div class="card border-info mt-4">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-list-alt mr-2"></i>–ü–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ—Ä—ä—á–∫–∞—Ç–∞
                            <span class="badge badge-light ml-2" id="itemsCount">0 –ø–æ–∑–∏—Ü–∏–∏</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="itemsTable">
                                <thead class="bg-light">
                                    <tr>
                                        <th width="5%">‚Ññ</th>
                                        <th width="25%">–ü—Ä–æ–¥—É–∫—Ç/–£—Å–ª—É–≥–∞</th>
                                        <th width="25%">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        <th width="10%">–ö–æ–ª-–≤–æ</th>
                                        <th width="10%">–¶–µ–Ω–∞ –±–µ–∑ –î–î–°</th>
                                        <th width="10%">–î–î–° %</th>
                                        <th width="10%">–û–±—â–æ</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot class="bg-light">
                                    <tr>
                                        <td colspan="7" class="text-right font-weight-bold">–û–±—â–æ –ø–æ–∑–∏—Ü–∏–∏:</td>
                                        <td class="font-weight-bold" id="itemsCountFooter">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <button type="button" id="addRow" class="btn btn-success btn-sm">
                                <i class="fas fa-box mr-1"></i> –î–æ–±–∞–≤–∏ –ø—Ä–æ–¥—É–∫—Ç
                            </button>
                            <button type="button" id="addServiceRow" class="btn btn-primary btn-sm">
                                <i class="fas fa-tools mr-1"></i> –î–æ–±–∞–≤–∏ —É—Å–ª—É–≥–∞
                            </button>
                            <button type="button" id="addQuickService" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-bolt mr-1"></i> –ë—ä—Ä–∑–∞ —É—Å–ª—É–≥–∞
                            </button>
                        </div>
                    </div>
                </div>

                {{-- –°—É–º–∏ --}}
                <div class="row mt-4">
                    <div class="col-md-5 offset-md-7">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-calculator mr-2"></i>–û–±—â–æ —Å—É–º–∏</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <th class="text-right">–û–±—â–æ –±–µ–∑ –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-primary" id="totalWithoutVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">–î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-warning" id="totalVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr class="border-top">
                                        <th class="text-right h5">–û–±—â–æ —Å –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h3 font-weight-bold text-success" id="grandTotal">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                {{-- –ë—É—Ç–æ–Ω–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ --}}
                <div class="mt-4 d-flex justify-content-end gap-3">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save mr-2"></i> –ó–∞–ø–∞–∑–∏ –ø–æ—Ä—ä—á–∫–∞
                    </button>
                    <button type="submit" name="action" value="save_and_print" class="btn btn-primary btn-lg">
                        <i class="fas fa-print mr-2"></i> –ó–∞–ø–∞–∑–∏ –∏ –æ—Ç–ø–µ—á–∞—Ç–∞–π
                    </button>
                    <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-times mr-2"></i> –û—Ç–∫–∞–∑
                    </a>
                </div>
            </form>
        </div>
    </div>
@stop

@push('css')
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    <style>
        .select2-container--bootstrap .select2-selection {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .select2-container--bootstrap .select2-selection:focus {
            border-color: #1cc88a;
            box-shadow: 0 0 0 0.2rem rgba(28, 200, 138, 0.25);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(28, 200, 138, 0.05);
        }
        .card-header {
            border-radius: 0.35rem 0.35rem 0 0 !important;
        }
        .input-group-text {
            background-color: #f8f9fc;
            border: 1px solid #d1d3e2;
        }
        .badge {
            font-size: 0.8em;
            padding: 0.35em 0.65em;
        }
        .list-group-item:hover {
            background-color: #1cc88a !important;
            color: white !important;
            cursor: pointer;
        }
        .list-group-item .customer-badge {
            font-size: 0.75em;
        }
        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        #customerInfo, #vehicleInfo {
            border-left: 4px solid #1cc88a;
        }
    </style>
@endpush

@push('js')
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/bg.js"></script>
    <script>
        $(function () {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $('.select2').select2({
                theme: 'bootstrap',
                language: 'bg',
                width: '100%',
                allowClear: true
            });

            // –ì–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
            let searchTimeout;
            $('#globalSearch').on('input', function() {
                clearTimeout(searchTimeout);
                const query = $(this).val().trim();
                
                if (query.length < 2) {
                    $('#searchResults').hide().empty();
                    return;
                }
                
                searchTimeout = setTimeout(function() {
                    performGlobalSearch(query);
                }, 300);
            });

            // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#clearSearch').click(function() {
                $('#globalSearch').val('');
                $('#searchResults').hide().empty();
            });

            // –ó–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –ø—Ä–∏ –∫–ª–∏–∫ –∏–∑–≤—ä–Ω —Ç—è—Ö
            $(document).click(function(e) {
                if (!$(e.target).closest('#globalSearch, #searchResults').length) {
                    $('#searchResults').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∫–ª–∏–µ–Ω—Ç
            $('#customer_id').change(function () {
                const customerId = $(this).val();
                loadCustomerVehicles(customerId);
                
                // –ê–∫–æ –∏–º–∞ –∏–∑–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç, –ø–æ–∫–∞–∂–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –º—É
                if (customerId) {
                    loadCustomerInfo(customerId);
                } else {
                    $('#customerInfo').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
            $('#vehicle_id').change(function () {
                const vehicleId = $(this).val();
                if (vehicleId) {
                    loadVehicleInfo(vehicleId);
                } else {
                    $('#vehicleInfo').hide();
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –≥–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
        function performGlobalSearch(query) {
            $.ajax({
                url: "{{ route('admin.api.search.customer-vehicle') }}",
                method: 'GET',
                data: { q: query },
                beforeSend: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border spinner-border-sm text-primary mr-2"></div>
                                <span>–¢—ä—Ä—Å–µ–Ω–µ...</span>
                            </div>
                        </div>
                    `).show();
                },
                success: function(data) {
                    if (data.customers.length === 0 && data.vehicles.length === 0) {
                        $('#searchResults').html(`
                            <div class="list-group-item text-muted">
                                <i class="fas fa-search mr-2"></i>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
                            </div>
                        `).show();
                        return;
                    }

                    let html = '';
                    
                    // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
                    if (data.customers && data.customers.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ö–ª–∏–µ–Ω—Ç–∏</div>`;
                        data.customers.forEach(customer => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="customer" 
                                     data-id="${customer.id}"
                                     data-name="${customer.name}"
                                     data-phone="${customer.phone || ''}"
                                     data-email="${customer.email || ''}"
                                     data-address="${customer.address || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-user text-primary mr-2"></i>
                                            <strong>${highlightText(customer.name, query)}</strong>
                                        </div>
                                        <span class="badge badge-primary customer-badge">–ö–ª–∏–µ–Ω—Ç</span>
                                    </div>
                                    ${customer.phone ? `<small class="text-muted d-block mt-1"><i class="fas fa-phone mr-1"></i>${highlightText(customer.phone, query)}</small>` : ''}
                                    ${customer.email ? `<small class="text-muted d-block"><i class="fas fa-envelope mr-1"></i>${highlightText(customer.email, query)}</small>` : ''}
                                    <small class="text-muted d-block">${customer.vehicles_count || 0} –∞–≤—Ç–æ–º–æ–±–∏–ª–∞</small>
                                </div>
                            `;
                        });
                    }

                    if (data.vehicles && data.vehicles.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>`;
                        data.vehicles.forEach(vehicle => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="vehicle" 
                                     data-id="${vehicle.id}"
                                     data-customer-id="${vehicle.customer_id}"
                                     data-plate="${vehicle.plate}"
                                     data-make="${vehicle.make || ''}"
                                     data-model="${vehicle.model || ''}"
                                     data-year="${vehicle.year || ''}"
                                     data-engine="${vehicle.engine || ''}"
                                     data-vin="${vehicle.vin || ''}"
                                     data-mileage="${vehicle.current_mileage || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-car text-success mr-2"></i>
                                            <strong>${highlightText(vehicle.plate, query)}</strong>
                                        </div>
                                        <span class="badge badge-success customer-badge">–ê–≤—Ç–æ–º–æ–±–∏–ª</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        ${vehicle.make || ''} ${vehicle.model || ''} ${vehicle.year ? `(${vehicle.year})` : ''}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-user mr-1"></i>${vehicle.customer?.name || '–ù—è–º–∞ –∫–ª–∏–µ–Ω—Ç'}
                                    </small>
                                </div>
                            `;
                        });
                    }

                    $('#searchResults').html(html).show();
                    
                    // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ event listener –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç
                    $('.list-group-item[data-type]').click(function() {
                        selectSearchResult($(this));
                    });
                },
                error: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item text-danger">
                            <i class="fas fa-exclamation-circle mr-2"></i>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
                        </div>
                    `).show();
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ—Å–≤–µ—Ç—è–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ
        function highlightText(text, query) {
            if (!query || !text) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.toString().replace(regex, '<span class="search-highlight">$1</span>');
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –æ—Ç —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
        function selectSearchResult($element) {
            const type = $element.data('type');
            
            if (type === 'customer') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
                $('#customer_id').val($element.data('id')).trigger('change');
                $('#customerInfo').html(`
                    <small>
                        <i class="fas fa-user text-success mr-1"></i>
                        <strong>${$element.data('name')}</strong><br>
                        ${$element.data('phone') ? `<i class="fas fa-phone text-success mr-1"></i>${$element.data('phone')}<br>` : ''}
                        ${$element.data('email') ? `<i class="fas fa-envelope text-success mr-1"></i>${$element.data('email')}` : ''}
                    </small>
                `).show();
                
                // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                loadCustomerVehicles($element.data('id'));
                
            } else if (type === 'vehicle') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª –∏ –Ω–µ–≥–æ–≤–∏—è –∫–ª–∏–µ–Ω—Ç
                $('#vehicle_id').val($element.data('id')).trigger('change');
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∞
                $('#vehicleInfo').html(`
                    <small>
                        <i class="fas fa-car text-success mr-1"></i>
                        <strong>${$element.data('make')} ${$element.data('model')}</strong><br>
                        <i class="fas fa-hashtag text-success mr-1"></i>
                        –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${$element.data('plate')}</strong><br>
                        ${$element.data('year') ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${$element.data('year')}<br>` : ''}
                        ${$element.data('engine') ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${$element.data('engine')}<br>` : ''}
                        ${$element.data('mileage') ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${$element.data('mileage')} –∫–º` : ''}
                    </small>
                `).show();
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞
                if ($element.data('mileage')) {
                    $('#vehicleMileage').val($element.data('mileage'));
                }
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                if ($element.data('customerId')) {
                    $('#customer_id').val($element.data('customerId')).trigger('change');
                }
            }
            
            // –°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –∏ –∏–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#searchResults').hide().empty();
            $('#globalSearch').val('');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerVehicles(customerId) {
            if (!customerId) {
                $('#vehicle_id').html('<option value=""></option>').prop('disabled', true).trigger('change');
                return;
            }
            
            $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
            
            $.get("{{ route('admin.api.customer-vehicles', '') }}/" + customerId, function (data) {
                let html = '<option value=""></option>';
                if (data.length > 0) {
                    $.each(data, function (i, v) {
                        html += `<option value="${v.id}">${v.plate} - ${v.make} ${v.model} (${v.year || '?'})</option>`;
                    });
                } else {
                    html = '<option value="">–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</option>';
                }
                $('#vehicle_id').html(html).prop('disabled', false).trigger('change');
            }).fail(function() {
                $('#vehicle_id').html('<option value="">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</option>').prop('disabled', false);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerInfo(customerId) {
            $.get("{{ route('admin.api.customer-info', '') }}/" + customerId, function (data) {
                if (data) {
                    $('#customerInfo').html(`
                        <small>
                            <i class="fas fa-user text-success mr-1"></i>
                            <strong>${data.name}</strong><br>
                            ${data.phone ? `<i class="fas fa-phone text-success mr-1"></i>${data.phone}<br>` : ''}
                            ${data.email ? `<i class="fas fa-envelope text-success mr-1"></i>${data.email}<br>` : ''}
                            ${data.address ? `<i class="fas fa-map-marker-alt text-success mr-1"></i>${data.address}` : ''}
                        </small>
                    `).show();
                }
            }).fail(function() {
                $('#customerInfo').hide();
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        function loadVehicleInfo(vehicleId) {
            $.get("{{ route('admin.api.vehicle-info', '') }}/" + vehicleId, function (data) {
                if (data) {
                    $('#vehicleInfo').html(`
                        <small>
                            <i class="fas fa-car text-success mr-1"></i>
                            <strong>${data.make} ${data.model}</strong><br>
                            <i class="fas fa-hashtag text-success mr-1"></i>
                            –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${data.plate}</strong><br>
                            ${data.year ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${data.year}<br>` : ''}
                            ${data.engine ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${data.engine}<br>` : ''}
                            ${data.vin ? `<i class="fas fa-barcode text-success mr-1"></i>VIN: ${data.vin}<br>` : ''}
                            ${data.current_mileage ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${data.current_mileage} –∫–º` : ''}
                        </small>
                    `).show();
                    
                    // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–∞
                    if (data.current_mileage) {
                        $('#vehicleMileage').val(data.current_mileage);
                    }
                }
            }).fail(function() {
                $('#vehicleInfo').hide();
            });
        }

        // =============== –§—É–Ω–∫—Ü–∏–∏ –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ ===============
        let rowIdx = 0;

        function calcLine(row) {
            const qty   = parseFloat(row.find('.qty').val()) || 0;
            const price = parseFloat(row.find('.price').val()) || 0;
            const vat   = parseFloat(row.find('.vat').val()) || 0;
            const line  = qty * price;
            const vatAm = line * vat / 100;
            row.find('.lineTotal').text((line + vatAm).toFixed(2));
            calcTotals();
            updateItemsCount();
        }

        function calcTotals() {
            let totalWithout = 0, totalVat = 0;
            $('#itemsTable tbody tr').each(function () {
                const qty   = parseFloat($(this).find('.qty').val()) || 0;
                const price = parseFloat($(this).find('.price').val()) || 0;
                const vat   = parseFloat($(this).find('.vat').val()) || 0;
                const line  = qty * price;
                totalWithout += line;
                totalVat     += line * vat / 100;
            });
            $('#totalWithoutVat').text(totalWithout.toFixed(2));
            $('#totalVat').text(totalVat.toFixed(2));
            $('#grandTotal').text((totalWithout + totalVat).toFixed(2));
        }

        function updateItemsCount() {
            const count = $('#itemsTable tbody tr').length;
            $('#itemsCount').text(count + ' –ø–æ–∑–∏—Ü–∏–∏');
            $('#itemsCountFooter').text(count);
        }

        function addRow(productType = 'product', predefinedProduct = null) {
            rowIdx++;
            const isService = productType === 'service';
            
            let productOptions = '<option value=""></option>';
            @if(isset($products) && $products->count())
                @foreach($products as $p)
                    @if($p->is_service == (productType === 'service'))
                        productOptions += `
                            <option value="{{ $p->id }}" 
                                    data-price="{{ $p->price }}" 
                                    data-vat="{{ $p->vat_percent }}"
                                    data-type="{{ $p->is_service ? 'service' : 'product' }}">
                                {{ $p->sku }} - {{ $p->name }}
                            </option>`;
                    @endif
                @endforeach
            @endif

            const html = `
                <tr id="R${rowIdx}" class="${isService ? 'table-info' : ''}">
                    <td class="align-middle">${rowIdx}</td>
                    <td>
                        <select name="items[${rowIdx}][product_id]" class="form-control product-select" 
                                style="width:100%" data-type="${productType}">
                            ${productOptions}
                        </select>
                    </td>
                    <td>
                        <input type="text" name="items[${rowIdx}][description]" 
                               class="form-control" placeholder="${isService ? '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞' : '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∞'}" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][quantity]" 
                               class="form-control qty" min="0.01" step="0.01" value="1" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][unit_price]" 
                               class="form-control price" min="0.01" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][vat_percent]" 
                               class="form-control vat" min="0" max="100" step="0.01" value="20" required>
                    </td>
                    <td class="align-middle lineTotal font-weight-bold">0.00</td>
                    <td class="align-middle">
                        <button type="button" class="btn btn-sm btn-danger removeRow" title="–ü—Ä–µ–º–∞—Ö–Ω–∏">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            
            $('#itemsTable tbody').append(html);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $(`#R${rowIdx} .product-select`).select2({
                theme: 'bootstrap',
                language: 'bg',
                placeholder: `–ò–∑–±–µ—Ä–µ—Ç–µ ${isService ? '—É—Å–ª—É–≥–∞' : '–ø—Ä–æ–¥—É–∫—Ç'}`,
                allowClear: true
            });
            
            // –ê–∫–æ –∏–º–∞ predefined –ø—Ä–æ–¥—É–∫—Ç, –∏–∑–±–µ—Ä–∏ –≥–æ
            if (predefinedProduct) {
                $(`#R${rowIdx} .product-select`).val(predefinedProduct.id).trigger('change');
                $(`#R${rowIdx} .price`).val(predefinedProduct.price);
                $(`#R${rowIdx} .vat`).val(predefinedProduct.vat_percent || 20);
                $(`#R${rowIdx} input[name*="description"]`).val(predefinedProduct.name);
                calcLine($(`#R${rowIdx}`));
            }
            
            updateItemsCount();
        }

        // Event Listeners –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
        $(document)
            .on('click', '#addRow', () => addRow('product'))
            .on('click', '#addServiceRow', () => addRow('service'))
            .on('click', '#addQuickService', () => {
                addRow('service', {
                    id: 'quick_service',
                    name: '–ë—ä—Ä–∑ —Ä–µ–º–æ–Ω—Ç',
                    price: 50,
                    vat_percent: 20
                });
            })
            .on('click', '.removeRow', function () {
                $(this).closest('tr').remove();
                calcTotals();
                updateItemsCount();
                renumberRows();
            })
            .on('change keyup', '.qty, .price, .vat', function () {
                calcLine($(this).closest('tr'));
            })
            .on('change', '.product-select', function () {
                const option = $(this).find(':selected');
                const row = $(this).closest('tr');
                const price = option.data('price');
                const vat = option.data('vat');
                
                if (price) row.find('.price').val(price);
                if (vat) row.find('.vat').val(vat);
                
                if (option.text() && !row.find('input[name*="description"]').val()) {
                    row.find('input[name*="description"]').val(option.text().split(' - ')[1] || option.text());
                }
                
                calcLine(row);
                const type = option.data('type');
                row.removeClass('table-info table-warning').addClass(type === 'service' ? 'table-warning' : '');
            });

        // –ü—Ä–µ–Ω–æ–º–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–¥–æ–≤–µ —Å–ª–µ–¥ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ
        function renumberRows() {
            $('#itemsTable tbody tr').each(function(index) {
                $(this).find('td:first').text(index + 1);
                $(this).attr('id', 'R' + (index + 1));
                // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –∏–º–µ–Ω–∞—Ç–∞ –Ω–∞ –ø–æ–ª–µ—Ç–∞—Ç–∞
                $(this).find('[name*="items"]').each(function() {
                    const name = $(this).attr('name');
                    $(this).attr('name', name.replace(/items\[\d+\]/, `items[${index + 1}]`));
                });
            });
            rowIdx = $('#itemsTable tbody tr').length;
        }

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—ä—Ä–≤–∏ —Ä–µ–¥ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        $(document).ready(function() {
            addRow('product');
        });
    </script>
@endpush
3. routes\web.php (—Ü–µ–ª–∏—è—Ç —Ñ–∞–π–ª –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç)
php
<?php

use App\Http\Controllers\ProfileController;
use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
*/

Route::get('/', fn() => redirect()->route('login'));

Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware(['auth', 'verified'])->name('dashboard');

/* --------------------------------------------------------------------------
   –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å –ø—Ä–∞–≤–∞)
--------------------------------------------------------------------------*/
Route::middleware(['auth', 'verified'])->prefix('admin')->name('admin.')->group(function () {

    /* --- –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å–∞–º–æ admin) --- */
    Route::middleware(['can:admin'])->group(function () {
        Route::resource('users',       \App\Http\Controllers\Admin\UserController::class);
        Route::resource('roles',       \App\Http\Controllers\Admin\RoleController::class);
        Route::resource('permissions', \App\Http\Controllers\Admin\PermissionController::class);
    });

    /* --- –û–°–ù–û–í–ù–ò –ú–û–î–£–õ–ò --- */
    Route::resource('customers',   \App\Http\Controllers\Admin\CustomerController::class);
    Route::resource('vehicles',    \App\Http\Controllers\Admin\VehicleController::class);
    Route::resource('products',    \App\Http\Controllers\Admin\ProductController::class);
    Route::resource('work-orders', \App\Http\Controllers\Admin\WorkOrderController::class);
    Route::resource('invoices',    \App\Http\Controllers\Admin\InvoiceController::class);

    /* --- EXPORT-–∏ –∑–∞ Customer --- */
    Route::get('customers/{customer}/export/pdf', [\App\Http\Controllers\Admin\CustomerController::class, 'exportPdf'])
        ->name('customers.export.pdf');
    Route::get('customers/{customer}/export/excel', [\App\Http\Controllers\Admin\CustomerController::class, 'exportExcel'])
        ->name('customers.export.excel');
    Route::get('customers/{customer}/export/csv', [\App\Http\Controllers\Admin\CustomerController::class, 'exportCsv'])
        ->name('customers.export.csv');

    /* --- EXPORT-–∏ –∑–∞ Vehicle --- */
    Route::get('vehicles/{vehicle}/export/pdf', [\App\Http\Controllers\Admin\VehicleController::class, 'exportPdf'])->name('vehicles.export.pdf');
    Route::get('vehicles/{vehicle}/export/excel', [\App\Http\Controllers\Admin\VehicleController::class, 'exportExcel'])->name('vehicles.export.excel');
    Route::get('vehicles/{vehicle}/export/csv', [\App\Http\Controllers\Admin\VehicleController::class, 'exportCsv'])->name('vehicles.export.csv');

    /* --- –°–ö–õ–ê–î --- */
    Route::prefix('stock')->name('stock.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\StockController::class, 'index'])->name('index');
        Route::get('/create-purchase', [\App\Http\Controllers\Admin\StockController::class, 'createPurchase'])->name('create-purchase');
        Route::post('/store-purchase', [\App\Http\Controllers\Admin\StockController::class, 'storePurchase'])->name('store-purchase');
        Route::get('/create-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'createAdjustment'])->name('create-adjustment');
        Route::post('/store-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'storeAdjustment'])->name('store-adjustment');
    });

    /* --- –ü–õ–ê–©–ê–ù–ò–Ø --- */
    Route::prefix('payments')->name('payments.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\PaymentController::class, 'index'])->name('index');
        Route::get('/create', [\App\Http\Controllers\Admin\PaymentController::class, 'create'])->name('create');
        Route::post('/store', [\App\Http\Controllers\Admin\PaymentController::class, 'store'])->name('store');
        Route::get('/{payment}/pdf', [\App\Http\Controllers\Admin\PaymentController::class, 'pdf'])->name('pdf');
    });

    /* --- –ë–ê–†–ö–û–î / PLU --- */
    Route::get('barcode/{code}.png', function (string $code) {
        return response(\App\Support\BarcodeHelper::png($code))->header('Content-Type', 'image/png');
    })->name('barcode.png');

    Route::get('products/{product}/barcode', [\App\Http\Controllers\Admin\ProductController::class, 'barcode'])
        ->name('products.barcode');

    Route::get('api/product-by-sku/{sku}', function (string $sku) {
        return \App\Models\Product::where('sku', $sku)->first() ?? [];
    })->name('api.product-by-sku');

    /* --- AJAX API –∑–∞ Work Orders --- */
    Route::prefix('api')->name('api.')->group(function () {
        // –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ autocomplete
        Route::get('search/customer-vehicle', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
            ->name('search.customer-vehicle');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-info/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerInfo'])
            ->name('customer-info');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        Route::get('vehicle-info/{vehicle}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'vehicleInfo'])
            ->name('vehicle-info');
        
        // –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-vehicles/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerVehicles'])
            ->name('customer-vehicles');
        
        // Autocomplete –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏
        Route::get('products/autocomplete', [\App\Http\Controllers\Admin\WorkOrderController::class, 'productsAutocomplete'])
            ->name('products.autocomplete');
    });

    /* --- –°—Ç–∞—Ä–æ endpoint –∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç --- */
    Route::get('api/customer-vehicles/{customer}', function (\App\Models\Customer $customer) {
        return $customer->vehicles()->select('id', 'plate', 'make', 'model', 'year')->get();
    })->name('api.customer-vehicles.legacy');

    /* --- PDF --- */
    Route::get('work-orders/{workOrder}/pdf', [\App\Http\Controllers\Admin\WorkOrderController::class, 'pdf'])
        ->name('work-orders.pdf');
        
    /* --- –¢—ä—Ä—Å–µ–Ω–µ –∑–∞ Work Orders (–∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç) --- */
    Route::get('work-orders/search', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
        ->name('work-orders.search');
});

require __DIR__ . '/auth.php';
–ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞:

–ú–∞—Ä—à—Ä—É—Ç–∏—Ç–µ –≤–µ—á–µ —Å–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ –¥–µ—Ñ–∏–Ω–∏—Ä–∞–Ω–∏ —Å prefix('api')->name('api.')

JavaScript –∫–æ–¥—ä—Ç –∏–∑–ø–æ–ª–∑–≤–∞ –ø—Ä–∞–≤–∏–ª–Ω–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏: admin.api.search.customer-vehicle, admin.api.customer-info, admin.api.vehicle-info, admin.api.customer-vehicles

–ü–æ–ø—Ä–∞–≤–∏—Ö –ø—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞ –∑–∞ –ø—Ä–∞–∑–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –≤ performGlobalSearch —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞

–°–µ–≥–∞ –≤—Å–∏—á–∫–æ —Ç—Ä—è–±–≤–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏ –±–µ–∑ RouteNotFoundException!

–í—ä–ø—Ä–µ–∫–∏ –≤—Å–∏—á–∫–∏ –ø—Ä–æ–º–µ–Ω–∏, –ø—Ä–æ–¥—ä–ª–∂–∞–≤–∞ –¥–∞ –∏–º–∞ –ø—Ä–æ–±–ª–µ–º ... Internal Server Error

Copy as Markdown
Illuminate\Database\QueryException
vendor\laravel\framework\src\Illuminate\Database\Connection.php:824
SQLSTATE[42S22]: Column not found: 1054 Unknown column 'is_service' in 'field list' (Connection: mysql, SQL: select `id`, `sku`, `name`, `price`, `vat_percent`, `is_service` from `products` where `products`.`deleted_at` is null order by `is_service` asc, `name` asc)

LARAVEL
12.39.0
PHP
8.2.12
UNHANDLED
CODE 42S22
500
GET
http://localhost/admin/work-orders/create

Exception trace
9 vendor frames

App\Http\Controllers\Admin\WorkOrderController->create()
app\Http\Controllers\Admin\WorkOrderController.php:34

29        $vehicles = collect();
30        $mechanics = User::role('mechanic')->pluck('name', 'id');
31        $products = Product::select('id', 'sku', 'name', 'price', 'vat_percent', 'is_service')
32            ->orderBy('is_service')
33            ->orderBy('name')
34            ->get();
35        
36        return view('admin.work-orders.create', compact('customers', 'vehicles', 'mechanics', 'products'));
37    }
38
39    public function store(Request $request)
40    {
41        $validated = $request->validate([
42            'customer_id'   => 'required|exists:customers,id',
43            'vehicle_id'    => 'nullable|exists:vehicles,id',
44            'status'        => 'required|in:draft,open,in_progress,completed,invoiced,closed,cancelled',
45            'received_at'   => 'nullable|date',
46
51 vendor frames

public\index.php
public\index.php:20

Queries
1-5 of 5
mysql
select * from `sessions` where `id` = 'fYXeTEcQitn9OHIfFyumO2OPHG0UMw5aqZ80ofeu' limit 1
3.21ms
mysql
select * from `users` where `id` = 1 and `users`.`deleted_at` is null limit 1
0.7ms
mysql
select `name`, `id` from `customers` where `customers`.`deleted_at` is null
0.71ms
mysql
select * from `roles` where `name` = 'mechanic' and `guard_name` = 'web' limit 1
0.71ms
mysql
select `name`, `id` from `users` where exists (select * from `roles` inner join `model_has_roles` on `roles`.`id` = `model_has_roles`.`role_id` where `users`.`id` = `model_has_roles`.`model_id` and `model_has_roles`.`model_type` = 'App\Models\User' and `roles`.`id` in (3)) and `users`.`deleted_at` is null
0.94ms
–ü—Ä–æ–±–ª–µ–º—ä—Ç –µ, —á–µ –Ω—è–º–∞ –∫–æ–ª–æ–Ω–∞ is_service –≤ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ products. –¢—Ä—è–±–≤–∞ –¥–∞ –ø—Ä–æ–º–µ–Ω–∏–º –∑–∞—è–≤–∫–∏—Ç–µ –¥–∞ –Ω–µ –≤–∫–ª—é—á–≤–∞—Ç —Ç–∞–∑–∏ –∫–æ–ª–æ–Ω–∞, –∏–ª–∏ –¥–∞ –¥–æ–±–∞–≤–∏–º –∫–æ–ª–æ–Ω–∞—Ç–∞ —á—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—è.

–ï—Ç–æ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª–æ–≤–µ:

1. app\Http\Controllers\Admin\WorkOrderController.php (–∫–æ—Ä–∏–≥–∏—Ä–∞–Ω)
php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Customer;
use App\Models\User;
use App\Models\Vehicle;
use App\Models\WorkOrder;
use App\Models\WorkOrderItem;
use App\Models\StockMovement;
use App\Models\Product;
use Barryvdh\DomPDF\Facade\Pdf;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;

class WorkOrderController extends Controller
{
    public function index()
    {
        $workOrders = WorkOrder::with(['customer', 'vehicle', 'mechanic'])->paginate(25);
        return view('admin.work-orders.index', compact('workOrders'));
    }

    public function create()
    {
        $customers = Customer::pluck('name', 'id');
        $vehicles = collect();
        $mechanics = User::role('mechanic')->pluck('name', 'id');
        $products = Product::select('id', 'sku', 'name', 'price', 'vat_percent')
            ->orderBy('name')
            ->get();
        
        return view('admin.work-orders.create', compact('customers', 'vehicles', 'mechanics', 'products'));
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'customer_id'   => 'required|exists:customers,id',
            'vehicle_id'    => 'nullable|exists:vehicles,id',
            'status'        => 'required|in:draft,open,in_progress,completed,invoiced,closed,cancelled',
            'received_at'   => 'nullable|date',
            'km_on_receive' => 'nullable|integer|min:0',
            'assigned_to'   => 'nullable|exists:users,id',
            'notes'         => 'nullable|string',
            'items'         => 'required|array|min:1',
            'items.*.description' => 'required|string',
            'items.*.quantity'    => 'required|numeric|min:0.01',
            'items.*.unit_price'  => 'required|numeric|min:0',
            'items.*.vat_percent' => 'required|numeric|min:0|max:100',
        ]);

        $order = DB::transaction(function () use ($validated, $request) {
            $userId = Auth::check() ? Auth::user()->id : 0;

            $order = WorkOrder::create([
                'number'        => 'WO-' . str_pad(WorkOrder::count() + 1, 6, '0', STR_PAD_LEFT),
                'customer_id'   => $validated['customer_id'],
                'vehicle_id'    => $validated['vehicle_id'] ?? null,
                'status'        => $validated['status'],
                'received_at'   => $validated['received_at'] ?? now(),
                'km_on_receive' => $validated['km_on_receive'],
                'assigned_to'   => $validated['assigned_to'],
                'notes'         => $validated['notes'],
                'created_by'    => $userId,
            ]);

            $totalWithout = 0;
            foreach ($request->items as $row) {
                $qty   = $row['quantity'];
                $price = $row['unit_price'];
                $vat   = $row['vat_percent'];
                $line  = $qty * $price;
                $vatAm = $line * $vat / 100;

                WorkOrderItem::create([
                    'work_order_id'           => $order->id,
                    'product_id'              => $row['product_id'] ?: null,
                    'description'             => $row['description'],
                    'quantity'                => $qty,
                    'unit_price'              => $price,
                    'vat_percent'             => $vat,
                    'line_total_without_vat'  => $line,
                    'line_vat_amount'         => $vatAm,
                    'line_total'              => $line + $vatAm,
                ]);

                $totalWithout += $line;

                if (isset($row['product_id']) && $row['product_id']) {
                    StockMovement::create([
                        'product_id'     => $row['product_id'],
                        'change'         => -$qty,
                        'type'           => 'reservation',
                        'reference_id'   => $order->id,
                        'reference_type' => WorkOrder::class,
                        'created_by'     => $userId,
                    ]);
                }
            }

            $order->update([
                'total_without_vat' => $totalWithout,
                'vat_amount'        => $order->items()->sum('line_vat_amount'),
                'total'             => $order->items()->sum('line_total'),
            ]);

            return $order;
        });

        return redirect()->route('admin.work-orders.show', $order)->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞.');
    }

    public function show(WorkOrder $workOrder)
    {
        $workOrder->load(['items.product', 'customer', 'vehicle', 'mechanic']);
        return view('admin.work-orders.show', compact('workOrder'));
    }

    public function edit(WorkOrder $workOrder)
    {
        $customers = Customer::pluck('name', 'id');
        $vehicles  = Vehicle::where('customer_id', $workOrder->customer_id)->pluck('plate', 'id');
        $mechanics = User::role('mechanic')->pluck('name', 'id');
        $products = Product::select('id', 'sku', 'name', 'price', 'vat_percent')
            ->orderBy('name')
            ->get();
            
        return view('admin.work-orders.edit', compact('workOrder', 'customers', 'vehicles', 'mechanics', 'products'));
    }

    public function update(Request $request, WorkOrder $workOrder)
    {
        $validated = $request->validate([
            'customer_id'   => 'required|exists:customers,id',
            'vehicle_id'    => 'nullable|exists:vehicles,id',
            'status'        => 'required|in:draft,open,in_progress,completed,invoiced,closed,cancelled',
            'received_at'   => 'nullable|date',
            'km_on_receive' => 'nullable|integer|min:0',
            'assigned_to'   => 'nullable|exists:users,id',
            'notes'         => 'nullable|string',
        ]);

        $workOrder->update($validated);

        return redirect()->route('admin.work-orders.index')->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞.');
    }

    public function destroy(WorkOrder $workOrder)
    {
        $workOrder->items()->delete();
        $workOrder->delete();
        return redirect()->route('admin.work-orders.index')->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞.');
    }

    public function pdf(\App\Models\WorkOrder $workOrder, Request $request)
    {
        $invoice = $workOrder->invoices()->first();
        if (! $invoice) {
            $userId = Auth::check() ? Auth::user()->id : 0;

            $invoice = \App\Models\Invoice::create([
                'number'        => 'INV-' . str_pad(\App\Models\Invoice::count() + 1, 6, '0', STR_PAD_LEFT),
                'work_order_id' => $workOrder->id,
                'customer_id'   => $workOrder->customer_id,
                'issue_date'    => now(),
                'due_date'      => now()->addDays(14),
                'subtotal'      => $workOrder->total_without_vat,
                'vat_total'     => $workOrder->vat_amount,
                'grand_total'   => $workOrder->total,
                'status'        => 'draft',
                'created_by'    => $userId,
            ]);

            foreach ($workOrder->items as $item) {
                $invoice->items()->create([
                    'product_id'  => $item->product_id,
                    'description' => $item->description,
                    'quantity'    => $item->quantity,
                    'unit_price'  => $item->unit_price,
                    'vat_percent' => $item->vat_percent,
                    'line_total'  => $item->line_total,
                ]);
            }
        }

        $copy = $request->get('copy', 0);
        return Pdf::loadView('admin.invoices.pdf', compact('invoice', 'copy'))
                  ->stream('invoice_' . $invoice->number . '.pdf');
    }

    /**
     * –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ autocomplete
     */
    public function search(Request $request)
    {
        $query = $request->get('q');
        
        if (!$query || strlen($query) < 2) {
            return response()->json([
                'customers' => [],
                'vehicles' => []
            ]);
        }

        $results = [
            'customers' => Customer::where('name', 'like', "%{$query}%")
                ->orWhere('phone', 'like', "%{$query}%")
                ->orWhere('email', 'like', "%{$query}%")
                ->withCount('vehicles')
                ->limit(10)
                ->get()
                ->map(function ($customer) {
                    return [
                        'id' => $customer->id,
                        'name' => $customer->name,
                        'phone' => $customer->phone,
                        'email' => $customer->email,
                        'vehicles_count' => $customer->vehicles_count,
                        'address' => $customer->address,
                    ];
                }),
                
            'vehicles' => Vehicle::where('plate', 'like', "%{$query}%")
                ->orWhere('vin', 'like', "%{$query}%")
                ->orWhere('make', 'like', "%{$query}%")
                ->orWhere('model', 'like', "%{$query}%")
                ->with('customer')
                ->limit(10)
                ->get()
                ->map(function ($vehicle) {
                    return [
                        'id' => $vehicle->id,
                        'plate' => $vehicle->plate,
                        'make' => $vehicle->make,
                        'model' => $vehicle->model,
                        'year' => $vehicle->year,
                        'engine' => $vehicle->engine,
                        'vin' => $vehicle->vin,
                        'current_mileage' => $vehicle->current_mileage,
                        'customer_id' => $vehicle->customer_id,
                        'customer' => $vehicle->customer ? [
                            'id' => $vehicle->customer->id,
                            'name' => $vehicle->customer->name,
                            'phone' => $vehicle->customer->phone,
                            'email' => $vehicle->customer->email,
                        ] : null,
                    ];
                })
        ];
        
        return response()->json($results);
    }

    /**
     * –í—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
     */
    public function customerInfo($id)
    {
        $customer = Customer::findOrFail($id);
        return response()->json([
            'id' => $customer->id,
            'name' => $customer->name,
            'phone' => $customer->phone,
            'email' => $customer->email,
            'address' => $customer->address,
            'created_at' => $customer->created_at->format('d.m.Y'),
        ]);
    }

    /**
     * –í—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
     */
    public function vehicleInfo($id)
    {
        $vehicle = Vehicle::with('customer')->findOrFail($id);
        return response()->json([
            'id' => $vehicle->id,
            'plate' => $vehicle->plate,
            'make' => $vehicle->make,
            'model' => $vehicle->model,
            'year' => $vehicle->year,
            'engine' => $vehicle->engine,
            'vin' => $vehicle->vin,
            'color' => $vehicle->color,
            'current_mileage' => $vehicle->current_mileage,
            'customer_id' => $vehicle->customer_id,
            'customer' => $vehicle->customer ? [
                'id' => $vehicle->customer->id,
                'name' => $vehicle->customer->name,
                'phone' => $vehicle->customer->phone,
                'email' => $vehicle->customer->email,
            ] : null,
        ]);
    }

    /**
     * –í—Ä—ä—â–∞ –≤—Å–∏—á–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
     */
    public function customerVehicles($id)
    {
        $vehicles = Vehicle::where('customer_id', $id)
            ->get()
            ->map(function ($vehicle) {
                return [
                    'id' => $vehicle->id,
                    'plate' => $vehicle->plate,
                    'make' => $vehicle->make,
                    'model' => $vehicle->model,
                    'year' => $vehicle->year,
                    'engine' => $vehicle->engine,
                    'current_mileage' => $vehicle->current_mileage,
                    'full_text' => $vehicle->plate . ' - ' . $vehicle->make . ' ' . $vehicle->model . ($vehicle->year ? ' (' . $vehicle->year . ')' : ''),
                ];
            });
            
        return response()->json($vehicles);
    }

    /**
     * –í—Ä—ä—â–∞ –≤—Å–∏—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –∑–∞ autocomplete
     */
    public function productsAutocomplete(Request $request)
    {
        $query = $request->get('q');
        $type = $request->get('type', 'all'); // all, product, service
        
        $products = Product::query();
        
        if ($query) {
            $products->where(function ($q) use ($query) {
                $q->where('sku', 'like', "%{$query}%")
                  ->orWhere('name', 'like', "%{$query}%")
                  ->orWhere('description', 'like', "%{$query}%");
            });
        }
        
        // –ó–∞ —Å–µ–≥–∞ –Ω—è–º–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏ –∏ —É—Å–ª—É–≥–∏, –∑–∞—â–æ—Ç–æ –Ω—è–º–∞ –∫–æ–ª–æ–Ω–∞ is_service
        // –ê–∫–æ –∏—Å–∫–∞—à –¥–∞ –¥–æ–±–∞–≤–∏—à —Ç–∞–∑–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç, —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä–∑–¥–∞–¥–µ—à –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞ –∫–æ–ª–æ–Ω–∞—Ç–∞
        
        $products = $products->select('id', 'sku', 'name', 'price', 'vat_percent')
            ->orderBy('name')
            ->limit(20)
            ->get()
            ->map(function ($product) {
                return [
                    'id' => $product->id,
                    'sku' => $product->sku,
                    'name' => $product->name,
                    'price' => $product->price,
                    'vat_percent' => $product->vat_percent,
                    'is_service' => false, // –≤—Ä–µ–º–µ–Ω–Ω–æ —Å—Ç–æ–π–Ω–æ—Å—Ç
                    'full_text' => $product->sku . ' - ' . $product->name . ' (' . number_format($product->price, 2) . ' –ª–≤.)',
                ];
            });
            
        return response()->json($products);
    }
}
2. resources\views\admin\work-orders\create.blade.php (–∫–æ—Ä–∏–≥–∏—Ä–∞–Ω JavaScript –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏)
–¢—Ä—è–±–≤–∞ –¥–∞ –∫–æ—Ä–∏–≥–∏—Ä–∞–º–µ —á–∞—Å—Ç—Ç–∞ —Å –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ –≤ JavaScript –∫–æ–¥–∞. –ï—Ç–æ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω–∏—è create.blade.php —Ñ–∞–π–ª:

blade
@extends('adminlte::page')

@section('title', '–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="text-primary"><i class="fas fa-file-invoice mr-2"></i>–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞</h1>
        <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left mr-1"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
@stop

@section('content')
    <div class="card border-primary">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-search mr-2"></i>–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ</h4>
        </div>
        <div class="card-body bg-light">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label class="font-weight-bold">–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª:</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-primary"></i>
                                </span>
                            </div>
                            <input type="text" id="globalSearch" class="form-control form-control-lg" 
                                   placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º–µ–π–ª –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä..."
                                   style="border-color: #4e73df;">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="searchResults" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto;">
                            <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —â–µ —Å–µ –ø–æ—è–≤—è—Ç —Ç—É–∫ -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <div class="alert alert-info w-100 mb-0">
                        <small>
                            <i class="fas fa-info-circle mr-1"></i>
                            –¢—ä—Ä—Å–µ—Ç–µ –ø–æ: <strong>–∏–º–µ</strong>, <strong>—Ç–µ–ª–µ—Ñ–æ–Ω</strong>, 
                            <strong>–∏–º–µ–π–ª</strong> –∏–ª–∏ <strong>—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä</strong>.
                            –ò–∑–±–µ—Ä–µ—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-success mt-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-user-circle mr-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</h4>
        </div>
        <div class="card-body">
            <form action="{{ route('admin.work-orders.store') }}" method="POST" id="orderForm">
                @csrf
                
                {{-- –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --}}
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ö–ª–∏–µ–Ω—Ç <span class="text-danger">*</span></label>
                            <select name="customer_id" id="customer_id" class="form-control select2" 
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç" required
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($customers as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <div id="customerInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-user text-success mr-1"></i>
                                    <span id="customerName"></span><br>
                                    <i class="fas fa-phone text-success mr-1"></i>
                                    <span id="customerPhone"></span><br>
                                    <i class="fas fa-envelope text-success mr-1"></i>
                                    <span id="customerEmail"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ê–≤—Ç–æ–º–æ–±–∏–ª <span class="text-danger">*</span></label>
                            <select name="vehicle_id" id="vehicle_id" class="form-control select2" required
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª"
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                            </select>
                            <div id="vehicleInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-car text-success mr-1"></i>
                                    <span id="vehicleMakeModel"></span><br>
                                    <i class="fas fa-hashtag text-success mr-1"></i>
                                    –†–µ–≥. –Ω–æ–º–µ—Ä: <span id="vehiclePlate"></span><br>
                                    <i class="fas fa-calendar text-success mr-1"></i>
                                    –ì–æ–¥–∏–Ω–∞: <span id="vehicleYear"></span><br>
                                    <i class="fas fa-gas-pump text-success mr-1"></i>
                                    –î–≤–∏–≥–∞—Ç–µ–ª: <span id="vehicleEngine"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ú–µ—Ö–∞–Ω–∏–∫</label>
                            <select name="assigned_to" class="form-control select2" 
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($mechanics as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <small class="form-text text-muted">–ù–µ–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ</small>
                        </div>
                    </div>
                </div>

                {{-- –î–µ—Ç–∞–π–ª–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞ --}}
                <div class="card border-warning mt-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0 text-dark"><i class="fas fa-clipboard-list mr-2"></i>–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–°—Ç–∞—Ç—É—Å <span class="text-danger">*</span></label>
                                    <select name="status" class="form-control" required
                                            style="border-color: #f6c23e;">
                                        <option value="draft" class="text-secondary">üìù –ß–µ—Ä–Ω–æ–≤–∞</option>
                                        <option value="open" class="text-info" selected>üîì –û—Ç–≤–æ—Ä–µ–Ω–∞</option>
                                        <option value="in_progress" class="text-warning">‚öôÔ∏è –í –ø—Ä–æ–≥—Ä–µ—Å</option>
                                        <option value="completed" class="text-success">‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω–∞</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞–Ω–µ</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="datetime-local" name="received_at" class="form-control" 
                                               value="{{ now()->format('Y-m-d\TH:i') }}"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–ü—Ä–æ–±–µ–≥ (km)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-tachometer-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="number" name="km_on_receive" class="form-control" 
                                               min="0" placeholder="0" id="vehicleMileage"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–û—á–∞–∫–≤–∞–Ω–∞ –¥–∞—Ç–∞</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-check text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="date" name="estimated_completion" class="form-control" 
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-2">
                            <label class="font-weight-bold text-dark">
                                <i class="fas fa-sticky-note mr-1"></i>–ë–µ–ª–µ–∂–∫–∏
                            </label>
                            <textarea name="notes" class="form-control" rows="2" 
                                      placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –±–µ–ª–µ–∂–∫–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞..."
                                      style="border-color: #dddfeb;"></textarea>
                        </div>
                    </div>
                </div>

                {{-- –î–∏–Ω–∞–º–∏—á–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ --}}
                <div class="card border-info mt-4">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-list-alt mr-2"></i>–ü–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ—Ä—ä—á–∫–∞—Ç–∞
                            <span class="badge badge-light ml-2" id="itemsCount">0 –ø–æ–∑–∏—Ü–∏–∏</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="itemsTable">
                                <thead class="bg-light">
                                    <tr>
                                        <th width="5%">‚Ññ</th>
                                        <th width="25%">–ü—Ä–æ–¥—É–∫—Ç/–£—Å–ª—É–≥–∞</th>
                                        <th width="25%">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        <th width="10%">–ö–æ–ª-–≤–æ</th>
                                        <th width="10%">–¶–µ–Ω–∞ –±–µ–∑ –î–î–°</th>
                                        <th width="10%">–î–î–° %</th>
                                        <th width="10%">–û–±—â–æ</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot class="bg-light">
                                    <tr>
                                        <td colspan="7" class="text-right font-weight-bold">–û–±—â–æ –ø–æ–∑–∏—Ü–∏–∏:</td>
                                        <td class="font-weight-bold" id="itemsCountFooter">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <button type="button" id="addRow" class="btn btn-success btn-sm">
                                <i class="fas fa-box mr-1"></i> –î–æ–±–∞–≤–∏ –ø—Ä–æ–¥—É–∫—Ç
                            </button>
                            <button type="button" id="addServiceRow" class="btn btn-primary btn-sm">
                                <i class="fas fa-tools mr-1"></i> –î–æ–±–∞–≤–∏ —É—Å–ª—É–≥–∞
                            </button>
                            <button type="button" id="addQuickService" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-bolt mr-1"></i> –ë—ä—Ä–∑–∞ —É—Å–ª—É–≥–∞
                            </button>
                        </div>
                    </div>
                </div>

                {{-- –°—É–º–∏ --}}
                <div class="row mt-4">
                    <div class="col-md-5 offset-md-7">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-calculator mr-2"></i>–û–±—â–æ —Å—É–º–∏</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <th class="text-right">–û–±—â–æ –±–µ–∑ –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-primary" id="totalWithoutVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">–î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-warning" id="totalVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr class="border-top">
                                        <th class="text-right h5">–û–±—â–æ —Å –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h3 font-weight-bold text-success" id="grandTotal">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                {{-- –ë—É—Ç–æ–Ω–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ --}}
                <div class="mt-4 d-flex justify-content-end gap-3">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save mr-2"></i> –ó–∞–ø–∞–∑–∏ –ø–æ—Ä—ä—á–∫–∞
                    </button>
                    <button type="submit" name="action" value="save_and_print" class="btn btn-primary btn-lg">
                        <i class="fas fa-print mr-2"></i> –ó–∞–ø–∞–∑–∏ –∏ –æ—Ç–ø–µ—á–∞—Ç–∞–π
                    </button>
                    <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-times mr-2"></i> –û—Ç–∫–∞–∑
                    </a>
                </div>
            </form>
        </div>
    </div>
@stop

@push('css')
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    <style>
        .select2-container--bootstrap .select2-selection {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .select2-container--bootstrap .select2-selection:focus {
            border-color: #1cc88a;
            box-shadow: 0 0 0 0.2rem rgba(28, 200, 138, 0.25);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(28, 200, 138, 0.05);
        }
        .card-header {
            border-radius: 0.35rem 0.35rem 0 0 !important;
        }
        .input-group-text {
            background-color: #f8f9fc;
            border: 1px solid #d1d3e2;
        }
        .badge {
            font-size: 0.8em;
            padding: 0.35em 0.65em;
        }
        .list-group-item:hover {
            background-color: #1cc88a !important;
            color: white !important;
            cursor: pointer;
        }
        .list-group-item .customer-badge {
            font-size: 0.75em;
        }
        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        #customerInfo, #vehicleInfo {
            border-left: 4px solid #1cc88a;
        }
    </style>
@endpush

@push('js')
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/bg.js"></script>
    <script>
        $(function () {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $('.select2').select2({
                theme: 'bootstrap',
                language: 'bg',
                width: '100%',
                allowClear: true
            });

            // –ì–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
            let searchTimeout;
            $('#globalSearch').on('input', function() {
                clearTimeout(searchTimeout);
                const query = $(this).val().trim();
                
                if (query.length < 2) {
                    $('#searchResults').hide().empty();
                    return;
                }
                
                searchTimeout = setTimeout(function() {
                    performGlobalSearch(query);
                }, 300);
            });

            // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#clearSearch').click(function() {
                $('#globalSearch').val('');
                $('#searchResults').hide().empty();
            });

            // –ó–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –ø—Ä–∏ –∫–ª–∏–∫ –∏–∑–≤—ä–Ω —Ç—è—Ö
            $(document).click(function(e) {
                if (!$(e.target).closest('#globalSearch, #searchResults').length) {
                    $('#searchResults').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∫–ª–∏–µ–Ω—Ç
            $('#customer_id').change(function () {
                const customerId = $(this).val();
                loadCustomerVehicles(customerId);
                
                // –ê–∫–æ –∏–º–∞ –∏–∑–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç, –ø–æ–∫–∞–∂–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –º—É
                if (customerId) {
                    loadCustomerInfo(customerId);
                } else {
                    $('#customerInfo').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
            $('#vehicle_id').change(function () {
                const vehicleId = $(this).val();
                if (vehicleId) {
                    loadVehicleInfo(vehicleId);
                } else {
                    $('#vehicleInfo').hide();
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –≥–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
        function performGlobalSearch(query) {
            $.ajax({
                url: "{{ route('admin.api.search.customer-vehicle') }}",
                method: 'GET',
                data: { q: query },
                beforeSend: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border spinner-border-sm text-primary mr-2"></div>
                                <span>–¢—ä—Ä—Å–µ–Ω–µ...</span>
                            </div>
                        </div>
                    `).show();
                },
                success: function(data) {
                    if (data.customers.length === 0 && data.vehicles.length === 0) {
                        $('#searchResults').html(`
                            <div class="list-group-item text-muted">
                                <i class="fas fa-search mr-2"></i>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
                            </div>
                        `).show();
                        return;
                    }

                    let html = '';
                    
                    // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
                    if (data.customers && data.customers.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ö–ª–∏–µ–Ω—Ç–∏</div>`;
                        data.customers.forEach(customer => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="customer" 
                                     data-id="${customer.id}"
                                     data-name="${customer.name}"
                                     data-phone="${customer.phone || ''}"
                                     data-email="${customer.email || ''}"
                                     data-address="${customer.address || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-user text-primary mr-2"></i>
                                            <strong>${highlightText(customer.name, query)}</strong>
                                        </div>
                                        <span class="badge badge-primary customer-badge">–ö–ª–∏–µ–Ω—Ç</span>
                                    </div>
                                    ${customer.phone ? `<small class="text-muted d-block mt-1"><i class="fas fa-phone mr-1"></i>${highlightText(customer.phone, query)}</small>` : ''}
                                    ${customer.email ? `<small class="text-muted d-block"><i class="fas fa-envelope mr-1"></i>${highlightText(customer.email, query)}</small>` : ''}
                                    <small class="text-muted d-block">${customer.vehicles_count || 0} –∞–≤—Ç–æ–º–æ–±–∏–ª–∞</small>
                                </div>
                            `;
                        });
                    }

                    if (data.vehicles && data.vehicles.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>`;
                        data.vehicles.forEach(vehicle => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="vehicle" 
                                     data-id="${vehicle.id}"
                                     data-customer-id="${vehicle.customer_id}"
                                     data-plate="${vehicle.plate}"
                                     data-make="${vehicle.make || ''}"
                                     data-model="${vehicle.model || ''}"
                                     data-year="${vehicle.year || ''}"
                                     data-engine="${vehicle.engine || ''}"
                                     data-vin="${vehicle.vin || ''}"
                                     data-mileage="${vehicle.current_mileage || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-car text-success mr-2"></i>
                                            <strong>${highlightText(vehicle.plate, query)}</strong>
                                        </div>
                                        <span class="badge badge-success customer-badge">–ê–≤—Ç–æ–º–æ–±–∏–ª</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        ${vehicle.make || ''} ${vehicle.model || ''} ${vehicle.year ? `(${vehicle.year})` : ''}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-user mr-1"></i>${vehicle.customer?.name || '–ù—è–º–∞ –∫–ª–∏–µ–Ω—Ç'}
                                    </small>
                                </div>
                            `;
                        });
                    }

                    $('#searchResults').html(html).show();
                    
                    // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ event listener –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç
                    $('.list-group-item[data-type]').click(function() {
                        selectSearchResult($(this));
                    });
                },
                error: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item text-danger">
                            <i class="fas fa-exclamation-circle mr-2"></i>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
                        </div>
                    `).show();
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ—Å–≤–µ—Ç—è–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ
        function highlightText(text, query) {
            if (!query || !text) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.toString().replace(regex, '<span class="search-highlight">$1</span>');
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –æ—Ç —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
        function selectSearchResult($element) {
            const type = $element.data('type');
            
            if (type === 'customer') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
                $('#customer_id').val($element.data('id')).trigger('change');
                $('#customerInfo').html(`
                    <small>
                        <i class="fas fa-user text-success mr-1"></i>
                        <strong>${$element.data('name')}</strong><br>
                        ${$element.data('phone') ? `<i class="fas fa-phone text-success mr-1"></i>${$element.data('phone')}<br>` : ''}
                        ${$element.data('email') ? `<i class="fas fa-envelope text-success mr-1"></i>${$element.data('email')}` : ''}
                    </small>
                `).show();
                
                // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                loadCustomerVehicles($element.data('id'));
                
            } else if (type === 'vehicle') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª –∏ –Ω–µ–≥–æ–≤–∏—è –∫–ª–∏–µ–Ω—Ç
                $('#vehicle_id').val($element.data('id')).trigger('change');
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∞
                $('#vehicleInfo').html(`
                    <small>
                        <i class="fas fa-car text-success mr-1"></i>
                        <strong>${$element.data('make')} ${$element.data('model')}</strong><br>
                        <i class="fas fa-hashtag text-success mr-1"></i>
                        –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${$element.data('plate')}</strong><br>
                        ${$element.data('year') ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${$element.data('year')}<br>` : ''}
                        ${$element.data('engine') ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${$element.data('engine')}<br>` : ''}
                        ${$element.data('mileage') ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${$element.data('mileage')} –∫–º` : ''}
                    </small>
                `).show();
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞
                if ($element.data('mileage')) {
                    $('#vehicleMileage').val($element.data('mileage'));
                }
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                if ($element.data('customerId')) {
                    $('#customer_id').val($element.data('customerId')).trigger('change');
                }
            }
            
            // –°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –∏ –∏–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#searchResults').hide().empty();
            $('#globalSearch').val('');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerVehicles(customerId) {
            if (!customerId) {
                $('#vehicle_id').html('<option value=""></option>').prop('disabled', true).trigger('change');
                return;
            }
            
            $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
            
            $.get("{{ route('admin.api.customer-vehicles', '') }}/" + customerId, function (data) {
                let html = '<option value=""></option>';
                if (data.length > 0) {
                    $.each(data, function (i, v) {
                        html += `<option value="${v.id}">${v.plate} - ${v.make} ${v.model} (${v.year || '?'})</option>`;
                    });
                } else {
                    html = '<option value="">–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</option>';
                }
                $('#vehicle_id').html(html).prop('disabled', false).trigger('change');
            }).fail(function() {
                $('#vehicle_id').html('<option value="">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</option>').prop('disabled', false);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerInfo(customerId) {
            $.get("{{ route('admin.api.customer-info', '') }}/" + customerId, function (data) {
                if (data) {
                    $('#customerInfo').html(`
                        <small>
                            <i class="fas fa-user text-success mr-1"></i>
                            <strong>${data.name}</strong><br>
                            ${data.phone ? `<i class="fas fa-phone text-success mr-1"></i>${data.phone}<br>` : ''}
                            ${data.email ? `<i class="fas fa-envelope text-success mr-1"></i>${data.email}<br>` : ''}
                            ${data.address ? `<i class="fas fa-map-marker-alt text-success mr-1"></i>${data.address}` : ''}
                        </small>
                    `).show();
                }
            }).fail(function() {
                $('#customerInfo').hide();
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        function loadVehicleInfo(vehicleId) {
            $.get("{{ route('admin.api.vehicle-info', '') }}/" + vehicleId, function (data) {
                if (data) {
                    $('#vehicleInfo').html(`
                        <small>
                            <i class="fas fa-car text-success mr-1"></i>
                            <strong>${data.make} ${data.model}</strong><br>
                            <i class="fas fa-hashtag text-success mr-1"></i>
                            –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${data.plate}</strong><br>
                            ${data.year ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${data.year}<br>` : ''}
                            ${data.engine ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${data.engine}<br>` : ''}
                            ${data.vin ? `<i class="fas fa-barcode text-success mr-1"></i>VIN: ${data.vin}<br>` : ''}
                            ${data.current_mileage ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${data.current_mileage} –∫–º` : ''}
                        </small>
                    `).show();
                    
                    // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–∞
                    if (data.current_mileage) {
                        $('#vehicleMileage').val(data.current_mileage);
                    }
                }
            }).fail(function() {
                $('#vehicleInfo').hide();
            });
        }

        // =============== –§—É–Ω–∫—Ü–∏–∏ –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ ===============
        let rowIdx = 0;

        function calcLine(row) {
            const qty   = parseFloat(row.find('.qty').val()) || 0;
            const price = parseFloat(row.find('.price').val()) || 0;
            const vat   = parseFloat(row.find('.vat').val()) || 0;
            const line  = qty * price;
            const vatAm = line * vat / 100;
            row.find('.lineTotal').text((line + vatAm).toFixed(2));
            calcTotals();
            updateItemsCount();
        }

        function calcTotals() {
            let totalWithout = 0, totalVat = 0;
            $('#itemsTable tbody tr').each(function () {
                const qty   = parseFloat($(this).find('.qty').val()) || 0;
                const price = parseFloat($(this).find('.price').val()) || 0;
                const vat   = parseFloat($(this).find('.vat').val()) || 0;
                const line  = qty * price;
                totalWithout += line;
                totalVat     += line * vat / 100;
            });
            $('#totalWithoutVat').text(totalWithout.toFixed(2));
            $('#totalVat').text(totalVat.toFixed(2));
            $('#grandTotal').text((totalWithout + totalVat).toFixed(2));
        }

        function updateItemsCount() {
            const count = $('#itemsTable tbody tr').length;
            $('#itemsCount').text(count + ' –ø–æ–∑–∏—Ü–∏–∏');
            $('#itemsCountFooter').text(count);
        }

        function addRow(productType = 'product', predefinedProduct = null) {
            rowIdx++;
            const isService = productType === 'service';
            
            let productOptions = '<option value=""></option>';
            @if(isset($products) && $products->count())
                @foreach($products as $p)
                    productOptions += `
                        <option value="{{ $p->id }}" 
                                data-price="{{ $p->price }}" 
                                data-vat="{{ $p->vat_percent }}"
                                data-type="${isService ? 'service' : 'product'}">
                            {{ $p->sku }} - {{ $p->name }}
                        </option>`;
                @endforeach
            @endif

            const html = `
                <tr id="R${rowIdx}" class="${isService ? 'table-info' : ''}">
                    <td class="align-middle">${rowIdx}</td>
                    <td>
                        <select name="items[${rowIdx}][product_id]" class="form-control product-select" 
                                style="width:100%" data-type="${productType}">
                            ${productOptions}
                        </select>
                    </td>
                    <td>
                        <input type="text" name="items[${rowIdx}][description]" 
                               class="form-control" placeholder="${isService ? '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞' : '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∞'}" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][quantity]" 
                               class="form-control qty" min="0.01" step="0.01" value="1" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][unit_price]" 
                               class="form-control price" min="0.01" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][vat_percent]" 
                               class="form-control vat" min="0" max="100" step="0.01" value="20" required>
                    </td>
                    <td class="align-middle lineTotal font-weight-bold">0.00</td>
                    <td class="align-middle">
                        <button type="button" class="btn btn-sm btn-danger removeRow" title="–ü—Ä–µ–º–∞—Ö–Ω–∏">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            
            $('#itemsTable tbody').append(html);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $(`#R${rowIdx} .product-select`).select2({
                theme: 'bootstrap',
                language: 'bg',
                placeholder: `–ò–∑–±–µ—Ä–µ—Ç–µ ${isService ? '—É—Å–ª—É–≥–∞' : '–ø—Ä–æ–¥—É–∫—Ç'}`,
                allowClear: true
            });
            
            // –ê–∫–æ –∏–º–∞ predefined –ø—Ä–æ–¥—É–∫—Ç, –∏–∑–±–µ—Ä–∏ –≥–æ
            if (predefinedProduct) {
                $(`#R${rowIdx} .product-select`).val(predefinedProduct.id).trigger('change');
                $(`#R${rowIdx} .price`).val(predefinedProduct.price);
                $(`#R${rowIdx} .vat`).val(predefinedProduct.vat_percent || 20);
                $(`#R${rowIdx} input[name*="description"]`).val(predefinedProduct.name);
                calcLine($(`#R${rowIdx}`));
            }
            
            updateItemsCount();
        }

        // Event Listeners –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
        $(document)
            .on('click', '#addRow', () => addRow('product'))
            .on('click', '#addServiceRow', () => addRow('service'))
            .on('click', '#addQuickService', () => {
                addRow('service', {
                    id: 'quick_service',
                    name: '–ë—ä—Ä–∑ —Ä–µ–º–æ–Ω—Ç',
                    price: 50,
                    vat_percent: 20
                });
            })
            .on('click', '.removeRow', function () {
                $(this).closest('tr').remove();
                calcTotals();
                updateItemsCount();
                renumberRows();
            })
            .on('change keyup', '.qty, .price, .vat', function () {
                calcLine($(this).closest('tr'));
            })
            .on('change', '.product-select', function () {
                const option = $(this).find(':selected');
                const row = $(this).closest('tr');
                const price = option.data('price');
                const vat = option.data('vat');
                
                if (price) row.find('.price').val(price);
                if (vat) row.find('.vat').val(vat);
                
                if (option.text() && !row.find('input[name*="description"]').val()) {
                    row.find('input[name*="description"]').val(option.text().split(' - ')[1] || option.text());
                }
                
                calcLine(row);
                const type = option.data('type');
                row.removeClass('table-info table-warning').addClass(type === 'service' ? 'table-warning' : '');
            });

        // –ü—Ä–µ–Ω–æ–º–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–¥–æ–≤–µ —Å–ª–µ–¥ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ
        function renumberRows() {
            $('#itemsTable tbody tr').each(function(index) {
                $(this).find('td:first').text(index + 1);
                $(this).attr('id', 'R' + (index + 1));
                // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –∏–º–µ–Ω–∞—Ç–∞ –Ω–∞ –ø–æ–ª–µ—Ç–∞—Ç–∞
                $(this).find('[name*="items"]').each(function() {
                    const name = $(this).attr('name');
                    $(this).attr('name', name.replace(/items\[\d+\]/, `items[${index + 1}]`));
                });
            });
            rowIdx = $('#itemsTable tbody tr').length;
        }

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—ä—Ä–≤–∏ —Ä–µ–¥ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        $(document).ready(function() {
            addRow('product');
        });
    </script>
@endpush
–ü—Ä–æ–º–µ–Ω–∏—Ç–µ, –∫–æ–∏—Ç–æ –Ω–∞–ø—Ä–∞–≤–∏—Ö:
–ü—Ä–µ–º–∞—Ö–Ω–∞—Ö is_service –∫–æ–ª–æ–Ω–∞—Ç–∞ –æ—Ç –∑–∞—è–≤–∫–∏—Ç–µ –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏

–ü—Ä–æ–º–µ–Ω–∏—Ö —Ä–µ–¥–∞ –Ω–∞ —Å–æ—Ä—Ç–∏—Ä–∞–Ω–µ –æ—Ç orderBy('is_service') –Ω–∞ –ø—Ä–æ—Å—Ç–æ orderBy('name')

–ö–æ—Ä–∏–≥–∏—Ä–∞—Ö JavaScript –∫–æ–¥–∞ –¥–∞ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–≤–∞ –∑–∞ is_service, —Ç—ä–π –∫–∞—Ç–æ —Ç–∞–∑–∏ –∫–æ–ª–æ–Ω–∞ –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞

–ó–∞–¥–∞–¥–æ—Ö –≤—Ä–µ–º–µ–Ω–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç 'is_service' => false –≤ productsAutocomplete –º–µ—Ç–æ–¥–∞

–ê–∫–æ –∏—Å–∫–∞—à –¥–∞ –¥–æ–±–∞–≤–∏—à —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏ –∏ —É—Å–ª—É–≥–∏ –≤ –±—ä–¥–µ—â–µ, —â–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä–∑–¥–∞–¥–µ—à –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–æ–ª–æ–Ω–∞—Ç–∞ is_service –≤ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ products:

php
// –°—ä–∑–¥–∞–π –º–∏–≥—Ä–∞—Ü–∏—è: php artisan make:migration add_is_service_to_products_table
public function up()
{
    Schema::table('products', function (Blueprint $table) {
        $table->boolean('is_service')->default(false)->after('vat_percent');
    });
}
–°–µ–≥–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏ –±–µ–∑ –≥—Ä–µ—à–∫–∏!

–ö–∞–∫–≤–æ —Å—Ç–∞–≤–∞? ... Internal Server Error

Copy as Markdown
Symfony\Component\Routing\Exception\RouteNotFoundException
vendor\laravel\framework\src\Illuminate\Routing\UrlGenerator.php:526
Route [admin.api.customer-vehicles] not defined.

LARAVEL
12.39.0
PHP
8.2.12
UNHANDLED
CODE 0
500
GET
http://localhost/admin/work-orders/create

Exception trace
2 vendor frames

resources\views\admin\work-orders\create.blade.php
resources\views\admin\work-orders\create.blade.php:588

583                return;
584            }
585            
586            $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
587            
588            $.get("{{ route('admin.api.customer-vehicles', '') }}/" + customerId, function (data) {
589                let html = '<option value=""></option>';
590                if (data.length > 0) {
591                    $.each(data, function (i, v) {
592                        html += `<option value="${v.id}">${v.plate} - ${v.make} ${v.model} (${v.year || '?'})</option>`;
593                    });
594                } else {
595                    html = '<option value="">–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</option>';
596                }
597                $('#vehicle_id').html(html).prop('disabled', false).trigger('change');
598            }).fail(function() {
599                $('#vehicle_id').html('<option value="">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</option>').prop('disabled', false);
600
59 vendor frames

public\index.php
public\index.php:20

Queries
1-6 of 6
mysql
select * from `sessions` where `id` = 'fYXeTEcQitn9OHIfFyumO2OPHG0UMw5aqZ80ofeu' limit 1
5.37ms
mysql
select * from `users` where `id` = 1 and `users`.`deleted_at` is null limit 1
0.84ms
mysql
select `name`, `id` from `customers` where `customers`.`deleted_at` is null
0.7ms
mysql
select * from `roles` where `name` = 'mechanic' and `guard_name` = 'web' limit 1
0.73ms
mysql
select `name`, `id` from `users` where exists (select * from `roles` inner join `model_has_roles` on `roles`.`id` = `model_has_roles`.`role_id` where `users`.`id` = `model_has_roles`.`model_id` and `model_has_roles`.`model_type` = 'App\Models\User' and `roles`.`id` in (3)) and `users`.`deleted_at` is null
0.91ms
mysql
select `id`, `sku`, `name`, `price`, `vat_percent` from `products` where `products`.`deleted_at` is null order by `name` asc
.... –ò–º–∞—à –ª–∏ –Ω—É–∂–¥–∞ –¥–∞ —Ç–∏ –ø–æ–¥–∞–º –Ω—è–∫–æ–π —Ñ–∞–π–ª?
–î–∞, –ø–æ–¥–∞–π –º–∏ routes/web.php —Ñ–∞–π–ª–∞! –ü—Ä–æ–±–ª–µ–º—ä—Ç –µ, —á–µ –º–∞—Ä—à—Ä—É—Ç—ä—Ç admin.api.customer-vehicles –Ω–µ –µ –¥–µ—Ñ–∏–Ω–∏—Ä–∞–Ω. –í–µ—Ä–æ—è—Ç–Ω–æ –≤ web.php –∏–º–∞—à –Ω—è–∫–∞–∫–≤–∞ –≥—Ä–µ—à–∫–∞ –≤ –¥–µ—Ñ–∏–Ω–∏—Ü–∏—è—Ç–∞ –Ω–∞ API –º–∞—Ä—à—Ä—É—Ç–∏—Ç–µ.

–°—ä—â–æ —Ç–∞–∫–∞, –ø–æ–¥–∞–π –º–∏ –∏ app/Http/Controllers/Admin/WorkOrderController.php, –∑–∞ –¥–∞ –ø—Ä–æ–≤–µ—Ä—è –¥–∞–ª–∏ –º–µ—Ç–æ–¥–∏—Ç–µ —Å–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ –¥–µ—Ñ–∏–Ω–∏—Ä–∞–Ω–∏.

–ü—Ä–æ–±–ª–µ–º—ä—Ç –µ –≤ –º–∞—Ä—à—Ä—É—Ç–∏—Ç–µ. –û—á–∞–∫–≤–∞–º –¥–∞ –≤–∏–∂–¥–∞ –Ω–µ—â–æ –ø–æ–¥–æ–±–Ω–æ –≤ web.php:

php
Route::prefix('api')->name('api.')->group(function () {
    Route::get('customer-vehicles/{customer}', [WorkOrderController::class, 'customerVehicles'])
        ->name('customer-vehicles');
    // ... –¥—Ä—É–≥–∏ –º–∞—Ä—à—Ä—É—Ç–∏
});
–ù–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –≤–∏–¥—è —Ç–≤–æ—è —Ñ–∞–π–ª, –∑–∞ –¥–∞ —Ä–∞–∑–±–µ—Ä–∞ –∫—ä–¥–µ –µ –≥—Ä–µ—à–∫–∞—Ç–∞.

<?php

use App\Http\Controllers\ProfileController;
use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
*/

Route::get('/', fn() => redirect()->route('login'));

Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware(['auth', 'verified'])->name('dashboard');

/* --------------------------------------------------------------------------
   –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å –ø—Ä–∞–≤–∞)
--------------------------------------------------------------------------*/
Route::middleware(['auth', 'verified'])->prefix('admin')->name('admin.')->group(function () {

    /* --- –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å–∞–º–æ admin) --- */
    Route::middleware(['can:admin'])->group(function () {
        Route::resource('users',       \App\Http\Controllers\Admin\UserController::class);
        Route::resource('roles',       \App\Http\Controllers\Admin\RoleController::class);
        Route::resource('permissions', \App\Http\Controllers\Admin\PermissionController::class);
    });

    /* --- –û–°–ù–û–í–ù–ò –ú–û–î–£–õ–ò --- */
    Route::resource('customers',   \App\Http\Controllers\Admin\CustomerController::class);
    Route::resource('vehicles',    \App\Http\Controllers\Admin\VehicleController::class);
    Route::resource('products',    \App\Http\Controllers\Admin\ProductController::class);
    Route::resource('work-orders', \App\Http\Controllers\Admin\WorkOrderController::class);
    Route::resource('invoices',    \App\Http\Controllers\Admin\InvoiceController::class);

    /* --- EXPORT-–∏ –∑–∞ Customer --- */
    Route::get('customers/{customer}/export/pdf', [\App\Http\Controllers\Admin\CustomerController::class, 'exportPdf'])
        ->name('customers.export.pdf');
    Route::get('customers/{customer}/export/excel', [\App\Http\Controllers\Admin\CustomerController::class, 'exportExcel'])
        ->name('customers.export.excel');
    Route::get('customers/{customer}/export/csv', [\App\Http\Controllers\Admin\CustomerController::class, 'exportCsv'])
        ->name('customers.export.csv');

    /* --- EXPORT-–∏ –∑–∞ Vehicle --- */
    Route::get('vehicles/{vehicle}/export/pdf', [\App\Http\Controllers\Admin\VehicleController::class, 'exportPdf'])->name('vehicles.export.pdf');
    Route::get('vehicles/{vehicle}/export/excel', [\App\Http\Controllers\Admin\VehicleController::class, 'exportExcel'])->name('vehicles.export.excel');
    Route::get('vehicles/{vehicle}/export/csv', [\App\Http\Controllers\Admin\VehicleController::class, 'exportCsv'])->name('vehicles.export.csv');

    /* --- –°–ö–õ–ê–î --- */
    Route::prefix('stock')->name('stock.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\StockController::class, 'index'])->name('index');
        Route::get('/create-purchase', [\App\Http\Controllers\Admin\StockController::class, 'createPurchase'])->name('create-purchase');
        Route::post('/store-purchase', [\App\Http\Controllers\Admin\StockController::class, 'storePurchase'])->name('store-purchase');
        Route::get('/create-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'createAdjustment'])->name('create-adjustment');
        Route::post('/store-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'storeAdjustment'])->name('store-adjustment');
    });

    /* --- –ü–õ–ê–©–ê–ù–ò–Ø --- */
    Route::prefix('payments')->name('payments.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\PaymentController::class, 'index'])->name('index');
        Route::get('/create', [\App\Http\Controllers\Admin\PaymentController::class, 'create'])->name('create');
        Route::post('/store', [\App\Http\Controllers\Admin\PaymentController::class, 'store'])->name('store');
        Route::get('/{payment}/pdf', [\App\Http\Controllers\Admin\PaymentController::class, 'pdf'])->name('pdf');
    });

    /* --- –ë–ê–†–ö–û–î / PLU --- */
    Route::get('barcode/{code}.png', function (string $code) {
        return response(\App\Support\BarcodeHelper::png($code))->header('Content-Type', 'image/png');
    })->name('barcode.png');

    Route::get('products/{product}/barcode', [\App\Http\Controllers\Admin\ProductController::class, 'barcode'])
        ->name('products.barcode');

    Route::get('api/product-by-sku/{sku}', function (string $sku) {
        return \App\Models\Product::where('sku', $sku)->first() ?? [];
    })->name('api.product-by-sku');

    /* --- AJAX --- */
    Route::get('api/customer-vehicles/{customer}', function (\App\Models\Customer $customer) {
        return $customer->vehicles()->select('id', 'plate', 'make', 'model')->get();
    })->name('api.customer-vehicles');

    /* --- PDF --- */
    Route::get('work-orders/{workOrder}/pdf', [\App\Http\Controllers\Admin\WorkOrderController::class, 'pdf'])
        ->name('work-orders.pdf');
});

require __DIR__ . '/auth.php';
–í–∏–∂–¥–∞–º –ø—Ä–æ–±–ª–µ–º–∞! –í web.php –∏–º–∞—à —Å–∞–º–æ –ï–î–ò–ù api/customer-vehicles –º–∞—Ä—à—Ä—É—Ç –∏ —Ç–æ–π –µ –¥–µ—Ñ–∏–Ω–∏—Ä–∞–Ω –∫–∞—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, –∞ –Ω–µ –∫–∞—Ç–æ –º–µ—Ç–æ–¥ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞. –ï—Ç–æ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω–∏—è web.php —Ñ–∞–π–ª:

php
<?php

use App\Http\Controllers\ProfileController;
use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
*/

Route::get('/', fn() => redirect()->route('login'));

Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware(['auth', 'verified'])->name('dashboard');

/* --------------------------------------------------------------------------
   –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å –ø—Ä–∞–≤–∞)
--------------------------------------------------------------------------*/
Route::middleware(['auth', 'verified'])->prefix('admin')->name('admin.')->group(function () {

    /* --- –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å–∞–º–æ admin) --- */
    Route::middleware(['can:admin'])->group(function () {
        Route::resource('users',       \App\Http\Controllers\Admin\UserController::class);
        Route::resource('roles',       \App\Http\Controllers\Admin\RoleController::class);
        Route::resource('permissions', \App\Http\Controllers\Admin\PermissionController::class);
    });

    /* --- –û–°–ù–û–í–ù–ò –ú–û–î–£–õ–ò --- */
    Route::resource('customers',   \App\Http\Controllers\Admin\CustomerController::class);
    Route::resource('vehicles',    \App\Http\Controllers\Admin\VehicleController::class);
    Route::resource('products',    \App\Http\Controllers\Admin\ProductController::class);
    Route::resource('work-orders', \App\Http\Controllers\Admin\WorkOrderController::class);
    Route::resource('invoices',    \App\Http\Controllers\Admin\InvoiceController::class);

    /* --- EXPORT-–∏ –∑–∞ Customer --- */
    Route::get('customers/{customer}/export/pdf', [\App\Http\Controllers\Admin\CustomerController::class, 'exportPdf'])
        ->name('customers.export.pdf');
    Route::get('customers/{customer}/export/excel', [\App\Http\Controllers\Admin\CustomerController::class, 'exportExcel'])
        ->name('customers.export.excel');
    Route::get('customers/{customer}/export/csv', [\App\Http\Controllers\Admin\CustomerController::class, 'exportCsv'])
        ->name('customers.export.csv');

    /* --- EXPORT-–∏ –∑–∞ Vehicle --- */
    Route::get('vehicles/{vehicle}/export/pdf', [\App\Http\Controllers\Admin\VehicleController::class, 'exportPdf'])->name('vehicles.export.pdf');
    Route::get('vehicles/{vehicle}/export/excel', [\App\Http\Controllers\Admin\VehicleController::class, 'exportExcel'])->name('vehicles.export.excel');
    Route::get('vehicles/{vehicle}/export/csv', [\App\Http\Controllers\Admin\VehicleController::class, 'exportCsv'])->name('vehicles.export.csv');

    /* --- –°–ö–õ–ê–î --- */
    Route::prefix('stock')->name('stock.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\StockController::class, 'index'])->name('index');
        Route::get('/create-purchase', [\App\Http\Controllers\Admin\StockController::class, 'createPurchase'])->name('create-purchase');
        Route::post('/store-purchase', [\App\Http\Controllers\Admin\StockController::class, 'storePurchase'])->name('store-purchase');
        Route::get('/create-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'createAdjustment'])->name('create-adjustment');
        Route::post('/store-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'storeAdjustment'])->name('store-adjustment');
    });

    /* --- –ü–õ–ê–©–ê–ù–ò–Ø --- */
    Route::prefix('payments')->name('payments.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\PaymentController::class, 'index'])->name('index');
        Route::get('/create', [\App\Http\Controllers\Admin\PaymentController::class, 'create'])->name('create');
        Route::post('/store', [\App\Http\Controllers\Admin\PaymentController::class, 'store'])->name('store');
        Route::get('/{payment}/pdf', [\App\Http\Controllers\Admin\PaymentController::class, 'pdf'])->name('pdf');
    });

    /* --- –ë–ê–†–ö–û–î / PLU --- */
    Route::get('barcode/{code}.png', function (string $code) {
        return response(\App\Support\BarcodeHelper::png($code))->header('Content-Type', 'image/png');
    })->name('barcode.png');

    Route::get('products/{product}/barcode', [\App\Http\Controllers\Admin\ProductController::class, 'barcode'])
        ->name('products.barcode');

    Route::get('api/product-by-sku/{sku}', function (string $sku) {
        return \App\Models\Product::where('sku', $sku)->first() ?? [];
    })->name('api.product-by-sku');

    /* --- AJAX API –∑–∞ Work Orders --- */
    Route::prefix('api')->name('api.')->group(function () {
        // –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ autocomplete
        Route::get('search/customer-vehicle', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
            ->name('search.customer-vehicle');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-info/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerInfo'])
            ->name('customer-info');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        Route::get('vehicle-info/{vehicle}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'vehicleInfo'])
            ->name('vehicle-info');
        
        // –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-vehicles/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerVehicles'])
            ->name('customer-vehicles');
        
        // Autocomplete –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏
        Route::get('products/autocomplete', [\App\Http\Controllers\Admin\WorkOrderController::class, 'productsAutocomplete'])
            ->name('products.autocomplete');
    });

    /* --- –°—Ç–∞—Ä AJAX endpoint –∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç --- */
    Route::get('api/customer-vehicles/{customer}', function (\App\Models\Customer $customer) {
        return $customer->vehicles()->select('id', 'plate', 'make', 'model')->get();
    })->name('api.customer-vehicles.legacy');

    /* --- PDF --- */
    Route::get('work-orders/{workOrder}/pdf', [\App\Http\Controllers\Admin\WorkOrderController::class, 'pdf'])
        ->name('work-orders.pdf');
        
    /* --- –¢—ä—Ä—Å–µ–Ω–µ –∑–∞ Work Orders (–∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç) --- */
    Route::get('work-orders/search', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
        ->name('work-orders.search');
});

require __DIR__ . '/auth.php';
–ü—Ä–æ–º–µ–Ω–∏—Ç–µ, –∫–æ–∏—Ç–æ –Ω–∞–ø—Ä–∞–≤–∏—Ö:

–î–æ–±–∞–≤–∏—Ö name('api.') —Å–ª–µ–¥ prefix('api') - —Ç–æ–≤–∞ –µ –∫—Ä–∏—Ç–∏—á–Ω–æ!

–ü—Ä–µ–º–µ—Å—Ç–∏—Ö —Å—Ç–∞—Ä–∏—è AJAX endpoint —Å–ª–µ–¥ –Ω–æ–≤–∏—Ç–µ API –º–∞—Ä—à—Ä—É—Ç–∏ –∏ –≥–æ –ø—Ä–µ–∏–º–µ–Ω—É–≤–∞—Ö –Ω–∞ api.customer-vehicles.legacy

–ù–æ–≤–∏—Ç–µ API –º–∞—Ä—à—Ä—É—Ç–∏ —Å–∞ –≤ –æ—Ç–¥–µ–ª–Ω–∞ –≥—Ä—É–ø–∞ —Å –ø—Ä–∞–≤–∏–ª–Ω–æ—Ç–æ –∏–º–µ–Ω—É–≤–∞–Ω–µ

–°–µ–≥–∞ –º–∞—Ä—à—Ä—É—Ç–∏—Ç–µ —â–µ –±—ä–¥–∞—Ç:

admin.api.search.customer-vehicle

admin.api.customer-info

admin.api.vehicle-info

admin.api.customer-vehicles (–Ω–æ–≤–∏—è –æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞)

admin.api.customer-vehicles.legacy (—Å—Ç–∞—Ä–∏—è —Å —Ñ—É–Ω–∫—Ü–∏—è)

–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–æ, —Ç—Ä—è–±–≤–∞ –¥–∞ –∫–æ—Ä–∏–≥–∏—Ä–∞—à create.blade.php —Ñ–∞–π–ª–∞, –∑–∞ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞ –ø—Ä–∞–≤–∏–ª–Ω–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏. –í JavaScript –∫–æ–¥–∞ –Ω–∞ —Ä–µ–¥ 588 —Ç—Ä—è–±–≤–∞ –¥–∞ –µ:

javascript
$.get("{{ route('admin.api.customer-vehicles', '') }}/" + customerId, function (data) {
–¢–æ–≤–∞ –≤–µ—á–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏, –∑–∞—â–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç—ä—Ç admin.api.customer-vehicles –≤–µ—á–µ –µ –¥–µ—Ñ–∏–Ω–∏—Ä–∞–Ω –≤ API –≥—Ä—É–ø–∞—Ç–∞.

–ó–∞–±–µ–ª–µ–∂–∫–∞: –¢—Ä—è–±–≤–∞ –¥–∞ —Å–µ —É–≤–µ—Ä–∏—à, —á–µ WorkOrderController –∏–º–∞ –º–µ—Ç–æ–¥–∏—Ç–µ search, customerInfo, vehicleInfo, customerVehicles –∏ productsAutocomplete. –ê–∫–æ –≥–∏ –Ω—è–º–∞, —â–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –≥–∏ –¥–æ–±–∞–≤–∏—à –≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞.

–ö–æ–ø–∏—Ä–∞–π —Ç–æ–∑–∏ web.php —Ñ–∞–π–ª –∏ —Ç–µ—Å—Ç–≤–∞–π –æ—Ç–Ω–æ–≤–æ!

–ï—Ç–æ –º–∏ resources\views\admin\work-orders\create.blade.php ... @extends('adminlte::page')

@section('title', '–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="text-primary"><i class="fas fa-file-invoice mr-2"></i>–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞</h1>
        <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left mr-1"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
@stop

@section('content')
    <div class="card border-primary">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-search mr-2"></i>–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ</h4>
        </div>
        <div class="card-body bg-light">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label class="font-weight-bold">–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª:</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-primary"></i>
                                </span>
                            </div>
                            <input type="text" id="globalSearch" class="form-control form-control-lg" 
                                   placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º–µ–π–ª –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä..."
                                   style="border-color: #4e73df;">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="searchResults" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto;">
                            <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —â–µ —Å–µ –ø–æ—è–≤—è—Ç —Ç—É–∫ -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <div class="alert alert-info w-100 mb-0">
                        <small>
                            <i class="fas fa-info-circle mr-1"></i>
                            –¢—ä—Ä—Å–µ—Ç–µ –ø–æ: <strong>–∏–º–µ</strong>, <strong>—Ç–µ–ª–µ—Ñ–æ–Ω</strong>, 
                            <strong>–∏–º–µ–π–ª</strong> –∏–ª–∏ <strong>—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä</strong>.
                            –ò–∑–±–µ—Ä–µ—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-success mt-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-user-circle mr-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</h4>
        </div>
        <div class="card-body">
            <form action="{{ route('admin.work-orders.store') }}" method="POST" id="orderForm">
                @csrf
                
                {{-- –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --}}
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ö–ª–∏–µ–Ω—Ç <span class="text-danger">*</span></label>
                            <select name="customer_id" id="customer_id" class="form-control select2" 
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç" required
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($customers as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <div id="customerInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-user text-success mr-1"></i>
                                    <span id="customerName"></span><br>
                                    <i class="fas fa-phone text-success mr-1"></i>
                                    <span id="customerPhone"></span><br>
                                    <i class="fas fa-envelope text-success mr-1"></i>
                                    <span id="customerEmail"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ê–≤—Ç–æ–º–æ–±–∏–ª <span class="text-danger">*</span></label>
                            <select name="vehicle_id" id="vehicle_id" class="form-control select2" required
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª"
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                            </select>
                            <div id="vehicleInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-car text-success mr-1"></i>
                                    <span id="vehicleMakeModel"></span><br>
                                    <i class="fas fa-hashtag text-success mr-1"></i>
                                    –†–µ–≥. –Ω–æ–º–µ—Ä: <span id="vehiclePlate"></span><br>
                                    <i class="fas fa-calendar text-success mr-1"></i>
                                    –ì–æ–¥–∏–Ω–∞: <span id="vehicleYear"></span><br>
                                    <i class="fas fa-gas-pump text-success mr-1"></i>
                                    –î–≤–∏–≥–∞—Ç–µ–ª: <span id="vehicleEngine"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ú–µ—Ö–∞–Ω–∏–∫</label>
                            <select name="assigned_to" class="form-control select2" 
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($mechanics as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <small class="form-text text-muted">–ù–µ–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ</small>
                        </div>
                    </div>
                </div>

                {{-- –î–µ—Ç–∞–π–ª–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞ --}}
                <div class="card border-warning mt-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0 text-dark"><i class="fas fa-clipboard-list mr-2"></i>–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–°—Ç–∞—Ç—É—Å <span class="text-danger">*</span></label>
                                    <select name="status" class="form-control" required
                                            style="border-color: #f6c23e;">
                                        <option value="draft" class="text-secondary">üìù –ß–µ—Ä–Ω–æ–≤–∞</option>
                                        <option value="open" class="text-info" selected>üîì –û—Ç–≤–æ—Ä–µ–Ω–∞</option>
                                        <option value="in_progress" class="text-warning">‚öôÔ∏è –í –ø—Ä–æ–≥—Ä–µ—Å</option>
                                        <option value="completed" class="text-success">‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω–∞</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞–Ω–µ</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="datetime-local" name="received_at" class="form-control" 
                                               value="{{ now()->format('Y-m-d\TH:i') }}"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–ü—Ä–æ–±–µ–≥ (km)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-tachometer-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="number" name="km_on_receive" class="form-control" 
                                               min="0" placeholder="0" id="vehicleMileage"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–û—á–∞–∫–≤–∞–Ω–∞ –¥–∞—Ç–∞</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-check text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="date" name="estimated_completion" class="form-control" 
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-2">
                            <label class="font-weight-bold text-dark">
                                <i class="fas fa-sticky-note mr-1"></i>–ë–µ–ª–µ–∂–∫–∏
                            </label>
                            <textarea name="notes" class="form-control" rows="2" 
                                      placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –±–µ–ª–µ–∂–∫–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞..."
                                      style="border-color: #dddfeb;"></textarea>
                        </div>
                    </div>
                </div>

                {{-- –î–∏–Ω–∞–º–∏—á–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ --}}
                <div class="card border-info mt-4">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-list-alt mr-2"></i>–ü–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ—Ä—ä—á–∫–∞—Ç–∞
                            <span class="badge badge-light ml-2" id="itemsCount">0 –ø–æ–∑–∏—Ü–∏–∏</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="itemsTable">
                                <thead class="bg-light">
                                    <tr>
                                        <th width="5%">‚Ññ</th>
                                        <th width="25%">–ü—Ä–æ–¥—É–∫—Ç/–£—Å–ª—É–≥–∞</th>
                                        <th width="25%">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        <th width="10%">–ö–æ–ª-–≤–æ</th>
                                        <th width="10%">–¶–µ–Ω–∞ –±–µ–∑ –î–î–°</th>
                                        <th width="10%">–î–î–° %</th>
                                        <th width="10%">–û–±—â–æ</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot class="bg-light">
                                    <tr>
                                        <td colspan="7" class="text-right font-weight-bold">–û–±—â–æ –ø–æ–∑–∏—Ü–∏–∏:</td>
                                        <td class="font-weight-bold" id="itemsCountFooter">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <button type="button" id="addRow" class="btn btn-success btn-sm">
                                <i class="fas fa-box mr-1"></i> –î–æ–±–∞–≤–∏ –ø—Ä–æ–¥—É–∫—Ç
                            </button>
                            <button type="button" id="addServiceRow" class="btn btn-primary btn-sm">
                                <i class="fas fa-tools mr-1"></i> –î–æ–±–∞–≤–∏ —É—Å–ª—É–≥–∞
                            </button>
                            <button type="button" id="addQuickService" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-bolt mr-1"></i> –ë—ä—Ä–∑–∞ —É—Å–ª—É–≥–∞
                            </button>
                        </div>
                    </div>
                </div>

                {{-- –°—É–º–∏ --}}
                <div class="row mt-4">
                    <div class="col-md-5 offset-md-7">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-calculator mr-2"></i>–û–±—â–æ —Å—É–º–∏</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <th class="text-right">–û–±—â–æ –±–µ–∑ –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-primary" id="totalWithoutVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">–î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-warning" id="totalVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr class="border-top">
                                        <th class="text-right h5">–û–±—â–æ —Å –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h3 font-weight-bold text-success" id="grandTotal">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                {{-- –ë—É—Ç–æ–Ω–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ --}}
                <div class="mt-4 d-flex justify-content-end gap-3">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save mr-2"></i> –ó–∞–ø–∞–∑–∏ –ø–æ—Ä—ä—á–∫–∞
                    </button>
                    <button type="submit" name="action" value="save_and_print" class="btn btn-primary btn-lg">
                        <i class="fas fa-print mr-2"></i> –ó–∞–ø–∞–∑–∏ –∏ –æ—Ç–ø–µ—á–∞—Ç–∞–π
                    </button>
                    <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-times mr-2"></i> –û—Ç–∫–∞–∑
                    </a>
                </div>
            </form>
        </div>
    </div>
@stop

@push('css')
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    <style>
        .select2-container--bootstrap .select2-selection {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .select2-container--bootstrap .select2-selection:focus {
            border-color: #1cc88a;
            box-shadow: 0 0 0 0.2rem rgba(28, 200, 138, 0.25);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(28, 200, 138, 0.05);
        }
        .card-header {
            border-radius: 0.35rem 0.35rem 0 0 !important;
        }
        .input-group-text {
            background-color: #f8f9fc;
            border: 1px solid #d1d3e2;
        }
        .badge {
            font-size: 0.8em;
            padding: 0.35em 0.65em;
        }
        .list-group-item:hover {
            background-color: #1cc88a !important;
            color: white !important;
            cursor: pointer;
        }
        .list-group-item .customer-badge {
            font-size: 0.75em;
        }
        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        #customerInfo, #vehicleInfo {
            border-left: 4px solid #1cc88a;
        }
    </style>
@endpush

@push('js')
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/bg.js"></script>
    <script>
        $(function () {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $('.select2').select2({
                theme: 'bootstrap',
                language: 'bg',
                width: '100%',
                allowClear: true
            });

            // –ì–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
            let searchTimeout;
            $('#globalSearch').on('input', function() {
                clearTimeout(searchTimeout);
                const query = $(this).val().trim();
                
                if (query.length < 2) {
                    $('#searchResults').hide().empty();
                    return;
                }
                
                searchTimeout = setTimeout(function() {
                    performGlobalSearch(query);
                }, 300);
            });

            // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#clearSearch').click(function() {
                $('#globalSearch').val('');
                $('#searchResults').hide().empty();
            });

            // –ó–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –ø—Ä–∏ –∫–ª–∏–∫ –∏–∑–≤—ä–Ω —Ç—è—Ö
            $(document).click(function(e) {
                if (!$(e.target).closest('#globalSearch, #searchResults').length) {
                    $('#searchResults').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∫–ª–∏–µ–Ω—Ç
            $('#customer_id').change(function () {
                const customerId = $(this).val();
                loadCustomerVehicles(customerId);
                
                // –ê–∫–æ –∏–º–∞ –∏–∑–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç, –ø–æ–∫–∞–∂–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –º—É
                if (customerId) {
                    loadCustomerInfo(customerId);
                } else {
                    $('#customerInfo').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
            $('#vehicle_id').change(function () {
                const vehicleId = $(this).val();
                if (vehicleId) {
                    loadVehicleInfo(vehicleId);
                } else {
                    $('#vehicleInfo').hide();
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –≥–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
        function performGlobalSearch(query) {
            $.ajax({
                url: "{{ route('admin.api.search.customer-vehicle') }}",
                method: 'GET',
                data: { q: query },
                beforeSend: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border spinner-border-sm text-primary mr-2"></div>
                                <span>–¢—ä—Ä—Å–µ–Ω–µ...</span>
                            </div>
                        </div>
                    `).show();
                },
                success: function(data) {
                    if (data.customers.length === 0 && data.vehicles.length === 0) {
                        $('#searchResults').html(`
                            <div class="list-group-item text-muted">
                                <i class="fas fa-search mr-2"></i>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
                            </div>
                        `).show();
                        return;
                    }

                    let html = '';
                    
                    // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
                    if (data.customers && data.customers.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ö–ª–∏–µ–Ω—Ç–∏</div>`;
                        data.customers.forEach(customer => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="customer" 
                                     data-id="${customer.id}"
                                     data-name="${customer.name}"
                                     data-phone="${customer.phone || ''}"
                                     data-email="${customer.email || ''}"
                                     data-address="${customer.address || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-user text-primary mr-2"></i>
                                            <strong>${highlightText(customer.name, query)}</strong>
                                        </div>
                                        <span class="badge badge-primary customer-badge">–ö–ª–∏–µ–Ω—Ç</span>
                                    </div>
                                    ${customer.phone ? `<small class="text-muted d-block mt-1"><i class="fas fa-phone mr-1"></i>${highlightText(customer.phone, query)}</small>` : ''}
                                    ${customer.email ? `<small class="text-muted d-block"><i class="fas fa-envelope mr-1"></i>${highlightText(customer.email, query)}</small>` : ''}
                                    <small class="text-muted d-block">${customer.vehicles_count || 0} –∞–≤—Ç–æ–º–æ–±–∏–ª–∞</small>
                                </div>
                            `;
                        });
                    }

                    if (data.vehicles && data.vehicles.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>`;
                        data.vehicles.forEach(vehicle => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="vehicle" 
                                     data-id="${vehicle.id}"
                                     data-customer-id="${vehicle.customer_id}"
                                     data-plate="${vehicle.plate}"
                                     data-make="${vehicle.make || ''}"
                                     data-model="${vehicle.model || ''}"
                                     data-year="${vehicle.year || ''}"
                                     data-engine="${vehicle.engine || ''}"
                                     data-vin="${vehicle.vin || ''}"
                                     data-mileage="${vehicle.current_mileage || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-car text-success mr-2"></i>
                                            <strong>${highlightText(vehicle.plate, query)}</strong>
                                        </div>
                                        <span class="badge badge-success customer-badge">–ê–≤—Ç–æ–º–æ–±–∏–ª</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        ${vehicle.make || ''} ${vehicle.model || ''} ${vehicle.year ? `(${vehicle.year})` : ''}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-user mr-1"></i>${vehicle.customer?.name || '–ù—è–º–∞ –∫–ª–∏–µ–Ω—Ç'}
                                    </small>
                                </div>
                            `;
                        });
                    }

                    $('#searchResults').html(html).show();
                    
                    // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ event listener –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç
                    $('.list-group-item[data-type]').click(function() {
                        selectSearchResult($(this));
                    });
                },
                error: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item text-danger">
                            <i class="fas fa-exclamation-circle mr-2"></i>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
                        </div>
                    `).show();
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ—Å–≤–µ—Ç—è–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ
        function highlightText(text, query) {
            if (!query || !text) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.toString().replace(regex, '<span class="search-highlight">$1</span>');
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –æ—Ç —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
        function selectSearchResult($element) {
            const type = $element.data('type');
            
            if (type === 'customer') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
                $('#customer_id').val($element.data('id')).trigger('change');
                $('#customerInfo').html(`
                    <small>
                        <i class="fas fa-user text-success mr-1"></i>
                        <strong>${$element.data('name')}</strong><br>
                        ${$element.data('phone') ? `<i class="fas fa-phone text-success mr-1"></i>${$element.data('phone')}<br>` : ''}
                        ${$element.data('email') ? `<i class="fas fa-envelope text-success mr-1"></i>${$element.data('email')}` : ''}
                    </small>
                `).show();
                
                // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                loadCustomerVehicles($element.data('id'));
                
            } else if (type === 'vehicle') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª –∏ –Ω–µ–≥–æ–≤–∏—è –∫–ª–∏–µ–Ω—Ç
                $('#vehicle_id').val($element.data('id')).trigger('change');
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∞
                $('#vehicleInfo').html(`
                    <small>
                        <i class="fas fa-car text-success mr-1"></i>
                        <strong>${$element.data('make')} ${$element.data('model')}</strong><br>
                        <i class="fas fa-hashtag text-success mr-1"></i>
                        –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${$element.data('plate')}</strong><br>
                        ${$element.data('year') ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${$element.data('year')}<br>` : ''}
                        ${$element.data('engine') ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${$element.data('engine')}<br>` : ''}
                        ${$element.data('mileage') ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${$element.data('mileage')} –∫–º` : ''}
                    </small>
                `).show();
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞
                if ($element.data('mileage')) {
                    $('#vehicleMileage').val($element.data('mileage'));
                }
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                if ($element.data('customerId')) {
                    $('#customer_id').val($element.data('customerId')).trigger('change');
                }
            }
            
            // –°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –∏ –∏–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#searchResults').hide().empty();
            $('#globalSearch').val('');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerVehicles(customerId) {
            if (!customerId) {
                $('#vehicle_id').html('<option value=""></option>').prop('disabled', true).trigger('change');
                return;
            }
            
            $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
            
            $.get("{{ route('admin.api.customer-vehicles', '') }}/" + customerId, function (data) {
                let html = '<option value=""></option>';
                if (data.length > 0) {
                    $.each(data, function (i, v) {
                        html += `<option value="${v.id}">${v.plate} - ${v.make} ${v.model} (${v.year || '?'})</option>`;
                    });
                } else {
                    html = '<option value="">–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</option>';
                }
                $('#vehicle_id').html(html).prop('disabled', false).trigger('change');
            }).fail(function() {
                $('#vehicle_id').html('<option value="">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</option>').prop('disabled', false);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerInfo(customerId) {
            $.get("{{ route('admin.api.customer-info', '') }}/" + customerId, function (data) {
                if (data) {
                    $('#customerInfo').html(`
                        <small>
                            <i class="fas fa-user text-success mr-1"></i>
                            <strong>${data.name}</strong><br>
                            ${data.phone ? `<i class="fas fa-phone text-success mr-1"></i>${data.phone}<br>` : ''}
                            ${data.email ? `<i class="fas fa-envelope text-success mr-1"></i>${data.email}<br>` : ''}
                            ${data.address ? `<i class="fas fa-map-marker-alt text-success mr-1"></i>${data.address}` : ''}
                        </small>
                    `).show();
                }
            }).fail(function() {
                $('#customerInfo').hide();
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        function loadVehicleInfo(vehicleId) {
            $.get("{{ route('admin.api.vehicle-info', '') }}/" + vehicleId, function (data) {
                if (data) {
                    $('#vehicleInfo').html(`
                        <small>
                            <i class="fas fa-car text-success mr-1"></i>
                            <strong>${data.make} ${data.model}</strong><br>
                            <i class="fas fa-hashtag text-success mr-1"></i>
                            –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${data.plate}</strong><br>
                            ${data.year ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${data.year}<br>` : ''}
                            ${data.engine ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${data.engine}<br>` : ''}
                            ${data.vin ? `<i class="fas fa-barcode text-success mr-1"></i>VIN: ${data.vin}<br>` : ''}
                            ${data.current_mileage ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${data.current_mileage} –∫–º` : ''}
                        </small>
                    `).show();
                    
                    // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–∞
                    if (data.current_mileage) {
                        $('#vehicleMileage').val(data.current_mileage);
                    }
                }
            }).fail(function() {
                $('#vehicleInfo').hide();
            });
        }

        // =============== –§—É–Ω–∫—Ü–∏–∏ –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ ===============
        let rowIdx = 0;

        function calcLine(row) {
            const qty   = parseFloat(row.find('.qty').val()) || 0;
            const price = parseFloat(row.find('.price').val()) || 0;
            const vat   = parseFloat(row.find('.vat').val()) || 0;
            const line  = qty * price;
            const vatAm = line * vat / 100;
            row.find('.lineTotal').text((line + vatAm).toFixed(2));
            calcTotals();
            updateItemsCount();
        }

        function calcTotals() {
            let totalWithout = 0, totalVat = 0;
            $('#itemsTable tbody tr').each(function () {
                const qty   = parseFloat($(this).find('.qty').val()) || 0;
                const price = parseFloat($(this).find('.price').val()) || 0;
                const vat   = parseFloat($(this).find('.vat').val()) || 0;
                const line  = qty * price;
                totalWithout += line;
                totalVat     += line * vat / 100;
            });
            $('#totalWithoutVat').text(totalWithout.toFixed(2));
            $('#totalVat').text(totalVat.toFixed(2));
            $('#grandTotal').text((totalWithout + totalVat).toFixed(2));
        }

        function updateItemsCount() {
            const count = $('#itemsTable tbody tr').length;
            $('#itemsCount').text(count + ' –ø–æ–∑–∏—Ü–∏–∏');
            $('#itemsCountFooter').text(count);
        }

        function addRow(productType = 'product', predefinedProduct = null) {
            rowIdx++;
            const isService = productType === 'service';
            
            let productOptions = '<option value=""></option>';
            @if(isset($products) && $products->count())
                @foreach($products as $p)
                    productOptions += `
                        <option value="{{ $p->id }}" 
                                data-price="{{ $p->price }}" 
                                data-vat="{{ $p->vat_percent }}"
                                data-type="${isService ? 'service' : 'product'}">
                            {{ $p->sku }} - {{ $p->name }}
                        </option>`;
                @endforeach
            @endif

            const html = `
                <tr id="R${rowIdx}" class="${isService ? 'table-info' : ''}">
                    <td class="align-middle">${rowIdx}</td>
                    <td>
                        <select name="items[${rowIdx}][product_id]" class="form-control product-select" 
                                style="width:100%" data-type="${productType}">
                            ${productOptions}
                        </select>
                    </td>
                    <td>
                        <input type="text" name="items[${rowIdx}][description]" 
                               class="form-control" placeholder="${isService ? '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞' : '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∞'}" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][quantity]" 
                               class="form-control qty" min="0.01" step="0.01" value="1" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][unit_price]" 
                               class="form-control price" min="0.01" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][vat_percent]" 
                               class="form-control vat" min="0" max="100" step="0.01" value="20" required>
                    </td>
                    <td class="align-middle lineTotal font-weight-bold">0.00</td>
                    <td class="align-middle">
                        <button type="button" class="btn btn-sm btn-danger removeRow" title="–ü—Ä–µ–º–∞—Ö–Ω–∏">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            
            $('#itemsTable tbody').append(html);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $(`#R${rowIdx} .product-select`).select2({
                theme: 'bootstrap',
                language: 'bg',
                placeholder: `–ò–∑–±–µ—Ä–µ—Ç–µ ${isService ? '—É—Å–ª—É–≥–∞' : '–ø—Ä–æ–¥—É–∫—Ç'}`,
                allowClear: true
            });
            
            // –ê–∫–æ –∏–º–∞ predefined –ø—Ä–æ–¥—É–∫—Ç, –∏–∑–±–µ—Ä–∏ –≥–æ
            if (predefinedProduct) {
                $(`#R${rowIdx} .product-select`).val(predefinedProduct.id).trigger('change');
                $(`#R${rowIdx} .price`).val(predefinedProduct.price);
                $(`#R${rowIdx} .vat`).val(predefinedProduct.vat_percent || 20);
                $(`#R${rowIdx} input[name*="description"]`).val(predefinedProduct.name);
                calcLine($(`#R${rowIdx}`));
            }
            
            updateItemsCount();
        }

        // Event Listeners –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
        $(document)
            .on('click', '#addRow', () => addRow('product'))
            .on('click', '#addServiceRow', () => addRow('service'))
            .on('click', '#addQuickService', () => {
                addRow('service', {
                    id: 'quick_service',
                    name: '–ë—ä—Ä–∑ —Ä–µ–º–æ–Ω—Ç',
                    price: 50,
                    vat_percent: 20
                });
            })
            .on('click', '.removeRow', function () {
                $(this).closest('tr').remove();
                calcTotals();
                updateItemsCount();
                renumberRows();
            })
            .on('change keyup', '.qty, .price, .vat', function () {
                calcLine($(this).closest('tr'));
            })
            .on('change', '.product-select', function () {
                const option = $(this).find(':selected');
                const row = $(this).closest('tr');
                const price = option.data('price');
                const vat = option.data('vat');
                
                if (price) row.find('.price').val(price);
                if (vat) row.find('.vat').val(vat);
                
                if (option.text() && !row.find('input[name*="description"]').val()) {
                    row.find('input[name*="description"]').val(option.text().split(' - ')[1] || option.text());
                }
                
                calcLine(row);
                const type = option.data('type');
                row.removeClass('table-info table-warning').addClass(type === 'service' ? 'table-warning' : '');
            });

        // –ü—Ä–µ–Ω–æ–º–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–¥–æ–≤–µ —Å–ª–µ–¥ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ
        function renumberRows() {
            $('#itemsTable tbody tr').each(function(index) {
                $(this).find('td:first').text(index + 1);
                $(this).attr('id', 'R' + (index + 1));
                // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –∏–º–µ–Ω–∞—Ç–∞ –Ω–∞ –ø–æ–ª–µ—Ç–∞—Ç–∞
                $(this).find('[name*="items"]').each(function() {
                    const name = $(this).attr('name');
                    $(this).attr('name', name.replace(/items\[\d+\]/, `items[${index + 1}]`));
                });
            });
            rowIdx = $('#itemsTable tbody tr').length;
        }

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—ä—Ä–≤–∏ —Ä–µ–¥ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        $(document).ready(function() {
            addRow('product');
        });
    </script>
@endpush.... –ê–∫–æ –≤—Å–∏—á–∫–æ –µ –Ω–∞—Ä–µ–¥, –∫–∞–∂–∏ —á–µ –Ω—è–º–∞ –Ω—É–∂–¥–∞ –æ—Ç –ø—Ä–æ–º–µ–Ω–∏. –ê–∫–æ –æ–±–∞—á–µ –≤—Å–µ –ø–∞–∫ –∏–º–∞ –Ω—É–∂–¥–∞ –¥–∞ –±—ä–¥–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω, –Ω–∞–ø—Ä–∞–≤–∏ –≥–æ –∏ –º–∏ –≥–æ–≤—ä—Ä–Ω–∏—è —Ü–µ–ª–∏—è –≤–µ—á–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω!
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–∞—Ö —Ñ–∞–π–ª–æ–≤–µ—Ç–µ. –ü—Ä–æ–±–ª–µ–º—ä—Ç –µ, —á–µ –≤ web.php –∏–º–∞—à –¥–≤–∞ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –µ–¥–Ω–æ –∏ —Å—ä—â–æ –∏–º–µ! –ò –¥–≤–∞—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞ —Å–µ –∫–∞–∑–≤–∞—Ç admin.api.customer-vehicles, –Ω–æ –µ–¥–∏–Ω–∏—è—Ç –µ –≤ API –≥—Ä—É–ø–∞—Ç–∞, –∞ –¥—Ä—É–≥–∏—è—Ç –µ –∏–∑–≤—ä–Ω –Ω–µ—è.

–ï—Ç–æ –∫–æ—Ä–µ–∫—Ü–∏–∏—Ç–µ:

1. routes/web.php (—Ñ–∏–Ω–∞–ª–µ–Ω –≤–∞—Ä–∏–∞–Ω—Ç)
php
<?php

use App\Http\Controllers\ProfileController;
use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
*/

Route::get('/', fn() => redirect()->route('login'));

Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware(['auth', 'verified'])->name('dashboard');

/* --------------------------------------------------------------------------
   –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å –ø—Ä–∞–≤–∞)
--------------------------------------------------------------------------*/
Route::middleware(['auth', 'verified'])->prefix('admin')->name('admin.')->group(function () {

    /* --- –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å–∞–º–æ admin) --- */
    Route::middleware(['can:admin'])->group(function () {
        Route::resource('users',       \App\Http\Controllers\Admin\UserController::class);
        Route::resource('roles',       \App\Http\Controllers\Admin\RoleController::class);
        Route::resource('permissions', \App\Http\Controllers\Admin\PermissionController::class);
    });

    /* --- –û–°–ù–û–í–ù–ò –ú–û–î–£–õ–ò --- */
    Route::resource('customers',   \App\Http\Controllers\Admin\CustomerController::class);
    Route::resource('vehicles',    \App\Http\Controllers\Admin\VehicleController::class);
    Route::resource('products',    \App\Http\Controllers\Admin\ProductController::class);
    Route::resource('work-orders', \App\Http\Controllers\Admin\WorkOrderController::class);
    Route::resource('invoices',    \App\Http\Controllers\Admin\InvoiceController::class);

    /* --- EXPORT-–∏ –∑–∞ Customer --- */
    Route::get('customers/{customer}/export/pdf', [\App\Http\Controllers\Admin\CustomerController::class, 'exportPdf'])
        ->name('customers.export.pdf');
    Route::get('customers/{customer}/export/excel', [\App\Http\Controllers\Admin\CustomerController::class, 'exportExcel'])
        ->name('customers.export.excel');
    Route::get('customers/{customer}/export/csv', [\App\Http\Controllers\Admin\CustomerController::class, 'exportCsv'])
        ->name('customers.export.csv');

    /* --- EXPORT-–∏ –∑–∞ Vehicle --- */
    Route::get('vehicles/{vehicle}/export/pdf', [\App\Http\Controllers\Admin\VehicleController::class, 'exportPdf'])->name('vehicles.export.pdf');
    Route::get('vehicles/{vehicle}/export/excel', [\App\Http\Controllers\Admin\VehicleController::class, 'exportExcel'])->name('vehicles.export.excel');
    Route::get('vehicles/{vehicle}/export/csv', [\App\Http\Controllers\Admin\VehicleController::class, 'exportCsv'])->name('vehicles.export.csv');

    /* --- –°–ö–õ–ê–î --- */
    Route::prefix('stock')->name('stock.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\StockController::class, 'index'])->name('index');
        Route::get('/create-purchase', [\App\Http\Controllers\Admin\StockController::class, 'createPurchase'])->name('create-purchase');
        Route::post('/store-purchase', [\App\Http\Controllers\Admin\StockController::class, 'storePurchase'])->name('store-purchase');
        Route::get('/create-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'createAdjustment'])->name('create-adjustment');
        Route::post('/store-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'storeAdjustment'])->name('store-adjustment');
    });

    /* --- –ü–õ–ê–©–ê–ù–ò–Ø --- */
    Route::prefix('payments')->name('payments.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\PaymentController::class, 'index'])->name('index');
        Route::get('/create', [\App\Http\Controllers\Admin\PaymentController::class, 'create'])->name('create');
        Route::post('/store', [\App\Http\Controllers\Admin\PaymentController::class, 'store'])->name('store');
        Route::get('/{payment}/pdf', [\App\Http\Controllers\Admin\PaymentController::class, 'pdf'])->name('pdf');
    });

    /* --- –ë–ê–†–ö–û–î / PLU --- */
    Route::get('barcode/{code}.png', function (string $code) {
        return response(\App\Support\BarcodeHelper::png($code))->header('Content-Type', 'image/png');
    })->name('barcode.png');

    Route::get('products/{product}/barcode', [\App\Http\Controllers\Admin\ProductController::class, 'barcode'])
        ->name('products.barcode');

    Route::get('api/product-by-sku/{sku}', function (string $sku) {
        return \App\Models\Product::where('sku', $sku)->first() ?? [];
    })->name('api.product-by-sku');

    /* --- AJAX API –∑–∞ Work Orders --- */
    Route::prefix('api')->name('api.')->group(function () {
        // –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ autocomplete
        Route::get('search/customer-vehicle', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
            ->name('search.customer-vehicle');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-info/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerInfo'])
            ->name('customer-info');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        Route::get('vehicle-info/{vehicle}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'vehicleInfo'])
            ->name('vehicle-info');
        
        // –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-vehicles/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerVehicles'])
            ->name('customer-vehicles');
        
        // Autocomplete –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏
        Route::get('products/autocomplete', [\App\Http\Controllers\Admin\WorkOrderController::class, 'productsAutocomplete'])
            ->name('products.autocomplete');
    });

    /* --- –°—Ç–∞—Ä AJAX endpoint (—Ç—Ä—è–±–≤–∞ –¥–∞ –≥–æ –ø—Ä–µ–∏–º–µ–Ω—É–≤–∞–º–µ –∏–ª–∏ –ø—Ä–µ–º–∞—Ö–Ω–µ–º) --- */
    Route::get('api/customer-vehicles-legacy/{customer}', function (\App\Models\Customer $customer) {
        return $customer->vehicles()->select('id', 'plate', 'make', 'model')->get();
    })->name('api.customer-vehicles.legacy');

    /* --- PDF --- */
    Route::get('work-orders/{workOrder}/pdf', [\App\Http\Controllers\Admin\WorkOrderController::class, 'pdf'])
        ->name('work-orders.pdf');
        
    /* --- –¢—ä—Ä—Å–µ–Ω–µ –∑–∞ Work Orders (–∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç) --- */
    Route::get('work-orders/search', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
        ->name('work-orders.search');
});

require __DIR__ . '/auth.php';
2. resources\views\admin\work-orders\create.blade.php (–ø—Ä–æ–º–µ–Ω–∏ —Å–∞–º–æ –≤ JavaScript —á–∞—Å—Ç—Ç–∞)
–¢—Ä—è–±–≤–∞ –¥–∞ –∫–æ—Ä–∏–≥–∏—Ä–∞—à —Å–ª–µ–¥–Ω–∏—Ç–µ —Ä–µ–¥–æ–≤–µ –≤ JavaScript –∫–æ–¥–∞:

javascript
// –ù–∞ —Ä–µ–¥ 51-52 (—Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ performGlobalSearch) –ø—Ä–æ–º–µ–Ω–∏:
url: "{{ route('admin.work-orders.search') }}",
// –ò–õ–ò
url: "{{ route('admin.api.search.customer-vehicle') }}",

// –ù–∞ —Ä–µ–¥ 188 (—Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ loadCustomerVehicles) –ø–æ—Ç–≤—ä—Ä–¥–∏ —á–µ –µ:
$.get("{{ route('admin.api.customer-vehicles', '') }}/" + customerId, function (data) {

// –ù–∞ —Ä–µ–¥ 211 (—Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ loadCustomerInfo) –ø–æ—Ç–≤—ä—Ä–¥–∏ —á–µ –µ:
$.get("{{ route('admin.api.customer-info', '') }}/" + customerId, function (data) {

// –ù–∞ —Ä–µ–¥ 237 (—Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ loadVehicleInfo) –ø–æ—Ç–≤—ä—Ä–¥–∏ —á–µ –µ:
$.get("{{ route('admin.api.vehicle-info', '') }}/" + vehicleId, function (data) {
–ê–∫–æ –∏—Å–∫–∞—à –ø–æ-—Å–∏–≥—É—Ä–µ–Ω –≤–∞—Ä–∏–∞–Ω—Ç, –ø—Ä–æ–º–µ–Ω–∏ –≤—Å–∏—á–∫–∏ API –∑–∞—è–≤–∫–∏ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—Ç –∞–±—Å–æ–ª—é—Ç–Ω–∏ URL-–∏ –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω—É–≤–∞–Ω–∏ –º–∞—Ä—à—Ä—É—Ç–∏:

javascript
// –í–º–µ—Å—Ç–æ:
// $.get("{{ route('admin.api.customer-vehicles', '') }}/" + customerId, ...

// –ò–∑–ø–æ–ª–∑–≤–∞–π:
$.get("/admin/api/customer-vehicles/" + customerId, ...

// –í–º–µ—Å—Ç–æ:
// url: "{{ route('admin.api.search.customer-vehicle') }}",

// –ò–∑–ø–æ–ª–∑–≤–∞–π:
url: "/admin/api/search/customer-vehicle",
–ï—Ç–æ –æ–∫–æ–Ω—á–∞—Ç–µ–ª–Ω–∏—è JavaScript –∫–æ–¥ –∑–∞ —á–∞—Å—Ç—Ç–∞ —Å—ä—Å –∑–∞—è–≤–∫–∏—Ç–µ:

javascript
// –§—É–Ω–∫—Ü–∏—è –∑–∞ –≥–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
function performGlobalSearch(query) {
    $.ajax({
        url: "/admin/api/search/customer-vehicle",
        method: 'GET',
        data: { q: query },
        // ... –æ—Å—Ç–∞–Ω–∞–ª–∞—Ç–∞ —á–∞—Å—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ ...
    });
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
function loadCustomerVehicles(customerId) {
    if (!customerId) {
        $('#vehicle_id').html('<option value=""></option>').prop('disabled', true).trigger('change');
        return;
    }
    
    $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
    
    $.get("/admin/api/customer-vehicles/" + customerId, function (data) {
        // ... –æ—Å—Ç–∞–Ω–∞–ª–∞—Ç–∞ —á–∞—Å—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ ...
    });
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
function loadCustomerInfo(customerId) {
    $.get("/admin/api/customer-info/" + customerId, function (data) {
        // ... –æ—Å—Ç–∞–Ω–∞–ª–∞—Ç–∞ —á–∞—Å—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ ...
    });
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
function loadVehicleInfo(vehicleId) {
    $.get("/admin/api/vehicle-info/" + vehicleId, function (data) {
        // ... –æ—Å—Ç–∞–Ω–∞–ª–∞—Ç–∞ —á–∞—Å—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ ...
    });
}
**–ü

–°—Ç–æ–ø! –ù–∞–ª–∏ —Å–µ —Ä–∞–∑–±—Ä–∞—Ö–º–µ –¥–∞ –º–∏ –ø–æ–¥–∞–≤–∞—à —Å–∞–º–æ —Ü–µ–ª–∏ —Ñ–∞–π–ª–æ–≤–µ. –¢–∞–∫–∞ —á–µ –º–æ–ª—è —Ç–µ –¥–∞ –º–∏ –ø–æ–¥–∞–¥–µ—à —Ü–µ–ª–∏—è resources\views\admin\work-orders\create.blade.php
–†–∞–∑–±–∏—Ä–∞ —Å–µ! –ï—Ç–æ —Ü–µ–ª–∏—è—Ç create.blade.php —Ñ–∞–π–ª —Å –∞–±—Å–æ–ª—é—Ç–Ω–∏—Ç–µ URL-–∏ –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω—É–≤–∞–Ω–∏ –º–∞—Ä—à—Ä—É—Ç–∏, –∫–æ–∏—Ç–æ —â–µ —Ä–∞–±–æ—Ç—è—Ç —Å–∏–≥—É—Ä–Ω–æ:

blade
@extends('adminlte::page')

@section('title', '–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="text-primary"><i class="fas fa-file-invoice mr-2"></i>–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞</h1>
        <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left mr-1"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
@stop

@section('content')
    <div class="card border-primary">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-search mr-2"></i>–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ</h4>
        </div>
        <div class="card-body bg-light">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label class="font-weight-bold">–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª:</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-primary"></i>
                                </span>
                            </div>
                            <input type="text" id="globalSearch" class="form-control form-control-lg" 
                                   placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º–µ–π–ª –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä..."
                                   style="border-color: #4e73df;">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="searchResults" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto;">
                            <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —â–µ —Å–µ –ø–æ—è–≤—è—Ç —Ç—É–∫ -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <div class="alert alert-info w-100 mb-0">
                        <small>
                            <i class="fas fa-info-circle mr-1"></i>
                            –¢—ä—Ä—Å–µ—Ç–µ –ø–æ: <strong>–∏–º–µ</strong>, <strong>—Ç–µ–ª–µ—Ñ–æ–Ω</strong>, 
                            <strong>–∏–º–µ–π–ª</strong> –∏–ª–∏ <strong>—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä</strong>.
                            –ò–∑–±–µ—Ä–µ—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-success mt-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-user-circle mr-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</h4>
        </div>
        <div class="card-body">
            <form action="{{ route('admin.work-orders.store') }}" method="POST" id="orderForm">
                @csrf
                
                {{-- –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --}}
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ö–ª–∏–µ–Ω—Ç <span class="text-danger">*</span></label>
                            <select name="customer_id" id="customer_id" class="form-control select2" 
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç" required
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($customers as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <div id="customerInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-user text-success mr-1"></i>
                                    <span id="customerName"></span><br>
                                    <i class="fas fa-phone text-success mr-1"></i>
                                    <span id="customerPhone"></span><br>
                                    <i class="fas fa-envelope text-success mr-1"></i>
                                    <span id="customerEmail"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ê–≤—Ç–æ–º–æ–±–∏–ª <span class="text-danger">*</span></label>
                            <select name="vehicle_id" id="vehicle_id" class="form-control select2" required
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª"
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                            </select>
                            <div id="vehicleInfo" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small>
                                    <i class="fas fa-car text-success mr-1"></i>
                                    <span id="vehicleMakeModel"></span><br>
                                    <i class="fas fa-hashtag text-success mr-1"></i>
                                    –†–µ–≥. –Ω–æ–º–µ—Ä: <span id="vehiclePlate"></span><br>
                                    <i class="fas fa-calendar text-success mr-1"></i>
                                    –ì–æ–¥–∏–Ω–∞: <span id="vehicleYear"></span><br>
                                    <i class="fas fa-gas-pump text-success mr-1"></i>
                                    –î–≤–∏–≥–∞—Ç–µ–ª: <span id="vehicleEngine"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-success">–ú–µ—Ö–∞–Ω–∏–∫</label>
                            <select name="assigned_to" class="form-control select2" 
                                    style="border-color: #1cc88a;">
                                <option value=""></option>
                                @foreach($mechanics as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <small class="form-text text-muted">–ù–µ–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ</small>
                        </div>
                    </div>
                </div>

                {{-- –î–µ—Ç–∞–π–ª–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞ --}}
                <div class="card border-warning mt-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0 text-dark"><i class="fas fa-clipboard-list mr-2"></i>–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–°—Ç–∞—Ç—É—Å <span class="text-danger">*</span></label>
                                    <select name="status" class="form-control" required
                                            style="border-color: #f6c23e;">
                                        <option value="draft" class="text-secondary">üìù –ß–µ—Ä–Ω–æ–≤–∞</option>
                                        <option value="open" class="text-info" selected>üîì –û—Ç–≤–æ—Ä–µ–Ω–∞</option>
                                        <option value="in_progress" class="text-warning">‚öôÔ∏è –í –ø—Ä–æ–≥—Ä–µ—Å</option>
                                        <option value="completed" class="text-success">‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω–∞</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞–Ω–µ</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="datetime-local" name="received_at" class="form-control" 
                                               value="{{ now()->format('Y-m-d\TH:i') }}"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–ü—Ä–æ–±–µ–≥ (km)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-tachometer-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="number" name="km_on_receive" class="form-control" 
                                               min="0" placeholder="0" id="vehicleMileage"
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–û—á–∞–∫–≤–∞–Ω–∞ –¥–∞—Ç–∞</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-check text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="date" name="estimated_completion" class="form-control" 
                                               style="border-color: #dddfeb;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-2">
                            <label class="font-weight-bold text-dark">
                                <i class="fas fa-sticky-note mr-1"></i>–ë–µ–ª–µ–∂–∫–∏
                            </label>
                            <textarea name="notes" class="form-control" rows="2" 
                                      placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –±–µ–ª–µ–∂–∫–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞..."
                                      style="border-color: #dddfeb;"></textarea>
                        </div>
                    </div>
                </div>

                {{-- –î–∏–Ω–∞–º–∏—á–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ --}}
                <div class="card border-info mt-4">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-list-alt mr-2"></i>–ü–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ—Ä—ä—á–∫–∞—Ç–∞
                            <span class="badge badge-light ml-2" id="itemsCount">0 –ø–æ–∑–∏—Ü–∏–∏</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="itemsTable">
                                <thead class="bg-light">
                                    <tr>
                                        <th width="5%">‚Ññ</th>
                                        <th width="25%">–ü—Ä–æ–¥—É–∫—Ç/–£—Å–ª—É–≥–∞</th>
                                        <th width="25%">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        <th width="10%">–ö–æ–ª-–≤–æ</th>
                                        <th width="10%">–¶–µ–Ω–∞ –±–µ–∑ –î–î–°</th>
                                        <th width="10%">–î–î–° %</th>
                                        <th width="10%">–û–±—â–æ</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot class="bg-light">
                                    <tr>
                                        <td colspan="7" class="text-right font-weight-bold">–û–±—â–æ –ø–æ–∑–∏—Ü–∏–∏:</td>
                                        <td class="font-weight-bold" id="itemsCountFooter">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <button type="button" id="addRow" class="btn btn-success btn-sm">
                                <i class="fas fa-box mr-1"></i> –î–æ–±–∞–≤–∏ –ø—Ä–æ–¥—É–∫—Ç
                            </button>
                            <button type="button" id="addServiceRow" class="btn btn-primary btn-sm">
                                <i class="fas fa-tools mr-1"></i> –î–æ–±–∞–≤–∏ —É—Å–ª—É–≥–∞
                            </button>
                            <button type="button" id="addQuickService" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-bolt mr-1"></i> –ë—ä—Ä–∑–∞ —É—Å–ª—É–≥–∞
                            </button>
                        </div>
                    </div>
                </div>

                {{-- –°—É–º–∏ --}}
                <div class="row mt-4">
                    <div class="col-md-5 offset-md-7">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-calculator mr-2"></i>–û–±—â–æ —Å—É–º–∏</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <th class="text-right">–û–±—â–æ –±–µ–∑ –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-primary" id="totalWithoutVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="text-right">–î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h5 font-weight-bold text-warning" id="totalVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr class="border-top">
                                        <th class="text-right h5">–û–±—â–æ —Å –î–î–°:</th>
                                        <td class="text-right">
                                            <span class="h3 font-weight-bold text-success" id="grandTotal">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                {{-- –ë—É—Ç–æ–Ω–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ --}}
                <div class="mt-4 d-flex justify-content-end gap-3">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save mr-2"></i> –ó–∞–ø–∞–∑–∏ –ø–æ—Ä—ä—á–∫–∞
                    </button>
                    <button type="submit" name="action" value="save_and_print" class="btn btn-primary btn-lg">
                        <i class="fas fa-print mr-2"></i> –ó–∞–ø–∞–∑–∏ –∏ –æ—Ç–ø–µ—á–∞—Ç–∞–π
                    </button>
                    <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-times mr-2"></i> –û—Ç–∫–∞–∑
                    </a>
                </div>
            </form>
        </div>
    </div>
@stop

@push('css')
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    <style>
        .select2-container--bootstrap .select2-selection {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .select2-container--bootstrap .select2-selection:focus {
            border-color: #1cc88a;
            box-shadow: 0 0 0 0.2rem rgba(28, 200, 138, 0.25);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(28, 200, 138, 0.05);
        }
        .card-header {
            border-radius: 0.35rem 0.35rem 0 0 !important;
        }
        .input-group-text {
            background-color: #f8f9fc;
            border: 1px solid #d1d3e2;
        }
        .badge {
            font-size: 0.8em;
            padding: 0.35em 0.65em;
        }
        .list-group-item:hover {
            background-color: #1cc88a !important;
            color: white !important;
            cursor: pointer;
        }
        .list-group-item .customer-badge {
            font-size: 0.75em;
        }
        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        #customerInfo, #vehicleInfo {
            border-left: 4px solid #1cc88a;
        }
    </style>
@endpush

@push('js')
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/bg.js"></script>
    <script>
        $(function () {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $('.select2').select2({
                theme: 'bootstrap',
                language: 'bg',
                width: '100%',
                allowClear: true
            });

            // –ì–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
            let searchTimeout;
            $('#globalSearch').on('input', function() {
                clearTimeout(searchTimeout);
                const query = $(this).val().trim();
                
                if (query.length < 2) {
                    $('#searchResults').hide().empty();
                    return;
                }
                
                searchTimeout = setTimeout(function() {
                    performGlobalSearch(query);
                }, 300);
            });

            // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#clearSearch').click(function() {
                $('#globalSearch').val('');
                $('#searchResults').hide().empty();
            });

            // –ó–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –ø—Ä–∏ –∫–ª–∏–∫ –∏–∑–≤—ä–Ω —Ç—è—Ö
            $(document).click(function(e) {
                if (!$(e.target).closest('#globalSearch, #searchResults').length) {
                    $('#searchResults').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∫–ª–∏–µ–Ω—Ç
            $('#customer_id').change(function () {
                const customerId = $(this).val();
                loadCustomerVehicles(customerId);
                
                // –ê–∫–æ –∏–º–∞ –∏–∑–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç, –ø–æ–∫–∞–∂–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –º—É
                if (customerId) {
                    loadCustomerInfo(customerId);
                } else {
                    $('#customerInfo').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
            $('#vehicle_id').change(function () {
                const vehicleId = $(this).val();
                if (vehicleId) {
                    loadVehicleInfo(vehicleId);
                } else {
                    $('#vehicleInfo').hide();
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –≥–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
        function performGlobalSearch(query) {
            $.ajax({
                url: "/admin/api/search/customer-vehicle",
                method: 'GET',
                data: { q: query },
                beforeSend: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border spinner-border-sm text-primary mr-2"></div>
                                <span>–¢—ä—Ä—Å–µ–Ω–µ...</span>
                            </div>
                        </div>
                    `).show();
                },
                success: function(data) {
                    if (data.customers.length === 0 && data.vehicles.length === 0) {
                        $('#searchResults').html(`
                            <div class="list-group-item text-muted">
                                <i class="fas fa-search mr-2"></i>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
                            </div>
                        `).show();
                        return;
                    }

                    let html = '';
                    
                    // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
                    if (data.customers && data.customers.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ö–ª–∏–µ–Ω—Ç–∏</div>`;
                        data.customers.forEach(customer => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="customer" 
                                     data-id="${customer.id}"
                                     data-name="${customer.name}"
                                     data-phone="${customer.phone || ''}"
                                     data-email="${customer.email || ''}"
                                     data-address="${customer.address || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-user text-primary mr-2"></i>
                                            <strong>${highlightText(customer.name, query)}</strong>
                                        </div>
                                        <span class="badge badge-primary customer-badge">–ö–ª–∏–µ–Ω—Ç</span>
                                    </div>
                                    ${customer.phone ? `<small class="text-muted d-block mt-1"><i class="fas fa-phone mr-1"></i>${highlightText(customer.phone, query)}</small>` : ''}
                                    ${customer.email ? `<small class="text-muted d-block"><i class="fas fa-envelope mr-1"></i>${highlightText(customer.email, query)}</small>` : ''}
                                    <small class="text-muted d-block">${customer.vehicles_count || 0} –∞–≤—Ç–æ–º–æ–±–∏–ª–∞</small>
                                </div>
                            `;
                        });
                    }

                    if (data.vehicles && data.vehicles.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>`;
                        data.vehicles.forEach(vehicle => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="vehicle" 
                                     data-id="${vehicle.id}"
                                     data-customer-id="${vehicle.customer_id}"
                                     data-plate="${vehicle.plate}"
                                     data-make="${vehicle.make || ''}"
                                     data-model="${vehicle.model || ''}"
                                     data-year="${vehicle.year || ''}"
                                     data-engine="${vehicle.engine || ''}"
                                     data-vin="${vehicle.vin || ''}"
                                     data-mileage="${vehicle.current_mileage || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-car text-success mr-2"></i>
                                            <strong>${highlightText(vehicle.plate, query)}</strong>
                                        </div>
                                        <span class="badge badge-success customer-badge">–ê–≤—Ç–æ–º–æ–±–∏–ª</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        ${vehicle.make || ''} ${vehicle.model || ''} ${vehicle.year ? `(${vehicle.year})` : ''}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-user mr-1"></i>${vehicle.customer?.name || '–ù—è–º–∞ –∫–ª–∏–µ–Ω—Ç'}
                                    </small>
                                </div>
                            `;
                        });
                    }

                    $('#searchResults').html(html).show();
                    
                    // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ event listener –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç
                    $('.list-group-item[data-type]').click(function() {
                        selectSearchResult($(this));
                    });
                },
                error: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item text-danger">
                            <i class="fas fa-exclamation-circle mr-2"></i>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
                        </div>
                    `).show();
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ—Å–≤–µ—Ç—è–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ
        function highlightText(text, query) {
            if (!query || !text) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.toString().replace(regex, '<span class="search-highlight">$1</span>');
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –æ—Ç —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
        function selectSearchResult($element) {
            const type = $element.data('type');
            
            if (type === 'customer') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
                $('#customer_id').val($element.data('id')).trigger('change');
                $('#customerInfo').html(`
                    <small>
                        <i class="fas fa-user text-success mr-1"></i>
                        <strong>${$element.data('name')}</strong><br>
                        ${$element.data('phone') ? `<i class="fas fa-phone text-success mr-1"></i>${$element.data('phone')}<br>` : ''}
                        ${$element.data('email') ? `<i class="fas fa-envelope text-success mr-1"></i>${$element.data('email')}` : ''}
                    </small>
                `).show();
                
                // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                loadCustomerVehicles($element.data('id'));
                
            } else if (type === 'vehicle') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª –∏ –Ω–µ–≥–æ–≤–∏—è –∫–ª–∏–µ–Ω—Ç
                $('#vehicle_id').val($element.data('id')).trigger('change');
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∞
                $('#vehicleInfo').html(`
                    <small>
                        <i class="fas fa-car text-success mr-1"></i>
                        <strong>${$element.data('make')} ${$element.data('model')}</strong><br>
                        <i class="fas fa-hashtag text-success mr-1"></i>
                        –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${$element.data('plate')}</strong><br>
                        ${$element.data('year') ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${$element.data('year')}<br>` : ''}
                        ${$element.data('engine') ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${$element.data('engine')}<br>` : ''}
                        ${$element.data('mileage') ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${$element.data('mileage')} –∫–º` : ''}
                    </small>
                `).show();
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞
                if ($element.data('mileage')) {
                    $('#vehicleMileage').val($element.data('mileage'));
                }
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                if ($element.data('customerId')) {
                    $('#customer_id').val($element.data('customerId')).trigger('change');
                }
            }
            
            // –°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –∏ –∏–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#searchResults').hide().empty();
            $('#globalSearch').val('');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerVehicles(customerId) {
            if (!customerId) {
                $('#vehicle_id').html('<option value=""></option>').prop('disabled', true).trigger('change');
                return;
            }
            
            $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
            
            $.get("/admin/api/customer-vehicles/" + customerId, function (data) {
                let html = '<option value=""></option>';
                if (data.length > 0) {
                    $.each(data, function (i, v) {
                        html += `<option value="${v.id}">${v.plate} - ${v.make} ${v.model} (${v.year || '?'})</option>`;
                    });
                } else {
                    html = '<option value="">–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</option>';
                }
                $('#vehicle_id').html(html).prop('disabled', false).trigger('change');
            }).fail(function() {
                $('#vehicle_id').html('<option value="">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</option>').prop('disabled', false);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerInfo(customerId) {
            $.get("/admin/api/customer-info/" + customerId, function (data) {
                if (data) {
                    $('#customerInfo').html(`
                        <small>
                            <i class="fas fa-user text-success mr-1"></i>
                            <strong>${data.name}</strong><br>
                            ${data.phone ? `<i class="fas fa-phone text-success mr-1"></i>${data.phone}<br>` : ''}
                            ${data.email ? `<i class="fas fa-envelope text-success mr-1"></i>${data.email}<br>` : ''}
                            ${data.address ? `<i class="fas fa-map-marker-alt text-success mr-1"></i>${data.address}` : ''}
                        </small>
                    `).show();
                }
            }).fail(function() {
                $('#customerInfo').hide();
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        function loadVehicleInfo(vehicleId) {
            $.get("/admin/api/vehicle-info/" + vehicleId, function (data) {
                if (data) {
                    $('#vehicleInfo').html(`
                        <small>
                            <i class="fas fa-car text-success mr-1"></i>
                            <strong>${data.make} ${data.model}</strong><br>
                            <i class="fas fa-hashtag text-success mr-1"></i>
                            –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${data.plate}</strong><br>
                            ${data.year ? `<i class="fas fa-calendar text-success mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${data.year}<br>` : ''}
                            ${data.engine ? `<i class="fas fa-gas-pump text-success mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${data.engine}<br>` : ''}
                            ${data.vin ? `<i class="fas fa-barcode text-success mr-1"></i>VIN: ${data.vin}<br>` : ''}
                            ${data.current_mileage ? `<i class="fas fa-tachometer-alt text-success mr-1"></i>–ü—Ä–æ–±–µ–≥: ${data.current_mileage} –∫–º` : ''}
                        </small>
                    `).show();
                    
                    // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–∞
                    if (data.current_mileage) {
                        $('#vehicleMileage').val(data.current_mileage);
                    }
                }
            }).fail(function() {
                $('#vehicleInfo').hide();
            });
        }

        // =============== –§—É–Ω–∫—Ü–∏–∏ –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ ===============
        let rowIdx = 0;

        function calcLine(row) {
            const qty   = parseFloat(row.find('.qty').val()) || 0;
            const price = parseFloat(row.find('.price').val()) || 0;
            const vat   = parseFloat(row.find('.vat').val()) || 0;
            const line  = qty * price;
            const vatAm = line * vat / 100;
            row.find('.lineTotal').text((line + vatAm).toFixed(2));
            calcTotals();
            updateItemsCount();
        }

        function calcTotals() {
            let totalWithout = 0, totalVat = 0;
            $('#itemsTable tbody tr').each(function () {
                const qty   = parseFloat($(this).find('.qty').val()) || 0;
                const price = parseFloat($(this).find('.price').val()) || 0;
                const vat   = parseFloat($(this).find('.vat').val()) || 0;
                const line  = qty * price;
                totalWithout += line;
                totalVat     += line * vat / 100;
            });
            $('#totalWithoutVat').text(totalWithout.toFixed(2));
            $('#totalVat').text(totalVat.toFixed(2));
            $('#grandTotal').text((totalWithout + totalVat).toFixed(2));
        }

        function updateItemsCount() {
            const count = $('#itemsTable tbody tr').length;
            $('#itemsCount').text(count + ' –ø–æ–∑–∏—Ü–∏–∏');
            $('#itemsCountFooter').text(count);
        }

        function addRow(productType = 'product', predefinedProduct = null) {
            rowIdx++;
            const isService = productType === 'service';
            
            let productOptions = '<option value=""></option>';
            @if(isset($products) && $products->count())
                @foreach($products as $p)
                    productOptions += `
                        <option value="{{ $p->id }}" 
                                data-price="{{ $p->price }}" 
                                data-vat="{{ $p->vat_percent }}"
                                data-type="${isService ? 'service' : 'product'}">
                            {{ $p->sku }} - {{ $p->name }}
                        </option>`;
                @endforeach
            @endif

            const html = `
                <tr id="R${rowIdx}" class="${isService ? 'table-info' : ''}">
                    <td class="align-middle">${rowIdx}</td>
                    <td>
                        <select name="items[${rowIdx}][product_id]" class="form-control product-select" 
                                style="width:100%" data-type="${productType}">
                            ${productOptions}
                        </select>
                    </td>
                    <td>
                        <input type="text" name="items[${rowIdx}][description]" 
                               class="form-control" placeholder="${isService ? '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞' : '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∞'}" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][quantity]" 
                               class="form-control qty" min="0.01" step="0.01" value="1" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][unit_price]" 
                               class="form-control price" min="0.01" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][vat_percent]" 
                               class="form-control vat" min="0" max="100" step="0.01" value="20" required>
                    </td>
                    <td class="align-middle lineTotal font-weight-bold">0.00</td>
                    <td class="align-middle">
                        <button type="button" class="btn btn-sm btn-danger removeRow" title="–ü—Ä–µ–º–∞—Ö–Ω–∏">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            
            $('#itemsTable tbody').append(html);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $(`#R${rowIdx} .product-select`).select2({
                theme: 'bootstrap',
                language: 'bg',
                placeholder: `–ò–∑–±–µ—Ä–µ—Ç–µ ${isService ? '—É—Å–ª—É–≥–∞' : '–ø—Ä–æ–¥—É–∫—Ç'}`,
                allowClear: true
            });
            
            // –ê–∫–æ –∏–º–∞ predefined –ø—Ä–æ–¥—É–∫—Ç, –∏–∑–±–µ—Ä–∏ –≥–æ
            if (predefinedProduct) {
                $(`#R${rowIdx} .product-select`).val(predefinedProduct.id).trigger('change');
                $(`#R${rowIdx} .price`).val(predefinedProduct.price);
                $(`#R${rowIdx} .vat`).val(predefinedProduct.vat_percent || 20);
                $(`#R${rowIdx} input[name*="description"]`).val(predefinedProduct.name);
                calcLine($(`#R${rowIdx}`));
            }
            
            updateItemsCount();
        }

        // Event Listeners –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
        $(document)
            .on('click', '#addRow', () => addRow('product'))
            .on('click', '#addServiceRow', () => addRow('service'))
            .on('click', '#addQuickService', () => {
                addRow('service', {
                    id: 'quick_service',
                    name: '–ë—ä—Ä–∑ —Ä–µ–º–æ–Ω—Ç',
                    price: 50,
                    vat_percent: 20
                });
            })
            .on('click', '.removeRow', function () {
                $(this).closest('tr').remove();
                calcTotals();
                updateItemsCount();
                renumberRows();
            })
            .on('change keyup', '.qty, .price, .vat', function () {
                calcLine($(this).closest('tr'));
            })
            .on('change', '.product-select', function () {
                const option = $(this).find(':selected');
                const row = $(this).closest('tr');
                const price = option.data('price');
                const vat = option.data('vat');
                
                if (price) row.find('.price').val(price);
                if (vat) row.find('.vat').val(vat);
                
                if (option.text() && !row.find('input[name*="description"]').val()) {
                    row.find('input[name*="description"]').val(option.text().split(' - ')[1] || option.text());
                }
                
                calcLine(row);
                const type = option.data('type');
                row.removeClass('table-info table-warning').addClass(type === 'service' ? 'table-warning' : '');
            });

        // –ü—Ä–µ–Ω–æ–º–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–¥–æ–≤–µ —Å–ª–µ–¥ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ
        function renumberRows() {
            $('#itemsTable tbody tr').each(function(index) {
                $(this).find('td:first').text(index + 1);
                $(this).attr('id', 'R' + (index + 1));
                // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –∏–º–µ–Ω–∞—Ç–∞ –Ω–∞ –ø–æ–ª–µ—Ç–∞—Ç–∞
                $(this).find('[name*="items"]').each(function() {
                    const name = $(this).attr('name');
                    $(this).attr('name', name.replace(/items\[\d+\]/, `items[${index + 1}]`));
                });
            });
            rowIdx = $('#itemsTable tbody tr').length;
        }

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—ä—Ä–≤–∏ —Ä–µ–¥ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        $(document).ready(function() {
            addRow('product');
        });
    </script>
@endpush
–ü—Ä–æ–º–µ–Ω–∏—Ç–µ, –∫–æ–∏—Ç–æ –Ω–∞–ø—Ä–∞–≤–∏—Ö:

–ó–∞–º–µ–Ω–∏—Ö –≤—Å–∏—á–∫–∏ –∏–º–µ–Ω—É–≤–∞–Ω–∏ –º–∞—Ä—à—Ä—É—Ç–∏ —Å –∞–±—Å–æ–ª—é—Ç–Ω–∏ URL-–∏ –≤ JavaScript —á–∞—Å—Ç—Ç–∞

API –∑–∞—è–≤–∫–∏—Ç–µ —Å–µ–≥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—Ç /admin/api/... –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω—É–≤–∞–Ω–∏ –º–∞—Ä—à—Ä—É—Ç–∏

–¢–æ–≤–∞ –µ–ª–∏–º–∏–Ω–∏—Ä–∞ –ø—Ä–æ–±–ª–µ–º–∏—Ç–µ —Å RouteNotFoundException

URL-–∏—Ç–µ, –∫–æ–∏—Ç–æ —Å–µ–≥–∞ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞—Ç:

/admin/api/search/customer-vehicle –∑–∞ –≥–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ

/admin/api/customer-vehicles/{id} –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç

/admin/api/customer-info/{id} –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç

/admin/api/vehicle-info/{id} –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª

–°–µ–≥–∞ –≤—Å–∏—á–∫–æ —Ç—Ä—è–±–≤–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏! –£–≤–µ—Ä–∏ —Å–µ, —á–µ web.php —Ñ–∞–π–ª—ä—Ç –µ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω —Å –≥–æ—Ä–Ω–∞—Ç–∞ –≤–µ—Ä—Å–∏—è, –∫–æ—è—Ç–æ —Ç–∏ –∏–∑–ø—Ä–∞—Ç–∏—Ö.

–ú–Ω–æ–≥–æ –¥–æ–±—Ä–µ! –°–∞–º–æ —á–µ –∏—Å–∫–∞–º –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏–º –º–∞–ª–∫–æ –ø—Ä–æ–º–µ–Ω–∏ –≤ –≥—Ä–∞—Ñ–∏—á–Ω–∏—è –¥–∏–∑–∞–π–Ω –Ω–∞ resources\views\admin\work-orders\create.blade.php ... –ë–∏—Ö –∏—Å–∫–∞–ª –æ–±–µ–∫—Ç–∏—Ç–µ –¥–∞ –Ω–µ —Å–∞ —Ç–æ–ª–∫–æ–≤–∞ –≥–æ–ª–µ–º–∏ –Ω–∞ —Ä–∞–∑–º–µ—Ä. –ù–µ–∫–∞ –¥–∞ –±—ä–¥–∞—Ç –ø–æ-–º–∞–ª–∫–∏. –ï—Ç–æ —á–∞—Å—Ç–∞ –∫–æ—è—Ç–æ –µ –≤ –º–æ–º–µ–Ω—Ç–∞ ... @push('css')
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    <style>
        .select2-container--bootstrap .select2-selection {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .select2-container--bootstrap .select2-selection:focus {
            border-color: #1cc88a;
            box-shadow: 0 0 0 0.2rem rgba(28, 200, 138, 0.25);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(28, 200, 138, 0.05);
        }
        .card-header {
            border-radius: 0.35rem 0.35rem 0 0 !important;
        }
        .input-group-text {
            background-color: #f8f9fc;
            border: 1px solid #d1d3e2;
        }
        .badge {
            font-size: 0.8em;
            padding: 0.35em 0.65em;
        }
        .list-group-item:hover {
            background-color: #1cc88a !important;
            color: white !important;
            cursor: pointer;
        }
        .list-group-item .customer-badge {
            font-size: 0.75em;
        }
        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        #customerInfo, #vehicleInfo {
            border-left: 4px solid #1cc88a;
        }
    </style>
@endpush ... –∏ –∞–∫–æ –º–æ–∂–µ –Ω–µ–∫–∞ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ —Ç–æ–≤–∞ –∫–æ–µ—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞ AdminLte
–ï—Ç–æ –æ–±–Ω–æ–≤–µ–Ω–∏—è CSS —á–∞—Å—Ç —Å –ø–æ-–º–∞–ª–∫–∏ —Ä–∞–∑–º–µ—Ä–∏ –∏ AdminLTE —Å—Ç–∏–ª–æ–≤–µ:

blade
@push('css')
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    <style>
        /* –ü–æ-–º–∞–ª–∫–∏ Select2 –∫–æ–Ω—Ç—Ä–æ–ª–∏ */
        .select2-container--bootstrap .select2-selection {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            height: calc(1.5em + 0.75rem + 2px);
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .select2-container--bootstrap .select2-selection--single .select2-selection__rendered {
            line-height: calc(1.5em + 0.75rem);
            padding-left: 0.375rem;
        }
        
        .select2-container--bootstrap .select2-selection:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .select2-container--bootstrap .select2-selection__arrow {
            height: calc(1.5em + 0.75rem);
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ —Ñ–æ—Ä–º–∏ */
        .form-control, .form-control-sm {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            height: calc(1.5em + 0.5rem + 2px);
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ –∫–∞—Ä—Ç–æ–Ω–∏ */
        .card {
            margin-bottom: 1rem;
        }
        
        .card-header {
            border-radius: 0.25rem 0.25rem 0 0 !important;
            padding: 0.5rem 1rem;
            font-size: 0.95rem;
        }
        
        .card-body {
            padding: 0.75rem;
        }
        
        /* –ü–æ-–º–∞–ª–∫–∞ —Ç–∞–±–ª–∏—Ü–∞ */
        .table-sm {
            font-size: 0.85rem;
        }
        
        .table-sm th,
        .table-sm td {
            padding: 0.3rem;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ –±—É—Ç–æ–Ω–∏ */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            line-height: 1.5;
            border-radius: 0.2rem;
        }
        
        .btn-lg {
            padding: 0.375rem 0.75rem;
            font-size: 0.9rem;
            line-height: 1.5;
            border-radius: 0.25rem;
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ –∏–Ω–ø—É—Ç –≥—Ä—É–ø–∏ */
        .input-group-sm > .form-control,
        .input-group-sm > .input-group-prepend > .input-group-text,
        .input-group-sm > .input-group-append > .input-group-text {
            height: calc(1.5em + 0.5rem + 2px);
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .input-group-text {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            font-size: 0.875rem;
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ badge */
        .badge {
            font-size: 0.7em;
            padding: 0.25em 0.5em;
        }
        
        /* –ê–≤—Ç–æ–¥–æ–ø—ä–ª–≤–∞–Ω–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ */
        .list-group-item {
            padding: 0.375rem 0.75rem;
            font-size: 0.85rem;
        }
        
        .list-group-item:hover {
            background-color: #007bff !important;
            color: white !important;
            cursor: pointer;
        }
        
        .list-group-item .customer-badge {
            font-size: 0.7em;
        }
        
        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        
        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∏ –ø–∞–Ω–µ–ª–∏ */
        #customerInfo, #vehicleInfo {
            border-left: 3px solid #007bff;
            padding: 0.5rem;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ –∑–∞–≥–ª–∞–≤–∏—è */
        h1 {
            font-size: 1.5rem;
        }
        
        h4 {
            font-size: 1.1rem;
        }
        
        h5 {
            font-size: 1rem;
        }
        
        /* –†–∞–∑—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ä–µ–¥–æ–≤–µ—Ç–µ */
        .row {
            margin-bottom: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 0.75rem;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç –∑–∞ –º–æ–±–∏–ª–Ω–∏ */
        @media (max-width: 768px) {
            .col-md-4, .col-md-3 {
                margin-bottom: 0.5rem;
            }
            
            .btn-lg {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
        
        /* AdminLTE –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è */
        .card.border-primary .card-header {
            background: linear-gradient(45deg, #007bff, #6610f2);
        }
        
        .card.border-success .card-header {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .card.border-warning .card-header {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }
        
        .card.border-info .card-header {
            background: linear-gradient(45deg, #17a2b8, #20c997);
        }
        
        /* –•–æ–≤–µ—Ä –µ—Ñ–µ–∫—Ç–∏ –∑–∞ –∫–∞—Ä—Ç–∏ */
        .card:hover {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: box-shadow 0.3s ease;
        }
        
        /* –ü–æ–¥–æ–±—Ä–µ–Ω —Ñ–æ–∫—É—Å –∑–∞ –∏–Ω–ø—É—Ç –ø–æ–ª–µ—Ç–∞ */
        .form-control:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        /* –ü–æ–¥–æ–±—Ä–µ–Ω –¥–∏–∑–∞–π–Ω –Ω–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ */
        #itemsTable thead {
            background-color: #f8f9fa;
        }
        
        #itemsTable tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ –∏–∫–æ–Ω–∫–∏ */
        .fas, .fa {
            font-size: 0.9em;
        }
        
        /* –¢—ä–Ω–∫–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ */
        hr {
            margin: 0.5rem 0;
            border-top: 1px solid #e9ecef;
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω–∏ —Å—É–º–∏ */
        .table-borderless td, .table-borderless th {
            padding: 0.1rem 0;
        }
    </style>
@endpush
–ò —Å—ä—â–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –æ–±–Ω–æ–≤–∏–º HTML —á–∞—Å—Ç—Ç–∞ –∑–∞ –¥–∞ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∞ –Ω–∞ –ø–æ-–º–∞–ª–∫–∏—Ç–µ —Ä–∞–∑–º–µ—Ä–∏. –ï—Ç–æ –∏ –æ–±–Ω–æ–≤–µ–Ω–∞—Ç–∞ HTML —á–∞—Å—Ç –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞ (—Å–∞–º–æ —Å–µ–∫—Ü–∏—è—Ç–∞ –∑–∞ –æ—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∫–∞—Ç–æ –ø—Ä–∏–º–µ—Ä):

blade
{{-- –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --}}
<div class="row">
    <div class="col-md-4">
        <div class="form-group">
            <label class="font-weight-bold text-primary">–ö–ª–∏–µ–Ω—Ç <span class="text-danger">*</span></label>
            <select name="customer_id" id="customer_id" class="form-control form-control-sm select2" 
                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç" required>
                <option value=""></option>
                @foreach($customers as $id => $name)
                    <option value="{{ $id }}">{{ $name }}</option>
                @endforeach
            </select>
            <div id="customerInfo" class="mt-1 p-2 bg-light rounded" style="display: none;">
                <small class="text-muted">
                    <i class="fas fa-user text-primary mr-1"></i>
                    <span id="customerName"></span><br>
                    <i class="fas fa-phone text-primary mr-1"></i>
                    <span id="customerPhone"></span><br>
                    <i class="fas fa-envelope text-primary mr-1"></i>
                    <span id="customerEmail"></span>
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-group">
            <label class="font-weight-bold text-primary">–ê–≤—Ç–æ–º–æ–±–∏–ª <span class="text-danger">*</span></label>
            <select name="vehicle_id" id="vehicle_id" class="form-control form-control-sm select2" required
                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª">
                <option value=""></option>
            </select>
            <div id="vehicleInfo" class="mt-1 p-2 bg-light rounded" style="display: none;">
                <small class="text-muted">
                    <i class="fas fa-car text-primary mr-1"></i>
                    <span id="vehicleMakeModel"></span><br>
                    <i class="fas fa-hashtag text-primary mr-1"></i>
                    –†–µ–≥. –Ω–æ–º–µ—Ä: <span id="vehiclePlate"></span><br>
                    <i class="fas fa-calendar text-primary mr-1"></i>
                    –ì–æ–¥–∏–Ω–∞: <span id="vehicleYear"></span><br>
                    <i class="fas fa-gas-pump text-primary mr-1"></i>
                    –î–≤–∏–≥–∞—Ç–µ–ª: <span id="vehicleEngine"></span>
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-group">
            <label class="font-weight-bold text-primary">–ú–µ—Ö–∞–Ω–∏–∫</label>
            <select name="assigned_to" class="form-control form-control-sm select2">
                <option value=""></option>
                @foreach($mechanics as $id => $name)
                    <option value="{{ $id }}">{{ $name }}</option>
                @endforeach
            </select>
            <small class="form-text text-muted">–ù–µ–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ</small>
        </div>
    </div>
</div>
–û—Å–Ω–æ–≤–Ω–∏ –ø—Ä–æ–º–µ–Ω–∏ –∑–∞ –ø–æ-–º–∞–ª–∫–∏ —Ä–∞–∑–º–µ—Ä–∏:

form-control-sm –∫–ª–∞—Å –∑–∞ –ø–æ-–º–∞–ª–∫–∏ —Ñ–æ—Ä–º–∏

btn-sm –∑–∞ –ø–æ-–º–∞–ª–∫–∏ –±—É—Ç–æ–Ω–∏

table-sm –∑–∞ –ø–æ-–º–∞–ª–∫–∞ —Ç–∞–±–ª–∏—Ü–∞

input-group-sm –∑–∞ –ø–æ-–º–∞–ª–∫–∏ –∏–Ω–ø—É—Ç –≥—Ä—É–ø–∏

–ü–æ-–º–∞–ª–∫–∏ padding –∏ margin —Å—Ç–æ–π–Ω–æ—Å—Ç–∏

–ü–æ-–º–∞–ª–∫–∏ font sizes (0.875rem –≤–º–µ—Å—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—è 1rem)

–ü–æ-–∫–æ–º–ø–∞–∫—Ç–Ω–æ —Ä–∞–∑–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∏—Ç–µ

AdminLTE –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è:

–ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∏ —Ü–≤–µ—Ç–æ–≤–µ –∑–∞ card headers

–ü–æ–¥–æ–±—Ä–µ–Ω–∏ —Ö–æ–≤–µ—Ä –µ—Ñ–µ–∫—Ç–∏

AdminLTE —Ü–≤–µ—Ç–æ–≤–∞ —Å—Ö–µ–º–∞ (primary, success, warning, info)

Responsive –¥–∏–∑–∞–π–Ω –∑–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

–¢–æ–≤–∞ —â–µ –Ω–∞–ø—Ä–∞–≤–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –ø–æ-–∫–æ–º–ø–∞–∫—Ç–Ω–∞ –∏ –ø–æ-–ª–µ—Å–Ω–∞ –∑–∞ —Ä–∞–±–æ—Ç–∞, –æ—Å–æ–±–µ–Ω–æ –∞–∫–æ –∏–º–∞—à –º–Ω–æ–≥–æ –ø–æ–ª–µ—Ç–∞.

–û—Ç–ª–∏—á–Ω–æ! –°–µ–≥–∞ –æ–±–∞—á–µ –∏—Å–∫–∞–º –¥–∞ –¥–æ–±–∞–≤–∏–º –∏ –£–°–õ–£–ì–ê. –ò–º–∞–º–∞ –ü–†–û–î–£–ö–¢–ò https://github.com/gvalkov-72/autoservice/tree/main/resources/views/admin/products ... –Ω–æ –Ω—è–º–∞–º –£—Å–ª—É–≥–∞ –∫–∞–∫—Ç–æ –≤–∏–∂–¥–∞—à. –ú–æ–ª—è —Ç–µ –Ω–µ–∫–∞ —è —Å—ä–∑–¥–∞–¥–µ–º –ø–æ –ø–æ–¥–æ–±–µ–Ω –Ω–∞—á–∏–Ω –∫–∞–∫—Ç–æ –µ —Å—ä–∑–¥–∞–¥–µ–Ω –ü—Ä–æ–¥—É–∫—Ç–∏.
–©–µ —Å—ä–∑–¥–∞–¥–µ–º –º–æ–¥—É–ª –∑–∞ –£—Å–ª—É–≥–∏, –ø–æ–¥–æ–±–µ–Ω –Ω–∞ –ü—Ä–æ–¥—É–∫—Ç–∏—Ç–µ. –¢—Ä—è–±–≤–∞ –¥–∞ —Å—ä–∑–¥–∞–¥–µ–º —Å–ª–µ–¥–Ω–∏—Ç–µ —Ñ–∞–π–ª–æ–≤–µ:

1. –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞ —Ç–∞–±–ª–∏—Ü–∞ services
bash
php artisan make:migration create_services_table
–ï—Ç–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è—Ç–∞:

php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up()
    {
        Schema::create('services', function (Blueprint $table) {
            $table->id();
            $table->string('code')->unique();
            $table->string('name');
            $table->text('description')->nullable();
            $table->decimal('price', 10, 2);
            $table->decimal('vat_percent', 5, 2)->default(20.00);
            $table->integer('duration_minutes')->nullable()->comment('–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç –≤ –º–∏–Ω—É—Ç–∏');
            $table->boolean('is_active')->default(true);
            $table->unsignedBigInteger('category_id')->nullable();
            $table->text('notes')->nullable();
            $table->timestamps();
            $table->softDeletes();

            $table->foreign('category_id')->references('id')->on('service_categories')->onDelete('set null');
            $table->index('code');
            $table->index('name');
            $table->index('is_active');
        });
    }

    public function down()
    {
        Schema::dropIfExists('services');
    }
};
2. –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ —É—Å–ª—É–≥–∏
bash
php artisan make:migration create_service_categories_table
php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up()
    {
        Schema::create('service_categories', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('description')->nullable();
            $table->integer('sort_order')->default(0);
            $table->boolean('is_active')->default(true);
            $table->timestamps();
            $table->softDeletes();

            $table->index('name');
            $table->index('sort_order');
            $table->index('is_active');
        });
    }

    public function down()
    {
        Schema::dropIfExists('service_categories');
    }
};
3. –ú–æ–¥–µ–ª Service.php
php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

class Service extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = [
        'code',
        'name',
        'description',
        'price',
        'vat_percent',
        'duration_minutes',
        'is_active',
        'category_id',
        'notes',
    ];

    protected $casts = [
        'price' => 'decimal:2',
        'vat_percent' => 'decimal:2',
        'duration_minutes' => 'integer',
        'is_active' => 'boolean',
    ];

    public function category()
    {
        return $this->belongsTo(ServiceCategory::class, 'category_id');
    }

    public function workOrderItems()
    {
        return $this->hasMany(WorkOrderItem::class);
    }

    public function scopeActive($query)
    {
        return $query->where('is_active', true);
    }

    public function scopeOrdered($query)
    {
        return $query->orderBy('name');
    }

    public function getPriceWithVatAttribute()
    {
        return $this->price * (1 + $this->vat_percent / 100);
    }
}
4. –ú–æ–¥–µ–ª ServiceCategory.php
php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

class ServiceCategory extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = [
        'name',
        'description',
        'sort_order',
        'is_active',
    ];

    protected $casts = [
        'is_active' => 'boolean',
    ];

    public function services()
    {
        return $this->hasMany(Service::class);
    }

    public function scopeActive($query)
    {
        return $query->where('is_active', true);
    }

    public function scopeOrdered($query)
    {
        return $query->orderBy('sort_order')->orderBy('name');
    }
}
5. –ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä ServiceController.php
php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Service;
use App\Models\ServiceCategory;
use Illuminate\Http\Request;

class ServiceController extends Controller
{
    public function index()
    {
        $services = Service::with('category')
            ->orderBy('name')
            ->paginate(20);
            
        return view('admin.services.index', compact('services'));
    }

    public function create()
    {
        $categories = ServiceCategory::active()->ordered()->pluck('name', 'id');
        return view('admin.services.create', compact('categories'));
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'code' => 'required|unique:services,code|max:50',
            'name' => 'required|max:255',
            'description' => 'nullable|string',
            'price' => 'required|numeric|min:0',
            'vat_percent' => 'required|numeric|min:0|max:100',
            'duration_minutes' => 'nullable|integer|min:1',
            'is_active' => 'boolean',
            'category_id' => 'nullable|exists:service_categories,id',
            'notes' => 'nullable|string',
        ]);

        Service::create($validated);

        return redirect()->route('admin.services.index')
            ->with('success', '–£—Å–ª—É–≥–∞—Ç–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.');
    }

    public function show(Service $service)
    {
        $service->load('category');
        return view('admin.services.show', compact('service'));
    }

    public function edit(Service $service)
    {
        $categories = ServiceCategory::active()->ordered()->pluck('name', 'id');
        return view('admin.services.edit', compact('service', 'categories'));
    }

    public function update(Request $request, Service $service)
    {
        $validated = $request->validate([
            'code' => 'required|unique:services,code,' . $service->id . '|max:50',
            'name' => 'required|max:255',
            'description' => 'nullable|string',
            'price' => 'required|numeric|min:0',
            'vat_percent' => 'required|numeric|min:0|max:100',
            'duration_minutes' => 'nullable|integer|min:1',
            'is_active' => 'boolean',
            'category_id' => 'nullable|exists:service_categories,id',
            'notes' => 'nullable|string',
        ]);

        $service->update($validated);

        return redirect()->route('admin.services.index')
            ->with('success', '–£—Å–ª—É–≥–∞—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.');
    }

    public function destroy(Service $service)
    {
        $service->delete();

        return redirect()->route('admin.services.index')
            ->with('success', '–£—Å–ª—É–≥–∞—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞ —É—Å–ø–µ—à–Ω–æ.');
    }
}
6. –ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä ServiceCategoryController.php
php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\ServiceCategory;
use Illuminate\Http\Request;

class ServiceCategoryController extends Controller
{
    public function index()
    {
        $categories = ServiceCategory::ordered()->paginate(20);
        return view('admin.service-categories.index', compact('categories'));
    }

    public function create()
    {
        return view('admin.service-categories.create');
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'name' => 'required|max:255|unique:service_categories,name',
            'description' => 'nullable|string',
            'sort_order' => 'nullable|integer',
            'is_active' => 'boolean',
        ]);

        ServiceCategory::create($validated);

        return redirect()->route('admin.service-categories.index')
            ->with('success', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è—Ç–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.');
    }

    public function show(ServiceCategory $category)
    {
        return view('admin.service-categories.show', compact('category'));
    }

    public function edit(ServiceCategory $category)
    {
        return view('admin.service-categories.edit', compact('category'));
    }

    public function update(Request $request, ServiceCategory $category)
    {
        $validated = $request->validate([
            'name' => 'required|max:255|unique:service_categories,name,' . $category->id,
            'description' => 'nullable|string',
            'sort_order' => 'nullable|integer',
            'is_active' => 'boolean',
        ]);

        $category->update($validated);

        return redirect()->route('admin.service-categories.index')
            ->with('success', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.');
    }

    public function destroy(ServiceCategory $category)
    {
        if ($category->services()->count() > 0) {
            return redirect()->route('admin.service-categories.index')
                ->with('error', '–ù–µ –º–æ–∂–µ—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –∫–æ—è—Ç–æ –∏–º–∞ —É—Å–ª—É–≥–∏.');
        }

        $category->delete();

        return redirect()->route('admin.service-categories.index')
            ->with('success', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞ —É—Å–ø–µ—à–Ω–æ.');
    }
}
7. Views –∑–∞ –£—Å–ª—É–≥–∏
–°—ä–∑–¥–∞–π —Å–ª–µ–¥–Ω–∏—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ —Ñ–∞–π–ª–æ–≤–µ:

resources/views/admin/services/index.blade.php
blade
@extends('adminlte::page')

@section('title', '–£—Å–ª—É–≥–∏')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1>–£—Å–ª—É–≥–∏</h1>
        <a href="{{ route('admin.services.create') }}" class="btn btn-success">
            <i class="fas fa-plus mr-1"></i> –ù–æ–≤–∞ —É—Å–ª—É–≥–∞
        </a>
    </div>
@stop

@section('content')
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>–ö–æ–¥</th>
                            <th>–ò–º–µ</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–î–î–°</th>
                            <th>–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach($services as $service)
                            <tr>
                                <td>
                                    <strong>{{ $service->code }}</strong>
                                </td>
                                <td>{{ $service->name }}</td>
                                <td>
                                    @if($service->category)
                                        <span class="badge badge-info">{{ $service->category->name }}</span>
                                    @else
                                        <span class="text-muted">-</span>
                                    @endif
                                </td>
                                <td>
                                    <strong>{{ number_format($service->price, 2) }} –ª–≤.</strong>
                                </td>
                                <td>{{ $service->vat_percent }}%</td>
                                <td>
                                    @if($service->duration_minutes)
                                        {{ $service->duration_minutes }} –º–∏–Ω.
                                    @else
                                        <span class="text-muted">-</span>
                                    @endif
                                </td>
                                <td>
                                    @if($service->is_active)
                                        <span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                    @else
                                        <span class="badge badge-secondary">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
                                    @endif
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ route('admin.services.show', $service) }}" 
                                           class="btn btn-info" title="–ü—Ä–µ–≥–ª–µ–¥">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ route('admin.services.edit', $service) }}" 
                                           class="btn btn-warning" title="–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form action="{{ route('admin.services.destroy', $service) }}" 
                                              method="POST" class="d-inline">
                                            @csrf
                                            @method('DELETE')
                                            <button type="submit" class="btn btn-danger" 
                                                    title="–ò–∑—Ç—Ä–∏–π"
                                                    onclick="return confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ?')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3">
                {{ $services->links() }}
            </div>
        </div>
    </div>
@stop
resources/views/admin/services/create.blade.php
blade
@extends('adminlte::page')

@section('title', '–ù–æ–≤–∞ —É—Å–ª—É–≥–∞')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1>–ù–æ–≤–∞ —É—Å–ª—É–≥–∞</h1>
        <a href="{{ route('admin.services.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-1"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
@stop

@section('content')
    <div class="card">
        <div class="card-body">
            <form action="{{ route('admin.services.store') }}" method="POST">
                @csrf
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="code">–ö–æ–¥ <span class="text-danger">*</span></label>
                            <input type="text" name="code" id="code" 
                                   class="form-control @error('code') is-invalid @enderror"
                                   value="{{ old('code') }}" required>
                            @error('code')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                            <small class="form-text text-muted">–£–Ω–∏–∫–∞–ª–µ–Ω –∫–æ–¥ –∑–∞ —É—Å–ª—É–≥–∞—Ç–∞</small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="name">–ò–º–µ <span class="text-danger">*</span></label>
                            <input type="text" name="name" id="name" 
                                   class="form-control @error('name') is-invalid @enderror"
                                   value="{{ old('name') }}" required>
                            @error('name')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" id="description" rows="3"
                              class="form-control @error('description') is-invalid @enderror">{{ old('description') }}</textarea>
                    @error('description')
                        <span class="invalid-feedback">{{ $message }}</span>
                    @enderror
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="price">–¶–µ–Ω–∞ (–±–µ–∑ –î–î–°) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" name="price" id="price" step="0.01" min="0"
                                       class="form-control @error('price') is-invalid @enderror"
                                       value="{{ old('price') }}" required>
                                <div class="input-group-append">
                                    <span class="input-group-text">–ª–≤.</span>
                                </div>
                            </div>
                            @error('price')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="vat_percent">–î–î–° % <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" name="vat_percent" id="vat_percent" step="0.01" min="0" max="100"
                                       class="form-control @error('vat_percent') is-invalid @enderror"
                                       value="{{ old('vat_percent', 20) }}" required>
                                <div class="input-group-append">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            @error('vat_percent')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="duration_minutes">–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</label>
                            <div class="input-group">
                                <input type="number" name="duration_minutes" id="duration_minutes" min="1"
                                       class="form-control @error('duration_minutes') is-invalid @enderror"
                                       value="{{ old('duration_minutes') }}">
                                <div class="input-group-append">
                                    <span class="input-group-text">–º–∏–Ω.</span>
                                </div>
                            </div>
                            @error('duration_minutes')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="category_id">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select name="category_id" id="category_id" 
                                    class="form-control select2 @error('category_id') is-invalid @enderror">
                                <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                                @foreach($categories as $id => $name)
                                    <option value="{{ $id }}" {{ old('category_id') == $id ? 'selected' : '' }}>
                                        {{ $name }}
                                    </option>
                                @endforeach
                            </select>
                            @error('category_id')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="is_active">–°—Ç–∞—Ç—É—Å</label>
                            <select name="is_active" id="is_active" 
                                    class="form-control @error('is_active') is-invalid @enderror">
                                <option value="1" {{ old('is_active', 1) ? 'selected' : '' }}>–ê–∫—Ç–∏–≤–Ω–∞</option>
                                <option value="0" {{ !old('is_active', 1) ? 'selected' : '' }}>–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</option>
                            </select>
                            @error('is_active')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notes">–ë–µ–ª–µ–∂–∫–∏</label>
                    <textarea name="notes" id="notes" rows="2"
                              class="form-control @error('notes') is-invalid @enderror">{{ old('notes') }}</textarea>
                    @error('notes')
                        <span class="invalid-feedback">{{ $message }}</span>
                    @enderror
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save mr-1"></i> –ó–∞–ø–∞–∑–∏ —É—Å–ª—É–≥–∞
                    </button>
                    <a href="{{ route('admin.services.index') }}" class="btn btn-secondary">
                        –û—Ç–∫–∞–∑
                    </a>
                </div>
            </form>
        </div>
    </div>
@stop

@push('css')
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
@endpush

@push('js')
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $('.select2').select2({
            theme: 'bootstrap'
        });
    });
</script>
@endpush
resources/views/admin/services/edit.blade.php
blade
@extends('adminlte::page')

@section('title', '–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —É—Å–ª—É–≥–∞')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1>–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —É—Å–ª—É–≥–∞: {{ $service->name }}</h1>
        <a href="{{ route('admin.services.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-1"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
@stop

@section('content')
    <div class="card">
        <div class="card-body">
            <form action="{{ route('admin.services.update', $service) }}" method="POST">
                @csrf
                @method('PUT')
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="code">–ö–æ–¥ <span class="text-danger">*</span></label>
                            <input type="text" name="code" id="code" 
                                   class="form-control @error('code') is-invalid @enderror"
                                   value="{{ old('code', $service->code) }}" required>
                            @error('code')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="name">–ò–º–µ <span class="text-danger">*</span></label>
                            <input type="text" name="name" id="name" 
                                   class="form-control @error('name') is-invalid @enderror"
                                   value="{{ old('name', $service->name) }}" required>
                            @error('name')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" id="description" rows="3"
                              class="form-control @error('description') is-invalid @enderror">{{ old('description', $service->description) }}</textarea>
                    @error('description')
                        <span class="invalid-feedback">{{ $message }}</span>
                    @enderror
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="price">–¶–µ–Ω–∞ (–±–µ–∑ –î–î–°) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" name="price" id="price" step="0.01" min="0"
                                       class="form-control @error('price') is-invalid @enderror"
                                       value="{{ old('price', $service->price) }}" required>
                                <div class="input-group-append">
                                    <span class="input-group-text">–ª–≤.</span>
                                </div>
                            </div>
                            @error('price')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="vat_percent">–î–î–° % <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" name="vat_percent" id="vat_percent" step="0.01" min="0" max="100"
                                       class="form-control @error('vat_percent') is-invalid @enderror"
                                       value="{{ old('vat_percent', $service->vat_percent) }}" required>
                                <div class="input-group-append">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            @error('vat_percent')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="duration_minutes">–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</label>
                            <div class="input-group">
                                <input type="number" name="duration_minutes" id="duration_minutes" min="1"
                                       class="form-control @error('duration_minutes') is-invalid @enderror"
                                       value="{{ old('duration_minutes', $service->duration_minutes) }}">
                                <div class="input-group-append">
                                    <span class="input-group-text">–º–∏–Ω.</span>
                                </div>
                            </div>
                            @error('duration_minutes')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="category_id">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select name="category_id" id="category_id" 
                                    class="form-control select2 @error('category_id') is-invalid @enderror">
                                <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                                @foreach($categories as $id => $name)
                                    <option value="{{ $id }}" 
                                        {{ old('category_id', $service->category_id) == $id ? 'selected' : '' }}>
                                        {{ $name }}
                                    </option>
                                @endforeach
                            </select>
                            @error('category_id')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="is_active">–°—Ç–∞—Ç—É—Å</label>
                            <select name="is_active" id="is_active" 
                                    class="form-control @error('is_active') is-invalid @enderror">
                                <option value="1" {{ old('is_active', $service->is_active) ? 'selected' : '' }}>–ê–∫—Ç–∏–≤–Ω–∞</option>
                                <option value="0" {{ !old('is_active', $service->is_active) ? 'selected' : '' }}>–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</option>
                            </select>
                            @error('is_active')
                                <span class="invalid-feedback">{{ $message }}</span>
                            @enderror
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notes">–ë–µ–ª–µ–∂–∫–∏</label>
                    <textarea name="notes" id="notes" rows="2"
                              class="form-control @error('notes') is-invalid @enderror">{{ old('notes', $service->notes) }}</textarea>
                    @error('notes')
                        <span class="invalid-feedback">{{ $message }}</span>
                    @enderror
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-1"></i> –ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ
                    </button>
                    <a href="{{ route('admin.services.index') }}" class="btn btn-secondary">
                        –û—Ç–∫–∞–∑
                    </a>
                </div>
            </form>
        </div>
    </div>
@stop

@push('css')
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
@endpush

@push('js')
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $('.select2').select2({
            theme: 'bootstrap'
        });
    });
</script>
@endpush
resources/views/admin/services/show.blade.php
blade
@extends('adminlte::page')

@section('title', '–£—Å–ª—É–≥–∞: ' . $service->name)

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1>–£—Å–ª—É–≥–∞: {{ $service->name }}</h1>
        <div>
            <a href="{{ route('admin.services.edit', $service) }}" class="btn btn-warning">
                <i class="fas fa-edit mr-1"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π
            </a>
            <a href="{{ route('admin.services.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left mr-1"></i> –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>
@stop

@section('content')
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">–û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <tr>
                            <th width="30%">–ö–æ–¥:</th>
                            <td><strong>{{ $service->code }}</strong></td>
                        </tr>
                        <tr>
                            <th>–ò–º–µ:</th>
                            <td>{{ $service->name }}</td>
                        </tr>
                        <tr>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</th>
                            <td>
                                @if($service->category)
                                    <span class="badge badge-info">{{ $service->category->name }}</span>
                                @else
                                    <span class="text-muted">-</span>
                                @endif
                            </td>
                        </tr>
                        <tr>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ:</th>
                            <td>{{ $service->description ?: '-' }}</td>
                        </tr>
                        <tr>
                            <th>–¶–µ–Ω–∞ (–±–µ–∑ –î–î–°):</th>
                            <td><strong>{{ number_format($service->price, 2) }} –ª–≤.</strong></td>
                        </tr>
                        <tr>
                            <th>–î–î–°:</th>
                            <td>{{ $service->vat_percent }}%</td>
                        </tr>
                        <tr>
                            <th>–¶–µ–Ω–∞ —Å –î–î–°:</th>
                            <td><strong class="text-success">{{ number_format($service->price_with_vat, 2) }} –ª–≤.</strong></td>
                        </tr>
                        <tr>
                            <th>–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç:</th>
                            <td>
                                @if($service->duration_minutes)
                                    {{ $service->duration_minutes }} –º–∏–Ω—É—Ç–∏
                                @else
                                    <span class="text-muted">-</span>
                                @endif
                            </td>
                        </tr>
                        <tr>
                            <th>–°—Ç–∞—Ç—É—Å:</th>
                            <td>
                                @if($service->is_active)
                                    <span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                @else
                                    <span class="badge badge-secondary">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
                                @endif
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            @if($service->notes)
            <div class="card mt-3">
                <div class="card-header">
                    <h3 class="card-title">–ë–µ–ª–µ–∂–∫–∏</h3>
                </div>
                <div class="card-body">
                    {{ $service->notes }}
                </div>
            </div>
            @endif
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">–î–µ—Ç–∞–π–ª–∏</h3>
                </div>
                <div class="card-body">
                    <div class="info-box">
                        <span class="info-box-icon bg-info">
                            <i class="fas fa-calendar-alt"></i>
                        </span>
                        <div class="info-box-content">
                            <span class="info-box-text">–°—ä–∑–¥–∞–¥–µ–Ω–∞ –Ω–∞</span>
                            <span class="info-box-number">
                                {{ $service->created_at->format('d.m.Y H:i') }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="info-box mt-2">
                        <span class="info-box-icon bg-success">
                            <i class="fas fa-sync-alt"></i>
                        </span>
                        <div class="info-box-content">
                            <span class="info-box-text">–ü–æ—Å–ª–µ–¥–Ω–∞ –ø—Ä–æ–º—è–Ω–∞</span>
                            <span class="info-box-number">
                                {{ $service->updated_at->format('d.m.Y H:i') }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h3 class="card-title">–î–µ–π—Å—Ç–≤–∏—è</h3>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ route('admin.services.edit', $service) }}" 
                           class="btn btn-warning btn-block">
                            <i class="fas fa-edit mr-1"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —É—Å–ª—É–≥–∞
                        </a>
                        
                        <form action="{{ route('admin.services.destroy', $service) }}" 
                              method="POST" class="d-grid">
                            @csrf
                            @method('DELETE')
                            <button type="submit" class="btn btn-danger btn-block"
                                    onclick="return confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–∞–∑–∏ —É—Å–ª—É–≥–∞?')">
                                <i class="fas fa-trash mr-1"></i> –ò–∑—Ç—Ä–∏–π —É—Å–ª—É–≥–∞
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
@stop
8. Views –∑–∞ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ —É—Å–ª—É–≥–∏
–°—ä–∑–¥–∞–π —Å—ä—â–∏—Ç–µ —Ñ–∞–π–ª–æ–≤–µ –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏—Ç–µ –≤ resources/views/admin/service-categories/:

index.blade.php

create.blade.php

edit.blade.php

show.blade.php

–¢–µ —â–µ –±—ä–¥–∞—Ç –º–Ω–æ–≥–æ –ø–æ–¥–æ–±–Ω–∏ –Ω–∞ —Ç–µ–∑–∏ –∑–∞ —É—Å–ª—É–≥–∏—Ç–µ.

9. –î–æ–±–∞–≤–∏ –º–∞—Ä—à—Ä—É—Ç–∏ –≤ web.php
–î–æ–±–∞–≤–∏ —Å–ª–µ–¥–Ω–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏:

php
// –í admin –≥—Ä—É–ø–∞—Ç–∞
Route::resource('services', \App\Http\Controllers\Admin\ServiceController::class);
Route::resource('service-categories', \App\Http\Controllers\Admin\ServiceCategoryController::class);
10. Seed –¥–∞–Ω–Ω–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)
–°—ä–∑–¥–∞–π seeder –∑–∞ —Ç–µ—Å—Ç–æ–≤–∏ –¥–∞–Ω–Ω–∏:

bash
php artisan make:seeder ServiceSeeder
php
<?php

namespace Database\Seeders;

use App\Models\Service;
use App\Models\ServiceCategory;
use Illuminate\Database\Seeder;

class ServiceSeeder extends Seeder
{
    public function run()
    {
        $categories = [
            ['name' => '–†–µ–º–æ–Ω—Ç –Ω–∞ –¥–≤–∏–≥–∞—Ç–µ–ª', 'sort_order' => 1],
            ['name' => '–°–ø–∏—Ä–∞—á–Ω–∞ —Å–∏—Å—Ç–µ–º–∞', 'sort_order' => 2],
            ['name' => '–û–∫–∞—á–≤–∞–Ω–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', 'sort_order' => 3],
            ['name' => '–ï–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∞ —Å–∏—Å—Ç–µ–º–∞', 'sort_order' => 4],
            ['name' => '–û–±—Å–ª—É–∂–≤–∞–Ω–µ', 'sort_order' => 5],
        ];

        foreach ($categories as $category) {
            ServiceCategory::create($category);
        }

        $services = [
            ['code' => 'SERV-001', 'name' => '–°–º—è–Ω–∞ –Ω–∞ –º–∞—Å–ª–æ –∏ —Ñ–∏–ª—Ç—ä—Ä', 'price' => 30.00, 'category_id' => 5],
            ['code' => 'SERV-002', 'name' => '–†–µ–º–æ–Ω—Ç –Ω–∞ —Å–ø–∏—Ä–∞—á–∫–∏', 'price' => 80.00, 'category_id' => 2],
            ['code' => 'SERV-003', 'name' => '–°–º—è–Ω–∞ –Ω–∞ –∞–∫—É–º—É–ª–∞—Ç–æ—Ä', 'price' => 25.00, 'category_id' => 4],
            ['code' => 'SERV-004', 'name' => '–†–µ–º–æ–Ω—Ç –Ω–∞ –æ–∫–∞—á–≤–∞–Ω–µ', 'price' => 120.00, 'category_id' => 3],
            ['code' => 'SERV-005', 'name' => '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞ –¥–≤–∏–≥–∞—Ç–µ–ª', 'price' => 50.00, 'category_id' => 1],
        ];

        foreach ($services as $service) {
            Service::create(array_merge($service, [
                'vat_percent' => 20.00,
                'duration_minutes' => 60,
                'is_active' => true,
            ]));
        }
    }
}
11. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–∞–π WorkOrderController –¥–∞ –≤–∫–ª—é—á–≤–∞ –∏ —É—Å–ª—É–≥–∏
–í WorkOrderController::create() –¥–æ–±–∞–≤–∏:

php
$services = Service::active()->ordered()->get();
return view('admin.work-orders.create', compact('customers', 'vehicles', 'mechanics', 'products', 'services'));
–ò —Å—ä—â–æ –≤ edit() –º–µ—Ç–æ–¥–∞.

12. –û–±–Ω–æ–≤–∏ create.blade.php –∑–∞ WorkOrders
–î–æ–±–∞–≤–∏ —É—Å–ª—É–≥–∏—Ç–µ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ø–æ–∑–∏—Ü–∏–∏:

blade
{{-- –í JavaScript —á–∞—Å—Ç—Ç–∞ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ —Ä–µ–¥ --}}
function addRow(productType = 'product', predefinedProduct = null) {
    rowIdx++;
    const isService = productType === 'service';
    
    let productOptions = '<option value=""></option>';
    
    if (isService) {
        // –î–æ–±–∞–≤–∏ —É—Å–ª—É–≥–∏
        @if(isset($services) && $services->count())
            @foreach($services as $service)
                productOptions += `
                    <option value="service_{{ $service->id }}" 
                            data-price="{{ $service->price }}" 
                            data-vat="{{ $service->vat_percent }}"
                            data-type="service">
                        {{ $service->code }} - {{ $service->name }}
                    </option>`;
            @endforeach
        @endif
    } else {
        // –î–æ–±–∞–≤–∏ –ø—Ä–æ–¥—É–∫—Ç–∏
        @if(isset($products) && $products->count())
            @foreach($products as $product)
                productOptions += `
                    <option value="product_{{ $product->id }}" 
                            data-price="{{ $product->price }}" 
                            data-vat="{{ $product->vat_percent }}"
                            data-type="product">
                        {{ $product->sku }} - {{ $product->name }}
                    </option>`;
            @endforeach
        @endif
    }
    
    // ... –æ—Å—Ç–∞–Ω–∞–ª–∞—Ç–∞ —á–∞—Å—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞
}
–°–µ–≥–∞ –∏–º–∞—à –ø—ä–ª–µ–Ω –º–æ–¥—É–ª –∑–∞ –£—Å–ª—É–≥–∏ –ø–æ–¥–æ–±–µ–Ω –Ω–∞ –ü—Ä–æ–¥—É–∫—Ç–∏—Ç–µ!

–û—Ç–ª–∏—á–Ω–æ! –°–∞–º–æ —á–µ —â–µ —Ç–µ –ø–æ–º–æ–ª—è –¥–∞ –¥–æ–±–∞–≤–∏—à —Ç–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏ –≤ routes\web.php –∏ –¥–∞ –º–∏ –≥–æ –ø–æ–¥–∞–¥–µ—à —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω —Ü–µ–ª–∏—è. –°—ä—â–æ —Ç–∞–∫–∞ –¥–∞ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–∞—à WorkOrderController –∏ –¥–∞ –º–∏ –≥–æ –ø–æ–¥–∞–¥–µ—à –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–∞–Ω —Ü–µ–ª–∏—è. –ò —Å—ä—â–æ —Ç–∞–∫–∞ –¥–∞ –¥–æ–±–∞–≤–∏—à —É—Å–ª—É–≥–∏—Ç–µ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ –∏ –¥–∞ –æ–±–Ω–æ–≤–∏—à create.blade.php –∑–∞ WorkOrders —Å–ª–µ–¥ –∫–æ–µ—Ç–æ –¥–∞ –º–∏ –≥–æ –ø–æ–¥–∞–¥–µ—à –æ–±–Ω–æ–≤–µ–Ω —Ü–µ–ª–∏—è.
–©–µ –∏–∑–ø—ä–ª–Ω—è –≤—Å–∏—á–∫–∏—Ç–µ —Ç–∏ –∏—Å–∫–∞–Ω–∏—è. –ï—Ç–æ –≥–∏ —Ñ–∞–π–ª–æ–≤–µ—Ç–µ:

1. routes/web.php (–æ–±–Ω–æ–≤–µ–Ω)
php
<?php

use App\Http\Controllers\ProfileController;
use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
*/

Route::get('/', fn() => redirect()->route('login'));

Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware(['auth', 'verified'])->name('dashboard');

/* --------------------------------------------------------------------------
   –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å –ø—Ä–∞–≤–∞)
--------------------------------------------------------------------------*/
Route::middleware(['auth', 'verified'])->prefix('admin')->name('admin.')->group(function () {

    /* --- –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø (—Å–∞–º–æ admin) --- */
    Route::middleware(['can:admin'])->group(function () {
        Route::resource('users',       \App\Http\Controllers\Admin\UserController::class);
        Route::resource('roles',       \App\Http\Controllers\Admin\RoleController::class);
        Route::resource('permissions', \App\Http\Controllers\Admin\PermissionController::class);
    });

    /* --- –û–°–ù–û–í–ù–ò –ú–û–î–£–õ–ò --- */
    Route::resource('customers',   \App\Http\Controllers\Admin\CustomerController::class);
    Route::resource('vehicles',    \App\Http\Controllers\Admin\VehicleController::class);
    Route::resource('products',    \App\Http\Controllers\Admin\ProductController::class);
    Route::resource('services',    \App\Http\Controllers\Admin\ServiceController::class);
    Route::resource('service-categories', \App\Http\Controllers\Admin\ServiceCategoryController::class);
    Route::resource('work-orders', \App\Http\Controllers\Admin\WorkOrderController::class);
    Route::resource('invoices',    \App\Http\Controllers\Admin\InvoiceController::class);

    /* --- EXPORT-–∏ –∑–∞ Customer --- */
    Route::get('customers/{customer}/export/pdf', [\App\Http\Controllers\Admin\CustomerController::class, 'exportPdf'])
        ->name('customers.export.pdf');
    Route::get('customers/{customer}/export/excel', [\App\Http\Controllers\Admin\CustomerController::class, 'exportExcel'])
        ->name('customers.export.excel');
    Route::get('customers/{customer}/export/csv', [\App\Http\Controllers\Admin\CustomerController::class, 'exportCsv'])
        ->name('customers.export.csv');

    /* --- EXPORT-–∏ –∑–∞ Vehicle --- */
    Route::get('vehicles/{vehicle}/export/pdf', [\App\Http\Controllers\Admin\VehicleController::class, 'exportPdf'])->name('vehicles.export.pdf');
    Route::get('vehicles/{vehicle}/export/excel', [\App\Http\Controllers\Admin\VehicleController::class, 'exportExcel'])->name('vehicles.export.excel');
    Route::get('vehicles/{vehicle}/export/csv', [\App\Http\Controllers\Admin\VehicleController::class, 'exportCsv'])->name('vehicles.export.csv');

    /* --- –°–ö–õ–ê–î --- */
    Route::prefix('stock')->name('stock.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\StockController::class, 'index'])->name('index');
        Route::get('/create-purchase', [\App\Http\Controllers\Admin\StockController::class, 'createPurchase'])->name('create-purchase');
        Route::post('/store-purchase', [\App\Http\Controllers\Admin\StockController::class, 'storePurchase'])->name('store-purchase');
        Route::get('/create-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'createAdjustment'])->name('create-adjustment');
        Route::post('/store-adjustment', [\App\Http\Controllers\Admin\StockController::class, 'storeAdjustment'])->name('store-adjustment');
    });

    /* --- –ü–õ–ê–©–ê–ù–ò–Ø --- */
    Route::prefix('payments')->name('payments.')->group(function () {
        Route::get('/', [\App\Http\Controllers\Admin\PaymentController::class, 'index'])->name('index');
        Route::get('/create', [\App\Http\Controllers\Admin\PaymentController::class, 'create'])->name('create');
        Route::post('/store', [\App\Http\Controllers\Admin\PaymentController::class, 'store'])->name('store');
        Route::get('/{payment}/pdf', [\App\Http\Controllers\Admin\PaymentController::class, 'pdf'])->name('pdf');
    });

    /* --- –ë–ê–†–ö–û–î / PLU --- */
    Route::get('barcode/{code}.png', function (string $code) {
        return response(\App\Support\BarcodeHelper::png($code))->header('Content-Type', 'image/png');
    })->name('barcode.png');

    Route::get('products/{product}/barcode', [\App\Http\Controllers\Admin\ProductController::class, 'barcode'])
        ->name('products.barcode');

    Route::get('api/product-by-sku/{sku}', function (string $sku) {
        return \App\Models\Product::where('sku', $sku)->first() ?? [];
    })->name('api.product-by-sku');

    /* --- AJAX API –∑–∞ Work Orders --- */
    Route::prefix('api')->name('api.')->group(function () {
        // –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ autocomplete
        Route::get('search/customer-vehicle', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
            ->name('search.customer-vehicle');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-info/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerInfo'])
            ->name('customer-info');
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        Route::get('vehicle-info/{vehicle}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'vehicleInfo'])
            ->name('vehicle-info');
        
        // –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        Route::get('customer-vehicles/{customer}', [\App\Http\Controllers\Admin\WorkOrderController::class, 'customerVehicles'])
            ->name('customer-vehicles');
        
        // Autocomplete –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏ –∏ —É—Å–ª—É–≥–∏
        Route::get('products/autocomplete', [\App\Http\Controllers\Admin\WorkOrderController::class, 'productsAutocomplete'])
            ->name('products.autocomplete');
    });

    /* --- –°—Ç–∞—Ä AJAX endpoint (—Ç—Ä—è–±–≤–∞ –¥–∞ –≥–æ –ø—Ä–µ–∏–º–µ–Ω—É–≤–∞–º–µ –∏–ª–∏ –ø—Ä–µ–º–∞—Ö–Ω–µ–º) --- */
    Route::get('api/customer-vehicles-legacy/{customer}', function (\App\Models\Customer $customer) {
        return $customer->vehicles()->select('id', 'plate', 'make', 'model')->get();
    })->name('api.customer-vehicles.legacy');

    /* --- PDF --- */
    Route::get('work-orders/{workOrder}/pdf', [\App\Http\Controllers\Admin\WorkOrderController::class, 'pdf'])
        ->name('work-orders.pdf');
        
    /* --- –¢—ä—Ä—Å–µ–Ω–µ –∑–∞ Work Orders (–∑–∞ –æ–±—Ä–∞—Ç–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç) --- */
    Route::get('work-orders/search', [\App\Http\Controllers\Admin\WorkOrderController::class, 'search'])
        ->name('work-orders.search');
});

require __DIR__ . '/auth.php';
2. app/Http\Controllers/Admin\WorkOrderController.php (–æ–±–Ω–æ–≤–µ–Ω)
php
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Customer;
use App\Models\User;
use App\Models\Vehicle;
use App\Models\WorkOrder;
use App\Models\WorkOrderItem;
use App\Models\StockMovement;
use App\Models\Product;
use App\Models\Service;
use Barryvdh\DomPDF\Facade\Pdf;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;

class WorkOrderController extends Controller
{
    public function index()
    {
        $workOrders = WorkOrder::with(['customer', 'vehicle', 'mechanic'])->paginate(25);
        return view('admin.work-orders.index', compact('workOrders'));
    }

    public function create()
    {
        $customers = Customer::pluck('name', 'id');
        $vehicles = collect();
        $mechanics = User::role('mechanic')->pluck('name', 'id');
        $products = Product::select('id', 'sku', 'name', 'price', 'vat_percent')
            ->orderBy('name')
            ->get();
        $services = Service::active()->select('id', 'code', 'name', 'price', 'vat_percent', 'duration_minutes')
            ->orderBy('name')
            ->get();
        
        return view('admin.work-orders.create', compact('customers', 'vehicles', 'mechanics', 'products', 'services'));
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'customer_id'   => 'required|exists:customers,id',
            'vehicle_id'    => 'nullable|exists:vehicles,id',
            'status'        => 'required|in:draft,open,in_progress,completed,invoiced,closed,cancelled',
            'received_at'   => 'nullable|date',
            'km_on_receive' => 'nullable|integer|min:0',
            'assigned_to'   => 'nullable|exists:users,id',
            'notes'         => 'nullable|string',
            'items'         => 'required|array|min:1',
            'items.*.description' => 'required|string',
            'items.*.quantity'    => 'required|numeric|min:0.01',
            'items.*.unit_price'  => 'required|numeric|min:0',
            'items.*.vat_percent' => 'required|numeric|min:0|max:100',
            'items.*.item_type'   => 'required|in:product,service',
        ]);

        $order = DB::transaction(function () use ($validated, $request) {
            $userId = Auth::check() ? Auth::user()->id : 0;

            $order = WorkOrder::create([
                'number'        => 'WO-' . str_pad(WorkOrder::count() + 1, 6, '0', STR_PAD_LEFT),
                'customer_id'   => $validated['customer_id'],
                'vehicle_id'    => $validated['vehicle_id'] ?? null,
                'status'        => $validated['status'],
                'received_at'   => $validated['received_at'] ?? now(),
                'km_on_receive' => $validated['km_on_receive'],
                'assigned_to'   => $validated['assigned_to'],
                'notes'         => $validated['notes'],
                'created_by'    => $userId,
            ]);

            $totalWithout = 0;
            foreach ($request->items as $row) {
                $qty   = $row['quantity'];
                $price = $row['unit_price'];
                $vat   = $row['vat_percent'];
                $line  = $qty * $price;
                $vatAm = $line * $vat / 100;

                $itemData = [
                    'work_order_id'           => $order->id,
                    'description'             => $row['description'],
                    'quantity'                => $qty,
                    'unit_price'              => $price,
                    'vat_percent'             => $vat,
                    'line_total_without_vat'  => $line,
                    'line_vat_amount'         => $vatAm,
                    'line_total'              => $line + $vatAm,
                ];

                // –†–∞–∑–ø–æ–∑–Ω–∞–≤–∞–Ω–µ –Ω–∞ —Ç–∏–ø–∞ –Ω–∞ –∞—Ä—Ç–∏–∫—É–ª–∞ (–ø—Ä–æ–¥—É–∫—Ç –∏–ª–∏ —É—Å–ª—É–≥–∞)
                if (isset($row['product_id']) && $row['product_id']) {
                    $productId = $row['product_id'];
                    if (strpos($productId, 'product_') === 0) {
                        // –¢–æ–≤–∞ –µ –ø—Ä–æ–¥—É–∫—Ç
                        $itemData['product_id'] = str_replace('product_', '', $productId);
                        $itemData['service_id'] = null;
                        
                        // –°–∫–ª–∞–¥–æ–≤–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç —Å–∞–º–æ –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏
                        StockMovement::create([
                            'product_id'     => $itemData['product_id'],
                            'change'         => -$qty,
                            'type'           => 'reservation',
                            'reference_id'   => $order->id,
                            'reference_type' => WorkOrder::class,
                            'created_by'     => $userId,
                        ]);
                    } elseif (strpos($productId, 'service_') === 0) {
                        // –¢–æ–≤–∞ –µ —É—Å–ª—É–≥–∞
                        $itemData['service_id'] = str_replace('service_', '', $productId);
                        $itemData['product_id'] = null;
                    }
                }

                WorkOrderItem::create($itemData);
                $totalWithout += $line;
            }

            $order->update([
                'total_without_vat' => $totalWithout,
                'vat_amount'        => $order->items()->sum('line_vat_amount'),
                'total'             => $order->items()->sum('line_total'),
            ]);

            return $order;
        });

        return redirect()->route('admin.work-orders.show', $order)->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞.');
    }

    public function show(WorkOrder $workOrder)
    {
        $workOrder->load(['items.product', 'items.service', 'customer', 'vehicle', 'mechanic']);
        return view('admin.work-orders.show', compact('workOrder'));
    }

    public function edit(WorkOrder $workOrder)
    {
        $customers = Customer::pluck('name', 'id');
        $vehicles  = Vehicle::where('customer_id', $workOrder->customer_id)->pluck('plate', 'id');
        $mechanics = User::role('mechanic')->pluck('name', 'id');
        $products = Product::select('id', 'sku', 'name', 'price', 'vat_percent')
            ->orderBy('name')
            ->get();
        $services = Service::active()->select('id', 'code', 'name', 'price', 'vat_percent', 'duration_minutes')
            ->orderBy('name')
            ->get();
            
        return view('admin.work-orders.edit', compact('workOrder', 'customers', 'vehicles', 'mechanics', 'products', 'services'));
    }

    public function update(Request $request, WorkOrder $workOrder)
    {
        $validated = $request->validate([
            'customer_id'   => 'required|exists:customers,id',
            'vehicle_id'    => 'nullable|exists:vehicles,id',
            'status'        => 'required|in:draft,open,in_progress,completed,invoiced,closed,cancelled',
            'received_at'   => 'nullable|date',
            'km_on_receive' => 'nullable|integer|min:0',
            'assigned_to'   => 'nullable|exists:users,id',
            'notes'         => 'nullable|string',
        ]);

        $workOrder->update($validated);

        return redirect()->route('admin.work-orders.index')->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞.');
    }

    public function destroy(WorkOrder $workOrder)
    {
        $workOrder->items()->delete();
        $workOrder->delete();
        return redirect()->route('admin.work-orders.index')->with('success', '–ü–æ—Ä—ä—á–∫–∞—Ç–∞ –µ –∏–∑—Ç—Ä–∏—Ç–∞.');
    }

    public function pdf(\App\Models\WorkOrder $workOrder, Request $request)
    {
        $invoice = $workOrder->invoices()->first();
        if (! $invoice) {
            $userId = Auth::check() ? Auth::user()->id : 0;

            $invoice = \App\Models\Invoice::create([
                'number'        => 'INV-' . str_pad(\App\Models\Invoice::count() + 1, 6, '0', STR_PAD_LEFT),
                'work_order_id' => $workOrder->id,
                'customer_id'   => $workOrder->customer_id,
                'issue_date'    => now(),
                'due_date'      => now()->addDays(14),
                'subtotal'      => $workOrder->total_without_vat,
                'vat_total'     => $workOrder->vat_amount,
                'grand_total'   => $workOrder->total,
                'status'        => 'draft',
                'created_by'    => $userId,
            ]);

            foreach ($workOrder->items as $item) {
                $invoice->items()->create([
                    'product_id'  => $item->product_id,
                    'service_id'  => $item->service_id,
                    'description' => $item->description,
                    'quantity'    => $item->quantity,
                    'unit_price'  => $item->unit_price,
                    'vat_percent' => $item->vat_percent,
                    'line_total'  => $item->line_total,
                ]);
            }
        }

        $copy = $request->get('copy', 0);
        return Pdf::loadView('admin.invoices.pdf', compact('invoice', 'copy'))
                  ->stream('invoice_' . $invoice->number . '.pdf');
    }

    /**
     * –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏ –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞ autocomplete
     */
    public function search(Request $request)
    {
        $query = $request->get('q');
        
        if (!$query || strlen($query) < 2) {
            return response()->json([
                'customers' => [],
                'vehicles' => []
            ]);
        }

        $results = [
            'customers' => Customer::where('name', 'like', "%{$query}%")
                ->orWhere('phone', 'like', "%{$query}%")
                ->orWhere('email', 'like', "%{$query}%")
                ->withCount('vehicles')
                ->limit(10)
                ->get()
                ->map(function ($customer) {
                    return [
                        'id' => $customer->id,
                        'name' => $customer->name,
                        'phone' => $customer->phone,
                        'email' => $customer->email,
                        'vehicles_count' => $customer->vehicles_count,
                        'address' => $customer->address,
                    ];
                }),
                
            'vehicles' => Vehicle::where('plate', 'like', "%{$query}%")
                ->orWhere('vin', 'like', "%{$query}%")
                ->orWhere('make', 'like', "%{$query}%")
                ->orWhere('model', 'like', "%{$query}%")
                ->with('customer')
                ->limit(10)
                ->get()
                ->map(function ($vehicle) {
                    return [
                        'id' => $vehicle->id,
                        'plate' => $vehicle->plate,
                        'make' => $vehicle->make,
                        'model' => $vehicle->model,
                        'year' => $vehicle->year,
                        'engine' => $vehicle->engine,
                        'vin' => $vehicle->vin,
                        'current_mileage' => $vehicle->current_mileage,
                        'customer_id' => $vehicle->customer_id,
                        'customer' => $vehicle->customer ? [
                            'id' => $vehicle->customer->id,
                            'name' => $vehicle->customer->name,
                            'phone' => $vehicle->customer->phone,
                            'email' => $vehicle->customer->email,
                        ] : null,
                    ];
                })
        ];
        
        return response()->json($results);
    }

    /**
     * –í—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
     */
    public function customerInfo($id)
    {
        $customer = Customer::findOrFail($id);
        return response()->json([
            'id' => $customer->id,
            'name' => $customer->name,
            'phone' => $customer->phone,
            'email' => $customer->email,
            'address' => $customer->address,
            'created_at' => $customer->created_at->format('d.m.Y'),
        ]);
    }

    /**
     * –í—Ä—ä—â–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
     */
    public function vehicleInfo($id)
    {
        $vehicle = Vehicle::with('customer')->findOrFail($id);
        return response()->json([
            'id' => $vehicle->id,
            'plate' => $vehicle->plate,
            'make' => $vehicle->make,
            'model' => $vehicle->model,
            'year' => $vehicle->year,
            'engine' => $vehicle->engine,
            'vin' => $vehicle->vin,
            'color' => $vehicle->color,
            'current_mileage' => $vehicle->current_mileage,
            'customer_id' => $vehicle->customer_id,
            'customer' => $vehicle->customer ? [
                'id' => $vehicle->customer->id,
                'name' => $vehicle->customer->name,
                'phone' => $vehicle->customer->phone,
                'email' => $vehicle->customer->email,
            ] : null,
        ]);
    }

    /**
     * –í—Ä—ä—â–∞ –≤—Å–∏—á–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
     */
    public function customerVehicles($id)
    {
        $vehicles = Vehicle::where('customer_id', $id)
            ->get()
            ->map(function ($vehicle) {
                return [
                    'id' => $vehicle->id,
                    'plate' => $vehicle->plate,
                    'make' => $vehicle->make,
                    'model' => $vehicle->model,
                    'year' => $vehicle->year,
                    'engine' => $vehicle->engine,
                    'current_mileage' => $vehicle->current_mileage,
                    'full_text' => $vehicle->plate . ' - ' . $vehicle->make . ' ' . $vehicle->model . ($vehicle->year ? ' (' . $vehicle->year . ')' : ''),
                ];
            });
            
        return response()->json($vehicles);
    }

    /**
     * –í—Ä—ä—â–∞ –≤—Å–∏—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –∏ —É—Å–ª—É–≥–∏ –∑–∞ autocomplete
     */
    public function productsAutocomplete(Request $request)
    {
        $query = $request->get('q');
        $type = $request->get('type', 'all'); // all, product, service
        
        $results = [];
        
        if ($type === 'all' || $type === 'product') {
            $products = Product::query();
            
            if ($query) {
                $products->where(function ($q) use ($query) {
                    $q->where('sku', 'like', "%{$query}%")
                      ->orWhere('name', 'like', "%{$query}%")
                      ->orWhere('description', 'like', "%{$query}%");
                });
            }
            
            $products = $products->select('id', 'sku', 'name', 'price', 'vat_percent')
                ->orderBy('name')
                ->limit(10)
                ->get()
                ->map(function ($product) {
                    return [
                        'id' => 'product_' . $product->id,
                        'sku' => $product->sku,
                        'name' => $product->name,
                        'price' => $product->price,
                        'vat_percent' => $product->vat_percent,
                        'type' => 'product',
                        'full_text' => $product->sku . ' - ' . $product->name . ' (' . number_format($product->price, 2) . ' –ª–≤.)',
                    ];
                });
            
            $results = array_merge($results, $products->toArray());
        }
        
        if ($type === 'all' || $type === 'service') {
            $services = Service::active()->query();
            
            if ($query) {
                $services->where(function ($q) use ($query) {
                    $q->where('code', 'like', "%{$query}%")
                      ->orWhere('name', 'like', "%{$query}%")
                      ->orWhere('description', 'like', "%{$query}%");
                });
            }
            
            $services = $services->select('id', 'code', 'name', 'price', 'vat_percent', 'duration_minutes')
                ->orderBy('name')
                ->limit(10)
                ->get()
                ->map(function ($service) {
                    return [
                        'id' => 'service_' . $service->id,
                        'sku' => $service->code,
                        'name' => $service->name,
                        'price' => $service->price,
                        'vat_percent' => $service->vat_percent,
                        'type' => 'service',
                        'duration' => $service->duration_minutes,
                        'full_text' => $service->code . ' - ' . $service->name . ' (' . number_format($service->price, 2) . ' –ª–≤.)',
                    ];
                });
            
            $results = array_merge($results, $services->toArray());
        }
        
        return response()->json($results);
    }
}
3. resources/views/admin/work-orders/create.blade.php (–ø—ä–ª–Ω–æ –æ–±–Ω–æ–≤–µ–Ω —Å —É—Å–ª—É–≥–∏)
blade
@extends('adminlte::page')

@section('title', '–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="text-primary"><i class="fas fa-file-invoice mr-2"></i>–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞</h1>
        <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left mr-1"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
@stop

@section('content')
    <div class="card border-primary">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-search mr-2"></i>–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ</h4>
        </div>
        <div class="card-body bg-light">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label class="font-weight-bold">–ë—ä—Ä–∑–æ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª:</label>
                        <div class="input-group input-group-sm">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-primary"></i>
                                </span>
                            </div>
                            <input type="text" id="globalSearch" class="form-control form-control-sm" 
                                   placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º–µ–π–ª –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä...">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="searchResults" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto;">
                            <!-- –†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ —â–µ —Å–µ –ø–æ—è–≤—è—Ç —Ç—É–∫ -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <div class="alert alert-info w-100 mb-0 py-2">
                        <small class="d-block">
                            <i class="fas fa-info-circle mr-1"></i>
                            –¢—ä—Ä—Å–µ—Ç–µ –ø–æ: <strong>–∏–º–µ</strong>, <strong>—Ç–µ–ª–µ—Ñ–æ–Ω</strong>, 
                            <strong>–∏–º–µ–π–ª</strong> –∏–ª–∏ <strong>—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä</strong>.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-success mt-3">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="fas fa-user-circle mr-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</h4>
        </div>
        <div class="card-body">
            <form action="{{ route('admin.work-orders.store') }}" method="POST" id="orderForm">
                @csrf
                
                {{-- –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è --}}
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-primary">–ö–ª–∏–µ–Ω—Ç <span class="text-danger">*</span></label>
                            <select name="customer_id" id="customer_id" class="form-control form-control-sm select2" 
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç" required>
                                <option value=""></option>
                                @foreach($customers as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <div id="customerInfo" class="mt-1 p-2 bg-light rounded" style="display: none;">
                                <small class="text-muted">
                                    <i class="fas fa-user text-primary mr-1"></i>
                                    <span id="customerName"></span><br>
                                    <i class="fas fa-phone text-primary mr-1"></i>
                                    <span id="customerPhone"></span><br>
                                    <i class="fas fa-envelope text-primary mr-1"></i>
                                    <span id="customerEmail"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-primary">–ê–≤—Ç–æ–º–æ–±–∏–ª <span class="text-danger">*</span></label>
                            <select name="vehicle_id" id="vehicle_id" class="form-control form-control-sm select2" required
                                    data-placeholder="–ò–∑–±–µ—Ä–µ—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª">
                                <option value=""></option>
                            </select>
                            <div id="vehicleInfo" class="mt-1 p-2 bg-light rounded" style="display: none;">
                                <small class="text-muted">
                                    <i class="fas fa-car text-primary mr-1"></i>
                                    <span id="vehicleMakeModel"></span><br>
                                    <i class="fas fa-hashtag text-primary mr-1"></i>
                                    –†–µ–≥. –Ω–æ–º–µ—Ä: <span id="vehiclePlate"></span><br>
                                    <i class="fas fa-calendar text-primary mr-1"></i>
                                    –ì–æ–¥–∏–Ω–∞: <span id="vehicleYear"></span><br>
                                    <i class="fas fa-gas-pump text-primary mr-1"></i>
                                    –î–≤–∏–≥–∞—Ç–µ–ª: <span id="vehicleEngine"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold text-primary">–ú–µ—Ö–∞–Ω–∏–∫</label>
                            <select name="assigned_to" class="form-control form-control-sm select2">
                                <option value=""></option>
                                @foreach($mechanics as $id => $name)
                                    <option value="{{ $id }}">{{ $name }}</option>
                                @endforeach
                            </select>
                            <small class="form-text text-muted">–ù–µ–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ</small>
                        </div>
                    </div>
                </div>

                {{-- –î–µ—Ç–∞–π–ª–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞ --}}
                <div class="card border-warning mt-3">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0 text-dark"><i class="fas fa-clipboard-list mr-2"></i>–î–µ—Ç–∞–π–ª–∏ –Ω–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–°—Ç–∞—Ç—É—Å <span class="text-danger">*</span></label>
                                    <select name="status" class="form-control form-control-sm" required>
                                        <option value="draft">üìù –ß–µ—Ä–Ω–æ–≤–∞</option>
                                        <option value="open" selected>üîì –û—Ç–≤–æ—Ä–µ–Ω–∞</option>
                                        <option value="in_progress">‚öôÔ∏è –í –ø—Ä–æ–≥—Ä–µ—Å</option>
                                        <option value="completed">‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω–∞</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞–Ω–µ</label>
                                    <div class="input-group input-group-sm">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="datetime-local" name="received_at" class="form-control" 
                                               value="{{ now()->format('Y-m-d\TH:i') }}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–ü—Ä–æ–±–µ–≥ (km)</label>
                                    <div class="input-group input-group-sm">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-tachometer-alt text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="number" name="km_on_receive" class="form-control" 
                                               min="0" placeholder="0" id="vehicleMileage">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="font-weight-bold text-dark">–û—á–∞–∫–≤–∞–Ω–∞ –¥–∞—Ç–∞</label>
                                    <div class="input-group input-group-sm">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar-check text-warning"></i>
                                            </span>
                                        </div>
                                        <input type="date" name="estimated_completion" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-2">
                            <label class="font-weight-bold text-dark">
                                <i class="fas fa-sticky-note mr-1"></i>–ë–µ–ª–µ–∂–∫–∏
                            </label>
                            <textarea name="notes" class="form-control form-control-sm" rows="2" 
                                      placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –±–µ–ª–µ–∂–∫–∏ –∑–∞ –ø–æ—Ä—ä—á–∫–∞—Ç–∞..."></textarea>
                        </div>
                    </div>
                </div>

                {{-- –î–∏–Ω–∞–º–∏—á–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ --}}
                <div class="card border-info mt-3">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-list-alt mr-2"></i>–ü–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ—Ä—ä—á–∫–∞—Ç–∞
                            <span class="badge badge-light ml-2" id="itemsCount">0 –ø–æ–∑–∏—Ü–∏–∏</span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-bordered" id="itemsTable">
                                <thead class="bg-light">
                                    <tr>
                                        <th width="5%">‚Ññ</th>
                                        <th width="25%">–ü—Ä–æ–¥—É–∫—Ç/–£—Å–ª—É–≥–∞</th>
                                        <th width="25%">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        <th width="10%">–ö–æ–ª-–≤–æ</th>
                                        <th width="10%">–¶–µ–Ω–∞ –±–µ–∑ –î–î–°</th>
                                        <th width="10%">–î–î–° %</th>
                                        <th width="10%">–û–±—â–æ</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot class="bg-light">
                                    <tr>
                                        <td colspan="7" class="text-right font-weight-bold">–û–±—â–æ –ø–æ–∑–∏—Ü–∏–∏:</td>
                                        <td class="font-weight-bold" id="itemsCountFooter">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <button type="button" id="addProductRow" class="btn btn-success btn-sm">
                                <i class="fas fa-box mr-1"></i> –î–æ–±–∞–≤–∏ –ø—Ä–æ–¥—É–∫—Ç
                            </button>
                            <button type="button" id="addServiceRow" class="btn btn-primary btn-sm">
                                <i class="fas fa-tools mr-1"></i> –î–æ–±–∞–≤–∏ —É—Å–ª—É–≥–∞
                            </button>
                            <button type="button" id="addQuickService" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-bolt mr-1"></i> –ë—ä—Ä–∑–∞ —É—Å–ª—É–≥–∞
                            </button>
                        </div>
                    </div>
                </div>

                {{-- –°—É–º–∏ --}}
                <div class="row mt-3">
                    <div class="col-md-5 offset-md-7">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white py-1">
                                <h5 class="mb-0"><i class="fas fa-calculator mr-2"></i>–û–±—â–æ —Å—É–º–∏</h5>
                            </div>
                            <div class="card-body py-2">
                                <table class="table table-sm table-borderless mb-0">
                                    <tr>
                                        <th class="text-right py-1">–û–±—â–æ –±–µ–∑ –î–î–°:</th>
                                        <td class="text-right py-1">
                                            <span class="font-weight-bold text-primary" id="totalWithoutVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="text-right py-1">–î–î–°:</th>
                                        <td class="text-right py-1">
                                            <span class="font-weight-bold text-warning" id="totalVat">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                    <tr class="border-top">
                                        <th class="text-right py-1 font-weight-bold">–û–±—â–æ —Å –î–î–°:</th>
                                        <td class="text-right py-1">
                                            <span class="h5 font-weight-bold text-success" id="grandTotal">0.00</span> –ª–≤.
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                {{-- –ë—É—Ç–æ–Ω–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ --}}
                <div class="mt-3 d-flex justify-content-end gap-2">
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="fas fa-save mr-1"></i> –ó–∞–ø–∞–∑–∏ –ø–æ—Ä—ä—á–∫–∞
                    </button>
                    <button type="submit" name="action" value="save_and_print" class="btn btn-primary btn-sm">
                        <i class="fas fa-print mr-1"></i> –ó–∞–ø–∞–∑–∏ –∏ –æ—Ç–ø–µ—á–∞—Ç–∞–π
                    </button>
                    <a href="{{ route('admin.work-orders.index') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times mr-1"></i> –û—Ç–∫–∞–∑
                    </a>
                </div>
            </form>
        </div>
    </div>
@stop

@push('css')
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    <style>
        /* –ü–æ-–º–∞–ª–∫–∏ Select2 –∫–æ–Ω—Ç—Ä–æ–ª–∏ */
        .select2-container--bootstrap .select2-selection {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            height: calc(1.5em + 0.5rem + 2px);
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .select2-container--bootstrap .select2-selection--single .select2-selection__rendered {
            line-height: calc(1.5em + 0.5rem);
            padding-left: 0.375rem;
        }
        
        .select2-container--bootstrap .select2-selection:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .select2-container--bootstrap .select2-selection__arrow {
            height: calc(1.5em + 0.5rem);
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ —Ñ–æ—Ä–º–∏ */
        .form-control, .form-control-sm {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            height: calc(1.5em + 0.5rem + 2px);
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ –∫–∞—Ä—Ç–æ–Ω–∏ */
        .card {
            margin-bottom: 1rem;
        }
        
        .card-header {
            border-radius: 0.25rem 0.25rem 0 0 !important;
            padding: 0.5rem 0.75rem;
            font-size: 0.95rem;
        }
        
        .card-body {
            padding: 0.75rem;
        }
        
        /* –ü–æ-–º–∞–ª–∫–∞ —Ç–∞–±–ª–∏—Ü–∞ */
        .table-sm {
            font-size: 0.85rem;
        }
        
        .table-sm th,
        .table-sm td {
            padding: 0.3rem;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ –±—É—Ç–æ–Ω–∏ */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            line-height: 1.5;
            border-radius: 0.2rem;
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ –∏–Ω–ø—É—Ç –≥—Ä—É–ø–∏ */
        .input-group-sm > .form-control,
        .input-group-sm > .input-group-prepend > .input-group-text,
        .input-group-sm > .input-group-append > .input-group-text {
            height: calc(1.5em + 0.5rem + 2px);
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .input-group-text {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            font-size: 0.875rem;
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ badge */
        .badge {
            font-size: 0.7em;
            padding: 0.25em 0.5em;
        }
        
        /* –ê–≤—Ç–æ–¥–æ–ø—ä–ª–≤–∞–Ω–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ */
        .list-group-item {
            padding: 0.375rem 0.75rem;
            font-size: 0.85rem;
        }
        
        .list-group-item:hover {
            background-color: #007bff !important;
            color: white !important;
            cursor: pointer;
        }
        
        .list-group-item .customer-badge {
            font-size: 0.7em;
        }
        
        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        
        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∏ –ø–∞–Ω–µ–ª–∏ */
        #customerInfo, #vehicleInfo {
            border-left: 3px solid #007bff;
            padding: 0.5rem;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        /* –†–∞–∑—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ä–µ–¥–æ–≤–µ—Ç–µ */
        .row {
            margin-bottom: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 0.75rem;
        }
        
        /* –°—Ç–∏–ª–æ–≤–µ –∑–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ —Ç–∏–ø–æ–≤–µ —Ä–µ–¥–æ–≤–µ */
        .product-row {
            background-color: rgba(40, 167, 69, 0.05);
        }
        
        .service-row {
            background-color: rgba(23, 162, 184, 0.05);
        }
        
        .quick-service-row {
            background-color: rgba(255, 193, 7, 0.05);
        }
        
        /* AdminLTE –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è */
        .card.border-primary .card-header {
            background: linear-gradient(45deg, #007bff, #6610f2);
        }
        
        .card.border-success .card-header {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .card.border-warning .card-header {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }
        
        .card.border-info .card-header {
            background: linear-gradient(45deg, #17a2b8, #20c997);
        }
        
        /* –ü–æ-–º–∞–ª–∫–∏ –∏–∫–æ–Ω–∫–∏ */
        .fas, .fa {
            font-size: 0.9em;
        }
    </style>
@endpush

@push('js')
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/bg.js"></script>
    <script>
        $(function () {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $('.select2').select2({
                theme: 'bootstrap',
                language: 'bg',
                width: '100%',
                allowClear: true
            });

            // –ì–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
            let searchTimeout;
            $('#globalSearch').on('input', function() {
                clearTimeout(searchTimeout);
                const query = $(this).val().trim();
                
                if (query.length < 2) {
                    $('#searchResults').hide().empty();
                    return;
                }
                
                searchTimeout = setTimeout(function() {
                    performGlobalSearch(query);
                }, 300);
            });

            // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#clearSearch').click(function() {
                $('#globalSearch').val('');
                $('#searchResults').hide().empty();
            });

            // –ó–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –ø—Ä–∏ –∫–ª–∏–∫ –∏–∑–≤—ä–Ω —Ç—è—Ö
            $(document).click(function(e) {
                if (!$(e.target).closest('#globalSearch, #searchResults').length) {
                    $('#searchResults').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∫–ª–∏–µ–Ω—Ç
            $('#customer_id').change(function () {
                const customerId = $(this).val();
                loadCustomerVehicles(customerId);
                
                // –ê–∫–æ –∏–º–∞ –∏–∑–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç, –ø–æ–∫–∞–∂–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –º—É
                if (customerId) {
                    loadCustomerInfo(customerId);
                } else {
                    $('#customerInfo').hide();
                }
            });

            // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–±–æ—Ä –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
            $('#vehicle_id').change(function () {
                const vehicleId = $(this).val();
                if (vehicleId) {
                    loadVehicleInfo(vehicleId);
                } else {
                    $('#vehicleInfo').hide();
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –≥–ª–æ–±–∞–ª–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
        function performGlobalSearch(query) {
            $.ajax({
                url: "/admin/api/search/customer-vehicle",
                method: 'GET',
                data: { q: query },
                beforeSend: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border spinner-border-sm text-primary mr-2"></div>
                                <span>–¢—ä—Ä—Å–µ–Ω–µ...</span>
                            </div>
                        </div>
                    `).show();
                },
                success: function(data) {
                    if (data.customers.length === 0 && data.vehicles.length === 0) {
                        $('#searchResults').html(`
                            <div class="list-group-item text-muted">
                                <i class="fas fa-search mr-2"></i>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
                            </div>
                        `).show();
                        return;
                    }

                    let html = '';
                    
                    // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
                    if (data.customers && data.customers.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ö–ª–∏–µ–Ω—Ç–∏</div>`;
                        data.customers.forEach(customer => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="customer" 
                                     data-id="${customer.id}"
                                     data-name="${customer.name}"
                                     data-phone="${customer.phone || ''}"
                                     data-email="${customer.email || ''}"
                                     data-address="${customer.address || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-user text-primary mr-2"></i>
                                            <strong>${highlightText(customer.name, query)}</strong>
                                        </div>
                                        <span class="badge badge-primary customer-badge">–ö–ª–∏–µ–Ω—Ç</span>
                                    </div>
                                    ${customer.phone ? `<small class="text-muted d-block mt-1"><i class="fas fa-phone mr-1"></i>${highlightText(customer.phone, query)}</small>` : ''}
                                    ${customer.email ? `<small class="text-muted d-block"><i class="fas fa-envelope mr-1"></i>${highlightText(customer.email, query)}</small>` : ''}
                                    <small class="text-muted d-block">${customer.vehicles_count || 0} –∞–≤—Ç–æ–º–æ–±–∏–ª–∞</small>
                                </div>
                            `;
                        });
                    }

                    if (data.vehicles && data.vehicles.length > 0) {
                        html += `<div class="list-group-item list-group-item-secondary font-weight-bold">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>`;
                        data.vehicles.forEach(vehicle => {
                            html += `
                                <div class="list-group-item list-group-item-action" 
                                     data-type="vehicle" 
                                     data-id="${vehicle.id}"
                                     data-customer-id="${vehicle.customer_id}"
                                     data-plate="${vehicle.plate}"
                                     data-make="${vehicle.make || ''}"
                                     data-model="${vehicle.model || ''}"
                                     data-year="${vehicle.year || ''}"
                                     data-engine="${vehicle.engine || ''}"
                                     data-vin="${vehicle.vin || ''}"
                                     data-mileage="${vehicle.current_mileage || ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-car text-success mr-2"></i>
                                            <strong>${highlightText(vehicle.plate, query)}</strong>
                                        </div>
                                        <span class="badge badge-success customer-badge">–ê–≤—Ç–æ–º–æ–±–∏–ª</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        ${vehicle.make || ''} ${vehicle.model || ''} ${vehicle.year ? `(${vehicle.year})` : ''}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-user mr-1"></i>${vehicle.customer?.name || '–ù—è–º–∞ –∫–ª–∏–µ–Ω—Ç'}
                                    </small>
                                </div>
                            `;
                        });
                    }

                    $('#searchResults').html(html).show();
                    
                    // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ event listener –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç
                    $('.list-group-item[data-type]').click(function() {
                        selectSearchResult($(this));
                    });
                },
                error: function() {
                    $('#searchResults').html(`
                        <div class="list-group-item text-danger">
                            <i class="fas fa-exclamation-circle mr-2"></i>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
                        </div>
                    `).show();
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ—Å–≤–µ—Ç—è–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ
        function highlightText(text, query) {
            if (!query || !text) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.toString().replace(regex, '<span class="search-highlight">$1</span>');
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç –æ—Ç —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
        function selectSearchResult($element) {
            const type = $element.data('type');
            
            if (type === 'customer') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
                $('#customer_id').val($element.data('id')).trigger('change');
                $('#customerInfo').html(`
                    <small class="text-muted">
                        <i class="fas fa-user text-primary mr-1"></i>
                        <strong>${$element.data('name')}</strong><br>
                        ${$element.data('phone') ? `<i class="fas fa-phone text-primary mr-1"></i>${$element.data('phone')}<br>` : ''}
                        ${$element.data('email') ? `<i class="fas fa-envelope text-primary mr-1"></i>${$element.data('email')}` : ''}
                    </small>
                `).show();
                
                // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                loadCustomerVehicles($element.data('id'));
                
            } else if (type === 'vehicle') {
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª –∏ –Ω–µ–≥–æ–≤–∏—è –∫–ª–∏–µ–Ω—Ç
                $('#vehicle_id').val($element.data('id')).trigger('change');
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∞
                $('#vehicleInfo').html(`
                    <small class="text-muted">
                        <i class="fas fa-car text-primary mr-1"></i>
                        <strong>${$element.data('make')} ${$element.data('model')}</strong><br>
                        <i class="fas fa-hashtag text-primary mr-1"></i>
                        –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${$element.data('plate')}</strong><br>
                        ${$element.data('year') ? `<i class="fas fa-calendar text-primary mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${$element.data('year')}<br>` : ''}
                        ${$element.data('engine') ? `<i class="fas fa-gas-pump text-primary mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${$element.data('engine')}<br>` : ''}
                        ${$element.data('mileage') ? `<i class="fas fa-tachometer-alt text-primary mr-1"></i>–ü—Ä–æ–±–µ–≥: ${$element.data('mileage')} –∫–º` : ''}
                    </small>
                `).show();
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞
                if ($element.data('mileage')) {
                    $('#vehicleMileage').val($element.data('mileage'));
                }
                
                // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
                if ($element.data('customerId')) {
                    $('#customer_id').val($element.data('customerId')).trigger('change');
                }
            }
            
            // –°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –∏ –∏–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ
            $('#searchResults').hide().empty();
            $('#globalSearch').val('');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏—Ç–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerVehicles(customerId) {
            if (!customerId) {
                $('#vehicle_id').html('<option value=""></option>').prop('disabled', true).trigger('change');
                return;
            }
            
            $('#vehicle_id').html('<option value="">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</option>').prop('disabled', true);
            
            $.get("/admin/api/customer-vehicles/" + customerId, function (data) {
                let html = '<option value=""></option>';
                if (data.length > 0) {
                    $.each(data, function (i, v) {
                        html += `<option value="${v.id}">${v.plate} - ${v.make} ${v.model} (${v.year || '?'})</option>`;
                    });
                } else {
                    html = '<option value="">–ù—è–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏</option>';
                }
                $('#vehicle_id').html(html).prop('disabled', false).trigger('change');
            }).fail(function() {
                $('#vehicle_id').html('<option value="">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</option>').prop('disabled', false);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–ª–∏–µ–Ω—Ç
        function loadCustomerInfo(customerId) {
            $.get("/admin/api/customer-info/" + customerId, function (data) {
                if (data) {
                    $('#customerInfo').html(`
                        <small class="text-muted">
                            <i class="fas fa-user text-primary mr-1"></i>
                            <strong>${data.name}</strong><br>
                            ${data.phone ? `<i class="fas fa-phone text-primary mr-1"></i>${data.phone}<br>` : ''}
                            ${data.email ? `<i class="fas fa-envelope text-primary mr-1"></i>${data.email}<br>` : ''}
                            ${data.address ? `<i class="fas fa-map-marker-alt text-primary mr-1"></i>${data.address}` : ''}
                        </small>
                    `).show();
                }
            }).fail(function() {
                $('#customerInfo').hide();
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª
        function loadVehicleInfo(vehicleId) {
            $.get("/admin/api/vehicle-info/" + vehicleId, function (data) {
                if (data) {
                    $('#vehicleInfo').html(`
                        <small class="text-muted">
                            <i class="fas fa-car text-primary mr-1"></i>
                            <strong>${data.make} ${data.model}</strong><br>
                            <i class="fas fa-hashtag text-primary mr-1"></i>
                            –†–µ–≥. –Ω–æ–º–µ—Ä: <strong>${data.plate}</strong><br>
                            ${data.year ? `<i class="fas fa-calendar text-primary mr-1"></i>–ì–æ–¥–∏–Ω–∞: ${data.year}<br>` : ''}
                            ${data.engine ? `<i class="fas fa-gas-pump text-primary mr-1"></i>–î–≤–∏–≥–∞—Ç–µ–ª: ${data.engine}<br>` : ''}
                            ${data.vin ? `<i class="fas fa-barcode text-primary mr-1"></i>VIN: ${data.vin}<br>` : ''}
                            ${data.current_mileage ? `<i class="fas fa-tachometer-alt text-primary mr-1"></i>–ü—Ä–æ–±–µ–≥: ${data.current_mileage} –∫–º` : ''}
                        </small>
                    `).show();
                    
                    // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–±–µ–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–∞
                    if (data.current_mileage) {
                        $('#vehicleMileage').val(data.current_mileage);
                    }
                }
            }).fail(function() {
                $('#vehicleInfo').hide();
            });
        }

        // =============== –§—É–Ω–∫—Ü–∏–∏ –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ ===============
        let rowIdx = 0;

        function calcLine(row) {
            const qty   = parseFloat(row.find('.qty').val()) || 0;
            const price = parseFloat(row.find('.price').val()) || 0;
            const vat   = parseFloat(row.find('.vat').val()) || 0;
            const line  = qty * price;
            const vatAm = line * vat / 100;
            row.find('.lineTotal').text((line + vatAm).toFixed(2));
            calcTotals();
            updateItemsCount();
        }

        function calcTotals() {
            let totalWithout = 0, totalVat = 0;
            $('#itemsTable tbody tr').each(function () {
                const qty   = parseFloat($(this).find('.qty').val()) || 0;
                const price = parseFloat($(this).find('.price').val()) || 0;
                const vat   = parseFloat($(this).find('.vat').val()) || 0;
                const line  = qty * price;
                totalWithout += line;
                totalVat     += line * vat / 100;
            });
            $('#totalWithoutVat').text(totalWithout.toFixed(2));
            $('#totalVat').text(totalVat.toFixed(2));
            $('#grandTotal').text((totalWithout + totalVat).toFixed(2));
        }

        function updateItemsCount() {
            const count = $('#itemsTable tbody tr').length;
            $('#itemsCount').text(count + ' –ø–æ–∑–∏—Ü–∏–∏');
            $('#itemsCountFooter').text(count);
        }

        function addRow(rowType = 'product', predefinedItem = null) {
            rowIdx++;
            const isService = rowType === 'service';
            const isQuickService = rowType === 'quick_service';
            const rowClass = isService ? 'service-row' : (isQuickService ? 'quick-service-row' : 'product-row');
            
            let productOptions = '<option value=""></option>';
            let placeholder = '–ò–∑–±–µ—Ä–µ—Ç–µ –ø—Ä–æ–¥—É–∫—Ç';
            
            if (isService || isQuickService) {
                // –î–æ–±–∞–≤–∏ —É—Å–ª—É–≥–∏
                placeholder = '–ò–∑–±–µ—Ä–µ—Ç–µ —É—Å–ª—É–≥–∞';
                @if(isset($services) && $services->count())
                    @foreach($services as $service)
                        productOptions += `
                            <option value="service_{{ $service->id }}" 
                                    data-price="{{ $service->price }}" 
                                    data-vat="{{ $service->vat_percent }}"
                                    data-type="service">
                                {{ $service->code }} - {{ $service->name }}
                            </option>`;
                    @endforeach
                @endif
            } else {
                // –î–æ–±–∞–≤–∏ –ø—Ä–æ–¥—É–∫—Ç–∏
                @if(isset($products) && $products->count())
                    @foreach($products as $product)
                        productOptions += `
                            <option value="product_{{ $product->id }}" 
                                    data-price="{{ $product->price }}" 
                                    data-vat="{{ $product->vat_percent }}"
                                    data-type="product">
                                {{ $product->sku }} - {{ $product->name }}
                            </option>`;
                    @endforeach
                @endif
            }

            const html = `
                <tr id="R${rowIdx}" class="${rowClass}">
                    <td class="align-middle">${rowIdx}</td>
                    <td>
                        <select name="items[${rowIdx}][product_id]" class="form-control form-control-sm product-select" 
                                style="width:100%" data-row-type="${rowType}">
                            ${productOptions}
                        </select>
                        <input type="hidden" name="items[${rowIdx}][item_type]" value="${isService || isQuickService ? 'service' : 'product'}">
                    </td>
                    <td>
                        <input type="text" name="items[${rowIdx}][description]" 
                               class="form-control form-control-sm" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][quantity]" 
                               class="form-control form-control-sm qty" min="0.01" step="0.01" value="1" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][unit_price]" 
                               class="form-control form-control-sm price" min="0.01" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" name="items[${rowIdx}][vat_percent]" 
                               class="form-control form-control-sm vat" min="0" max="100" step="0.01" value="20" required>
                    </td>
                    <td class="align-middle lineTotal font-weight-bold">0.00</td>
                    <td class="align-middle">
                        <button type="button" class="btn btn-sm btn-danger removeRow" title="–ü—Ä–µ–º–∞—Ö–Ω–∏">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            
            $('#itemsTable tbody').append(html);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Select2
            $(`#R${rowIdx} .product-select`).select2({
                theme: 'bootstrap',
                language: 'bg',
                placeholder: placeholder,
                allowClear: true,
                width: '100%'
            });
            
            // –ê–∫–æ –∏–º–∞ predefined –µ–ª–µ–º–µ–Ω—Ç, –∏–∑–±–µ—Ä–∏ –≥–æ
            if (predefinedItem) {
                $(`#R${rowIdx} .product-select`).val(predefinedItem.id).trigger('change');
                $(`#R${rowIdx} .price`).val(predefinedItem.price);
                $(`#R${rowIdx} .vat`).val(predefinedItem.vat_percent || 20);
                $(`#R${rowIdx} input[name*="description"]`).val(predefinedItem.name);
                calcLine($(`#R${rowIdx}`));
            }
            
            updateItemsCount();
        }

        // Event Listeners –∑–∞ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
        $(document)
            .on('click', '#addProductRow', () => addRow('product'))
            .on('click', '#addServiceRow', () => addRow('service'))
            .on('click', '#addQuickService', () => {
                addRow('service', {
                    id: 'quick_service',
                    name: '–ë—ä—Ä–∑ —Ä–µ–º–æ–Ω—Ç',
                    price: 50,
                    vat_percent: 20
                });
            })
            .on('click', '.removeRow', function () {
                $(this).closest('tr').remove();
                calcTotals();
                updateItemsCount();
                renumberRows();
            })
            .on('change keyup', '.qty, .price, .vat', function () {
                calcLine($(this).closest('tr'));
            })
            .on('change', '.product-select', function () {
                const option = $(this).find(':selected');
                const row = $(this).closest('tr');
                const price = option.data('price');
                const vat = option.data('vat');
                const type = option.data('type');
                
                if (price) row.find('.price').val(price);
                if (vat) row.find('.vat').val(vat);
                
                if (option.text() && !row.find('input[name*="description"]').val()) {
                    row.find('input[name*="description"]').val(option.text().split(' - ')[1] || option.text());
                }
                
                // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Ç–∏–ø–∞ –Ω–∞ –∞—Ä—Ç–∏–∫—É–ª–∞
                row.find('input[name*="item_type"]').val(type);
                
                calcLine(row);
            });

        // –ü—Ä–µ–Ω–æ–º–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ–¥–æ–≤–µ —Å–ª–µ–¥ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ
        function renumberRows() {
            $('#itemsTable tbody tr').each(function(index) {
                $(this).find('td:first').text(index + 1);
                $(this).attr('id', 'R' + (index + 1));
                // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –∏–º–µ–Ω–∞—Ç–∞ –Ω–∞ –ø–æ–ª–µ—Ç–∞—Ç–∞
                $(this).find('[name*="items"]').each(function() {
                    const name = $(this).attr('name');
                    $(this).attr('name', name.replace(/items\[\d+\]/, `items[${index + 1}]`));
                });
            });
            rowIdx = $('#itemsTable tbody tr').length;
        }

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –ø—ä—Ä–≤–∏ —Ä–µ–¥ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
        $(document).ready(function() {
            addRow('product');
        });
    </script>
@endpush
–°–µ–≥–∞ –∏–º–∞—à –ø—ä–ª–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —É—Å–ª—É–≥–∏ –≤ —Å–∏—Å—Ç–µ–º–∞—Ç–∞! –í—Å–∏—á–∫–æ –µ –≥–æ—Ç–æ–≤–æ –∑–∞ —Ä–∞–±–æ—Ç–∞.


